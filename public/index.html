<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Ujian Pro (Node.js Version)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 8px; height: 8px; }
        .scroller::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
       /* Update class .rich-editor agar tidak melebar ke samping (untuk tipe soal lain) */
        /* --- UPDATE CSS INI --- */
        .rich-editor {
            /* Ukuran */
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;  /* Scroll Vertikal: YES */
            overflow-x: hidden !important; /* Scroll Horizontal: NO/HARAM */

            /* KUNCI LEBAR MATI */
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box;
            display: block;

            /* MEMAKSA TEKS TURUN (WRAP) */
            white-space: pre-wrap !important;
            word-break: break-all !important;  /* PATAHKAN SEMUA KATA YANG KEPANJANGAN */
            overflow-wrap: break-word !important; 

            /* Kosmetik */
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: white;
            line-height: 1.6;
            outline: none;
        }

        .rich-editor img {
            max-width: 100% !important;
            height: auto;
        }
        .rich-editor:focus { outline: 2px solid #3b82f6; border-color: transparent; }
        .rich-editor:empty::before { content: "\200b"; }
        
        .exam-content img, .rich-editor img {
            max-width: 100%; height: auto; border-radius: 4px; float: left; 
            margin-right: 15px; margin-bottom: 5px; margin-top: 5px; border: 1px solid #e5e7eb;
        }
        .exam-content::after, .rich-editor::after { content: ""; clear: both; display: table; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .kecermatan-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .kecermatan-box { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem; text-align: center; background: white; }
        .kecermatan-char { font-size: 1.5rem; font-weight: bold; color: #1e293b; }
        .kecermatan-label { font-size: 0.75rem; color: #64748b; font-weight: bold; border-top: 1px solid #f1f5f9; margin-top: 4px; padding-top: 2px; }

        /* CHART CSS (Gabungan Main & Review) */
        .chart-wrapper { 
            position: relative; width: 100%; height: 420px; /* DIPERBESAR AGAR PROPORSIONAL */
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; 
            padding: 15px; box-sizing: border-box; 
            overflow: visible; 
            z-index: 10;
        }
        .chart-svg { width: 100%; height: 100%; overflow: visible; }
        
        .grid-line { stroke: #f1f5f9; stroke-width: 1; }
        .axis-text { font-size: 10px; fill: #94a3b8; font-weight: 600; }
        .bar-correct { fill: #22c55e; transition: height 0.3s; }
        .bar-wrong { fill: #ef4444; transition: height 0.3s; }
        .line-answered { fill: none; stroke: #3b82f6; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .dot-answered { fill: #fff; stroke: #3b82f6; stroke-width: 2; }
        .hit-area { fill: transparent; cursor: pointer; }
        .tooltip-box { pointer-events: none; opacity: 0; transition: opacity 0.15s ease; }
        .bar-group:hover .tooltip-box { opacity: 1; }

        /* Style untuk Toolbar Editor */
        .editor-wrapper {
            width: 100%;
            min-width: 0; /* Hack flexbox agar anak element bisa mengecil */
        }

        .editor-toolbar {
            background: #f1f5f9;
            padding: 8px;
            border-bottom: 1px solid #cbd5e1;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .editor-toolbar button, .editor-toolbar select {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            font-weight: bold;
            color: #475569;
        }

        .editor-toolbar button:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .editor-toolbar .separator {
            width: 1px;
            height: 20px;
            background: #cbd5e1;
            margin: 0 4px;
        }

        /* Editor Area agar mirip kertas Word */
        .rich-editor {
            min-height: 120px;
            padding: 15px;
            outline: none;
            line-height: 1.6;
        }

        /* Style khusus Gambar di dalam editor */
        .rich-editor img {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .rich-editor img:hover, .rich-editor img.active-img {
            border: 2px dashed #3b82f6; /* Garis putus-putus biru saat dipilih */
            resize: both; /* Fitur resize native browser (jika support) */
        }
        /* --- SECURITY CSS (Anti Cheat) --- */
        @media print {
            body { display: none !important; }
        }

        /* Cegah seleksi teks bagi user */
        .user-secure {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
    </style>
</head>
<body class="text-slate-800 bg-gray-100 min-h-screen flex flex-col">

<div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-[100]">
    <div class="text-center animate-bounce"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-600"></i><p class="mt-4 font-bold text-gray-600">Memuat Sistem...</p></div>
</div>

<div id="app" v-cloak class="flex flex-col flex-grow h-screen overflow-hidden">

    <div v-if="!isLoggedIn" class="fixed inset-0 bg-gradient-to-br from-slate-800 to-gray-900 flex items-center justify-center px-4 fade-in z-50">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-blue-500">
            <div class="text-center mb-10">
                <i class="fas fa-graduation-cap text-6xl text-blue-600 mb-4 drop-shadow-sm"></i>
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">SISTEM UJIAN PRO</h1>
                <p class="text-sm text-gray-500 mt-2 font-medium">Portal Ujian Terpadu</p>
            </div>
            <div class="space-y-6">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Username / Email</label><input v-model="loginForm.user" @keyup.enter="handleLogin" type="text" class="w-full border px-4 py-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Masukkan ID Pengguna"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Password</label><input v-model="loginForm.pass" @keyup.enter="handleLogin" type="password" class="w-full border px-4 py-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Kata Sandi"></div>
                <button @click="handleLogin" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg hover:shadow-xl transition transform active:scale-95">MASUK SISTEM</button>
            </div>
            <div class="mt-8 text-center text-xs text-gray-400 bg-gray-50 p-2 rounded">Copyright © 2025 by CIBN. All Rights Reserved.</div>
        </div>
    </div>
    <div v-if="showExportModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden relative">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-print mr-2"></i> Export Data Ujian</h3>
                <button @click="showExportModal=false" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 p-3 rounded border border-blue-100 text-sm">
                    <div><strong>Peserta:</strong> {{ selectedExportUser?.username }}</div>
                    <div><strong>Modul:</strong> {{ selectedExportResult?.moduleName }}</div>
                    <div><strong>Skor:</strong> {{ selectedExportResult ? calculateTotalScore(selectedExportResult) : 0 }}</div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">1. Format File</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="exportFormat='word'" :class="exportFormat==='word' ? 'bg-blue-600 text-white ring-2 ring-blue-300' : 'bg-white border text-gray-600 hover:bg-gray-50'" class="p-3 rounded-lg font-bold border flex items-center justify-center transition">
                            <i class="fas fa-file-word mr-2 text-xl"></i> Microsoft Word
                        </button>
                        <button @click="exportFormat='excel'" :class="exportFormat==='excel' ? 'bg-green-600 text-white ring-2 ring-green-300' : 'bg-white border text-gray-600 hover:bg-gray-50'" class="p-3 rounded-lg font-bold border flex items-center justify-center transition">
                            <i class="fas fa-file-excel mr-2 text-xl"></i> Microsoft Excel
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">2. Cakupan Data (Scope)</label>
                    <select v-model="exportScope" class="w-full border p-2 rounded text-sm font-bold bg-gray-50">
                        <option value="full">Full Modul (Semua Subtes)</option>
                        <option value="per_sub">Pilih Sub Tes Tertentu...</option>
                    </select>
                </div>

                <div v-if="exportScope === 'per_sub'" class="animate-pulse-once">
                    <select v-model="exportSelectedSubId" class="w-full border p-2 rounded text-sm mt-2">
                        <option v-for="sub in selectedExportResult?.subResults" :key="sub.subId" :value="sub.subId">
                            {{ sub.subName }} (Skor: {{ sub.score }})
                        </option>
                    </select>
                </div>

                <button @click="processExport" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow-lg mt-4">
                    <i class="fas fa-download mr-2"></i> DOWNLOAD FILE
                </button>
            </div>
        </div>
    </div>

    <div v-if="isLoggedIn && currentRole === 'admin'" class="flex flex-col h-full bg-gray-100">
        <nav class="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-40 shrink-0 border-b border-slate-700">
            <div class="container-fluid px-6 flex justify-between items-center">
                <h1 class="text-lg font-bold tracking-wider flex items-center text-blue-400">
                    <i class="fas fa-user-shield mr-3 text-xl"></i> PANEL ADMIN
                </h1>
                <div class="flex items-center space-x-6">
                    <div class="text-right hidden md:block">
                        <div class="text-sm font-bold text-gray-200">{{ currentUser.username }}</div>
                        <div class="text-xs text-gray-400 uppercase tracking-widest">Administrator</div>
                    </div>
                    <button @click="handleLogout" class="text-xs bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold transition shadow border border-red-500 flex items-center">
                        <i class="fas fa-power-off mr-2"></i> Keluar
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-grow overflow-hidden relative p-4 lg:p-6">
            <div class="h-full flex flex-col space-y-4 fade-in">
                <div class="flex space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-200 overflow-x-auto shrink-0 scroller">
                    <button v-for="(tab, key) in {'sub': '1. Manajemen Sub Tes', 'modul': '2. Modul', 'paket': '3. Paket Ujian', 'hasil': '4. Log Hasil', 'akun': '5. Data Akun'}" 
                            @click="adminTab = key" 
                            :class="adminTab===key ? 'bg-slate-800 text-white shadow-md' : 'bg-gray-50 text-gray-600 hover:bg-gray-200'"
                            class="px-5 py-2.5 rounded-md font-bold whitespace-nowrap transition text-sm flex items-center">
                            <i class="fas mr-2" :class="{'fa-database': key=='bank', 'fa-list-ol': key=='sub', 'fa-book': key=='modul', 'fa-box-open': key=='paket', 'fa-poll': key=='hasil', 'fa-users-cog': key=='akun'}"></i>{{ tab }}
                    </button>
                </div>

                <div class="flex-grow overflow-hidden bg-white rounded-lg shadow-md border border-gray-300 relative">
                    
                    <div v-if="adminTab === 'sub'" class="h-full flex flex-col overflow-hidden bg-white">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-lg text-slate-700">
                                <i class="fas fa-edit mr-2 text-blue-600"></i>
                                {{ isEditingSub ? 'Edit Sub Tes: ' + newSub.nameInternal : 'Buat Sub Tes Baru' }}
                            </h3>
                            <div class="flex gap-2">
                                <button v-if="isEditingSub" @click="cancelEditSub" class="bg-gray-400 text-white px-4 py-1 rounded text-sm hover:bg-gray-500">Batal Edit</button>
                                <button @click="saveSubTest" class="bg-blue-700 text-white px-6 py-1 rounded text-sm font-bold shadow-md hover:bg-blue-800 transition">
                                    <i class="fas fa-save mr-2"></i>SIMPAN SUB TES
                                </button>
                            </div>
                        </div>

                        <div class="flex-grow flex overflow-hidden">
                            
                            <div class="w-1/4 border-r p-4 space-y-4 overflow-y-auto scroller bg-slate-50">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Informasi Sub Tes</label>
                                    <input v-model="newSub.nameInternal" placeholder="Kode (Misal: MAT-01)" class="w-full border p-2 mt-1 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <input v-model="newSub.nameDisplay" placeholder="Judul Tampilan (Misal: Matematika)" class="w-full border p-2 mt-2 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Durasi (Detik)</label>
                                        <input v-model.number="newSub.duration" type="number" class="w-full border p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Navigasi</label>
                                        <select v-model="newSub.navType" class="w-full border p-2 rounded text-sm font-bold bg-white">
                                            <option value="flexible">Bebas (Normal)</option>
                                            <option value="linear">Terkunci (Linear)</option>
                                            <option value="missing_numbers">Kecermatan</option>
                                        </select>
                                    </div>
                                </div>

                                <div v-if="newSub.navType !== 'missing_numbers'">
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Metode Penilaian</label>
                                    <select v-model="newSub.type" class="w-full border p-2 rounded text-sm bg-white">
                                        <option value="normal">Benar/Salah (Normal)</option>
                                        <option value="weighted">Poin Per Opsi (Weighted)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex-grow min-w-0 p-4 overflow-y-auto scroller bg-white">                                
                                <div v-if="newSub.navType !== 'missing_numbers'" class="space-y-6">
                                    
                                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="text-xs font-bold text-blue-800 uppercase tracking-tight">Manajemen Kelompok Soal</h4>
                                            <span class="text-[9px] text-blue-500 italic">*Gunakan jika ingin ada breakdown nilai 8/10</span>
                                        </div>
                                        <div class="flex gap-2 mb-3">
                                            <input v-model="tempGroupName" placeholder="Nama Kelompok (Contoh: Aljabar)" class="flex-grow border p-2 rounded text-sm">
                                            <button @click="addSubGroup" class="bg-blue-600 text-white px-4 rounded text-sm font-bold hover:bg-blue-700">+ Tambah</button>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            <div @click="activeInternalGroupIdx = -1" 
                                                :class="activeInternalGroupIdx === -1 ? 'bg-slate-700 text-white' : 'bg-white text-slate-600'"
                                                class="px-3 py-1 rounded-full border border-slate-300 text-[10px] font-bold cursor-pointer transition">
                                                Default (Tanpa Kelompok)
                                            </div>
                                            <div v-for="(grp, gIdx) in newSub.internalGroups" :key="gIdx" 
                                                @click="activeInternalGroupIdx = gIdx"
                                                :class="activeInternalGroupIdx === gIdx ? 'bg-blue-600 text-white' : 'bg-white text-blue-600'"
                                                class="px-3 py-1 rounded-full border border-blue-600 text-[10px] font-bold cursor-pointer flex items-center gap-2 transition">
                                                {{ grp.name }}
                                                <i @click.stop="removeSubGroup(gIdx)" class="fas fa-times-circle hover:text-red-400"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center border-b pb-2">
                                            <h4 class="font-bold text-slate-700 text-sm">Input Pertanyaan</h4>
                                            <div class="flex gap-2">
                                                <label class="cursor-pointer bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-green-700 flex items-center shadow-sm">
                                                    <i class="fas fa-file-excel mr-1"></i> IMPORT EXCEL
                                                    <input type="file" hidden accept=".xlsx, .xls" @change="handleExcelUpload">
                                                </label>
                                                <label class="cursor-pointer bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-blue-700 flex items-center shadow-sm">
                                                    <i class="fas fa-file-word mr-1"></i> IMPORT WORD
                                                    <input type="file" hidden accept=".docx" @change="handleWordUpload">
                                                </label>
                                                <button @click="triggerUpload('q')" class="text-slate-600 text-[10px] font-bold border border-slate-300 px-2 py-1 rounded hover:bg-slate-50">
                                                    <i class="fas fa-image mr-1"></i> SISIPKAN GAMBAR
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="editor-wrapper w-[1px] min-w-full max-w-full">
                                            <div class="editor-toolbar">
                                                <select onchange="document.execCommand('fontName',false,this.value)" class="w-24">
                                                    <option value="Arial">Arial</option>
                                                    <option value="Times New Roman">Times New Roman</option>
                                                    <option value="Courier New">Courier</option>
                                                    <option value="Georgia">Georgia</option>
                                                    <option value="Verdana">Verdana</option>
                                                </select>
                                                <select onchange="document.execCommand('fontSize',false,this.value)" class="w-16">
                                                    <option value="3">Normal</option>
                                                    <option value="1">Kecil</option>
                                                    <option value="5">Besar</option>
                                                    <option value="7">Jumbo</option>
                                                </select>
                                                
                                                <div class="separator"></div>

                                                <button @click="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                                                <button @click="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                                                <button @click="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
                                                <button @click="execCmd('strikeThrough')" title="Coret"><i class="fas fa-strikethrough"></i></button>

                                                <div class="separator"></div>

                                                <button @click="execCmd('justifyLeft')" title="Rata Kiri"><i class="fas fa-align-left"></i></button>
                                                <button @click="execCmd('justifyCenter')" title="Rata Tengah"><i class="fas fa-align-center"></i></button>
                                                <button @click="execCmd('justifyRight')" title="Rata Kanan"><i class="fas fa-align-right"></i></button>
                                                <button @click="execCmd('justifyFull')" title="Justify"><i class="fas fa-align-justify"></i></button>

                                                <div class="separator"></div>

                                                <button @click="triggerUpload('editor-q')" title="Upload Gambar" class="text-blue-600"><i class="fas fa-image"></i></button>
                                                
                                                <div v-if="activeImg" class="flex gap-1 ml-2 bg-blue-50 px-2 rounded border border-blue-200">
                                                    <span class="text-[10px] font-bold py-1 text-blue-800">IMG:</span>
                                                    <button @click="setImageSize(25)">25%</button>
                                                    <button @click="setImageSize(50)">50%</button>
                                                    <button @click="setImageSize(100)">100%</button>
                                                    <div class="separator"></div>
                                                    <button @click="setImageAlign('left')" title="Kiri (Wrap)"><i class="fas fa-indent"></i></button>
                                                    <button @click="setImageAlign('none')" title="Tengah (Block)"><i class="fas fa-align-justify"></i></button>
                                                    <button @click="setImageAlign('right')" title="Kanan (Wrap)"><i class="fas fa-outdent"></i></button>
                                                </div>
                                            </div>

                                            <div id="editor-q" 
                                                class="rich-editor" 
                                                contenteditable="true" 
                                                @input="updateQ" 
                                                @click="handleEditorClick"
                                                placeholder="Ketik soal di sini...">
                                            </div>
                                        </div>
                                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                            <label class="text-[10px] font-bold text-slate-500 block mb-3 uppercase">Opsi Jawaban & Kunci</label>
                                            <div v-for="(opt, oIdx) in tempOptions" :key="oIdx" class="flex gap-3 mb-4 items-start">
                                                <div class="w-8 h-8 shrink-0 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold text-xs shadow-sm">{{ String.fromCharCode(65+oIdx) }}</div>
                                                
                                                <div class="flex-grow editor-wrapper mb-0 min-w-0 w-0 max-w-full">
                                                    <div class="editor-toolbar py-1 bg-gray-50">
                                                        <button @click="execCmd('bold')" class="py-0 px-2 text-[10px]"><i class="fas fa-bold"></i></button>
                                                        <button @click="execCmd('italic')" class="py-0 px-2 text-[10px]"><i class="fas fa-italic"></i></button>
                                                        <button @click="execCmd('superscript')" class="py-0 px-2 text-[10px]">X²</button>
                                                        <button @click="triggerUpload('editor-opt-'+oIdx)" class="py-0 px-2 text-[10px] text-blue-600"><i class="fas fa-image"></i></button>
                                                    </div>
                                                    <div :id="'editor-opt-'+oIdx" class="rich-editor" style="min-height: 50px; padding: 10px;" contenteditable="true" @input="updateOpt(oIdx, $event)"></div>
                                                </div>
                                                
                                                <div class="flex flex-col gap-2 pt-2 w-24 shrink-0">
                                                    <button @click="tempOptions.splice(oIdx,1)" class="text-red-400 hover:text-red-600 text-right mb-1"><i class="fas fa-trash"></i></button>
                                                    
                                                    <div v-if="newSub.type === 'normal'" class="bg-green-50 p-2 rounded border border-green-200 text-center">
                                                        <label class="cursor-pointer flex flex-col items-center gap-1">
                                                            <input type="checkbox" v-model="opt.isCorrect" class="w-5 h-5 accent-green-600">
                                                            <span class="text-[9px] font-bold text-green-700 uppercase">Kunci Benar</span>
                                                        </label>
                                                    </div>

                                                    <div v-else class="bg-blue-50 p-2 rounded border border-blue-200 text-center">
                                                        <span class="text-[9px] font-bold text-blue-700 uppercase block mb-1">Bobot Nilai</span>
                                                        <input type="number" v-model.number="opt.weight" class="w-full border text-center text-sm font-bold p-1 rounded focus:border-blue-500 outline-none" placeholder="0">
                                                    </div>
                                                </div>
                                            </div>
                                            <button @click="tempOptions.push({text:'', isCorrect:false, weight:0})" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-400 rounded-lg text-xs font-bold hover:bg-white hover:text-blue-600 transition">+ TAMBAH OPSI JAWABAN ({{ String.fromCharCode(65+tempOptions.length) }})</button>
                                        </div>
                                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                            <label class="text-[10px] font-bold text-yellow-700 block mb-2 uppercase"><i class="fas fa-lightbulb mr-1"></i> Pembahasan (Muncul setelah ujian selesai)</label>
                                            <div class="editor-wrapper bg-white rounded border border-yellow-300">
                                                <div class="editor-toolbar">
                                                    <select onchange="document.execCommand('fontName',false,this.value)" class="w-24">
                                                        <option value="Arial">Arial</option>
                                                        <option value="Times New Roman">Times New Roman</option>
                                                        <option value="Courier New">Courier</option>
                                                        <option value="Georgia">Georgia</option>
                                                        <option value="Verdana">Verdana</option>
                                                    </select>
                                                    <select onchange="document.execCommand('fontSize',false,this.value)" class="w-16">
                                                        <option value="3">Normal</option>
                                                        <option value="1">Kecil</option>
                                                        <option value="5">Besar</option>
                                                        <option value="7">Jumbo</option>
                                                    </select>
                                                    
                                                    <div class="separator"></div>

                                                    <button @click="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                                                    <button @click="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                                                    <button @click="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
                                                    <button @click="execCmd('strikeThrough')" title="Coret"><i class="fas fa-strikethrough"></i></button>

                                                    <div class="separator"></div>

                                                    <button @click="execCmd('justifyLeft')" title="Rata Kiri"><i class="fas fa-align-left"></i></button>
                                                    <button @click="execCmd('justifyCenter')" title="Rata Tengah"><i class="fas fa-align-center"></i></button>
                                                    <button @click="execCmd('justifyRight')" title="Rata Kanan"><i class="fas fa-align-right"></i></button>
                                                    <button @click="execCmd('justifyFull')" title="Justify"><i class="fas fa-align-justify"></i></button>

                                                    <div class="separator"></div>

                                                    <button @click="triggerUpload('editor-q')" title="Upload Gambar" class="text-blue-600"><i class="fas fa-image"></i></button>
                                                    
                                                    <div v-if="activeImg" class="flex gap-1 ml-2 bg-blue-50 px-2 rounded border border-blue-200">
                                                        <span class="text-[10px] font-bold py-1 text-blue-800">IMG:</span>
                                                        <button @click="setImageSize(25)">25%</button>
                                                        <button @click="setImageSize(50)">50%</button>
                                                        <button @click="setImageSize(100)">100%</button>
                                                        <div class="separator"></div>
                                                        <button @click="setImageAlign('left')" title="Kiri (Wrap)"><i class="fas fa-indent"></i></button>
                                                        <button @click="setImageAlign('none')" title="Tengah (Block)"><i class="fas fa-align-justify"></i></button>
                                                        <button @click="setImageAlign('right')" title="Kanan (Wrap)"><i class="fas fa-outdent"></i></button>
                                                    </div>
                                                </div>
                                                <div id="editor-exp" 
                                                    class="rich-editor" 
                                                    contenteditable="true" 
                                                    @input="updateExp" 
                                                    style="min-height: 80px;"
                                                    placeholder="Tulis pembahasan di sini...">
                                                </div>
                                            </div>
                                        </div>                                        
                                        <div class="pt-4">
                                            <button @click="addQuestionToSub" class="w-full py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95" 
                                                :class="isEditingQ ? 'bg-amber-500 text-white hover:bg-amber-600':'bg-slate-800 text-white hover:bg-slate-900'">
                                                {{ isEditingQ ? 'PERBARUI BUTIR SOAL' : 'SIMPAN KE DAFTAR SOAL' }}
                                            </button>
                                            <button v-if="isEditingQ" @click="resetQEditor" class="w-full text-xs text-slate-400 mt-2 hover:text-red-500 underline">Batalkan Perubahan Soal</button>
                                        </div>
                                    </div>
                                </div>

                                <div v-else class="flex flex-col h-full bg-slate-50">
                                    <div class="bg-slate-800 text-white p-3 border-b font-bold text-sm flex justify-between items-center shadow-md">
                                        <span><i class="fas fa-border-all mr-2 text-green-400"></i> EDITOR DAFTAR KOLOM (Kecermatan)</span>
                                        <span class="text-[10px] bg-slate-700 px-2 py-1 rounded border border-slate-600">10 Kolom Otomatis</span>
                                    </div>
                                    <div class="flex-grow flex overflow-hidden">
                                        <div class="w-1/3 border-r bg-white overflow-y-auto scroller">
                                            <div v-for="colId in 10" :key="colId" 
                                                 @click="activeMissingCol = colId"
                                                 class="p-4 border-b cursor-pointer transition flex justify-between items-center hover:bg-blue-50"
                                                 :class="activeMissingCol === colId ? 'bg-blue-100 border-l-4 border-l-blue-600 text-blue-900 font-bold' : 'text-gray-600 border-l-4 border-l-transparent'">
                                                <span>KOLOM {{ colId }}</span>
                                                <span class="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600">{{ getMissingQuestionCount(colId) }} Soal</span>
                                            </div>
                                        </div>
                                        <div class="w-2/3 p-6 flex flex-col h-full overflow-y-auto scroller">
                                            <div class="mb-4 flex justify-between items-center">
                                                <h4 class="font-bold text-lg text-slate-800">Edit Kolom {{ activeMissingCol }}</h4>
                                                <button @click="clearMissingCol(activeMissingCol)" class="text-xs text-red-500 hover:underline"><i class="fas fa-trash"></i> Reset Kolom (Hapus Semua)</button>
                                            </div>
                                            
                                            <div class="bg-white p-5 rounded-xl border shadow-sm mb-6">
                                                <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Input 5 Karakter/Simbol (A - E)</label>
                                                <div class="grid grid-cols-5 gap-3">
                                                    <div v-for="(val, idx) in getCurrentColInputs()" :key="idx" class="text-center">
                                                        <input v-model="tempMissingInputs[idx]" maxlength="3" class="w-full border-2 border-slate-200 rounded-lg p-2 text-center font-bold text-lg focus:border-blue-500 outline-none" :placeholder="String.fromCharCode(65+idx)">
                                                        <div class="text-[10px] font-bold text-gray-400 mt-1">{{ String.fromCharCode(65+idx) }}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 mb-6">
                                                <div class="flex items-end gap-4">
                                                    <div class="flex-grow">
                                                        <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Jumlah Generate</label>
                                                        <input type="number" v-model.number="genCount" min="1" max="1000" class="w-full border p-2 rounded text-sm text-center font-bold">
                                                    </div>
                                                    <button @click="generateMissingQuestions" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md transition h-[38px]"><i class="fas fa-plus-circle mr-2"></i> GENERATE (TAMBAH)</button>
                                                </div>
                                                <p class="text-[10px] text-blue-600 mt-2 italic">*Generate akan MENAMBAH soal ke dalam daftar yang sudah ada (tidak menimpa).</p>
                                            </div>

                                            <div class="flex-grow">
                                                <h5 class="font-bold text-xs text-gray-500 uppercase mb-2">Preview Soal ({{ getMissingQuestionCount(activeMissingCol) }})</h5>
                                                <div class="bg-white border rounded-lg overflow-hidden">
                                                    <div v-if="getMissingQuestionCount(activeMissingCol) === 0" class="p-6 text-center text-gray-400 text-xs italic">Belum ada soal digenerate.</div>
                                                    <table v-else class="w-full text-xs text-left">
                                                        <thead class="bg-gray-100 text-gray-600"><tr><th class="p-2 w-10 text-center">No</th><th class="p-2">Soal (4 Karakter)</th><th class="p-2 text-center">Hilang</th><th class="p-2 text-center">Jawaban</th></tr></thead>
                                                        <tbody class="divide-y">
                                                            <tr v-for="(q, i) in getQuestionsForCol(activeMissingCol)" :key="i">
                                                                <td class="p-2 text-center font-bold text-gray-500">{{ i+1 }}</td>
                                                                <td class="p-2 font-mono text-base tracking-widest font-bold">{{ q.text }}</td>
                                                                <td class="p-2 text-center font-bold text-red-500 bg-red-50">{{ q.missingChar }}</td>
                                                                <td class="p-2 text-center font-bold text-white bg-green-500 rounded">{{ q.correctLabel }}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="newSub.navType !== 'missing_numbers'" class="w-1/4 border-l p-4 flex flex-col bg-slate-50 overflow-hidden">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3 flex justify-between">
                                    Review Soal 
                                    <span class="text-blue-600">{{ currentViewQuestions.length }} Butir</span>
                                </h4>
                                <div class="flex-grow overflow-y-auto scroller space-y-3">    
                                    <div v-for="(q, qIdx) in currentViewQuestions" :key="qIdx" 
                                    @click="editQInSub(qIdx)"
                                    class="relative p-3 rounded-lg border transition cursor-pointer group mb-3"
                                    :class="[
                                        (isEditingQ && editingQIdx === qIdx) ? 'bg-amber-50 border-amber-400 ring-1 ring-amber-400' : '',
                                        !checkQuestionKey(q) ? 'bg-red-50 border-red-300' : 'bg-white border-slate-200 hover:border-blue-400 hover:shadow-md'
                                    ]">
                                    
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex gap-2 items-center">
                                            <span class="text-[10px] font-extrabold px-2 py-0.5 rounded transition"
                                                :class="(isEditingQ && editingQIdx === qIdx) ? 'bg-amber-200 text-amber-800' : 'bg-blue-50 text-blue-600'">
                                                SOAL #{{ qIdx+1 }}
                                            </span>
                                            
                                            <span v-if="!checkQuestionKey(q)" class="bg-red-600 text-white px-2 py-0.5 rounded text-[9px] font-bold shadow-sm animate-pulse">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>NO KEY
                                            </span>
                                        </div>
                                        
                                        <button @click.stop="deleteQInSub(qIdx)" class="text-slate-300 hover:text-red-500 transition z-10" title="Hapus Soal">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </div>

                                    <div class="text-[11px] leading-relaxed text-slate-600 line-clamp-3 overflow-hidden pointer-events-none" v-html="q.text"></div>
                                    
                                    <div v-if="isEditingQ && editingQIdx === qIdx" class="mt-2 text-[9px] font-bold text-amber-600 uppercase flex items-center justify-end">
                                        <i class="fas fa-pen-nib mr-1"></i> Sedang Diedit
                                    </div>
                                    
                                    <div v-else class="mt-2 text-[9px] text-slate-400 italic text-right opacity-0 group-hover:opacity-100 transition">
                                        Klik box untuk edit
                                    </div>
                                </div>

                                    <div v-if="currentViewQuestions.length === 0" class="flex flex-col items-center justify-center h-40 text-slate-400">
                                        <i class="fas fa-layer-group text-2xl mb-2 opacity-20"></i>
                                        <p class="text-[10px] italic">Belum ada soal terinput</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="h-44 border-t bg-slate-100 p-4 shrink-0 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center">
                                    <i class="fas fa-list-ul mr-2"></i> Database Sub Tes Terdaftar
                                </h4>
                            </div>
                            <div class="flex gap-4 overflow-x-auto scroller pb-2 flex-nowrap">
                                <div v-for="sub in subTests" :key="sub.id" 
                                    @click="editSub(sub)"
                                    :class="editingSubId === sub.id ? 'border-blue-600 bg-blue-50 ring-2 ring-blue-200' : 'border-slate-200 bg-white hover:border-blue-400'"
                                    class="min-w-[240px] border-2 p-3 rounded-xl cursor-pointer transition shadow-sm relative group shrink-0">
                                    <div class="flex justify-between items-start">
                                        <div class="font-bold text-xs text-slate-800 truncate pr-4">{{ sub.nameInternal }}</div>
                                        <button @click.stop="deleteSub(sub.id)" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times-circle"></i></button>
                                    </div>
                                    <div class="text-[9px] text-slate-400 font-bold mt-1 uppercase">{{ sub.navType }} • {{ sub.type }}</div>
                                    <div class="flex justify-between items-center mt-3">
                                        <span class="text-[10px] font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded">{{ countTotalSoal(sub) }} SOAL</span>
                                        <span class="text-[9px] text-slate-400 italic">Klik untuk edit</span>
                                    </div>
                                </div>
                                
                                <div v-if="subTests.length === 0" class="w-full text-center py-6 text-slate-400 text-xs italic">
                                    Belum ada data sub tes. Silahkan buat baru di atas.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="adminTab === 'modul'" class="h-full flex flex-col p-6 overflow-hidden">
                        <div class="flex justify-between mb-4 pb-2 border-b shrink-0">
                            <h3 class="font-bold text-lg text-slate-800">{{ isEditingModule ? 'Edit' : 'Buat' }} Modul</h3>
                            <button v-if="isEditingModule" @click="cancelEditModule" class="text-sm bg-gray-500 text-white px-3 rounded">Batal</button>
                        </div>
                        <div class="flex-grow flex flex-col lg:flex-row gap-6 overflow-hidden">
                            <div class="w-full lg:w-1/2 flex flex-col h-full gap-4">
                                <div class="bg-gray-50 p-4 rounded border shrink-0 shadow-sm space-y-3">
                                    <div><label class="text-xs font-bold text-gray-500">Nama Internal</label><input v-model="newModule.nameInternal" class="w-full border p-2 rounded text-sm"></div>
                                    <div><label class="text-xs font-bold text-gray-500">Nama Tampilan</label><input v-model="newModule.nameDisplay" class="w-full border p-2 rounded text-sm"></div>
                                </div>
                                <div class="border rounded-lg flex-grow overflow-y-auto scroller p-0 bg-white shadow-sm flex flex-col">
                                <div class="bg-gray-100 p-2 text-xs font-bold text-gray-500 border-b uppercase sticky top-0">Klik untuk menambahkan Sub Tes</div>
                                
                                <div v-for="(s, sIdx) in subTests" :key="'source-'+s.id+'-'+sIdx" @click="addToModule(s)" class="p-3 border-b hover:bg-blue-50 cursor-pointer text-sm flex justify-between group transition">
                                    <span class="font-medium text-slate-700">
                                        <span class="font-mono text-[9px] bg-gray-200 px-1 rounded text-gray-500 mr-2">#{{ s.id.substr(0,4) }}</span>
                                        {{s.nameInternal}}
                                    </span>
                                    <i class="fas fa-plus-circle text-blue-500 opacity-0 group-hover:opacity-100 transition"></i>
                                </div>
                            </div>
                            </div>
                            <div class="w-full lg:w-1/2 flex flex-col h-full bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-blue-800 text-sm uppercase tracking-wide">Urutan & Bobot Penilaian</h4>
                                    <div class="text-xs font-bold bg-white px-2 py-1 rounded border">
                                        Total Bobot: 
                                        <span :class="calculateTotalWeight() === 100 ? 'text-green-600' : 'text-red-500'">
                                            {{ calculateTotalWeight() }}%
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-3 rounded border border-blue-200 mb-3 shadow-sm flex items-center justify-between">
                                    <label class="text-xs font-bold text-gray-600 uppercase">Nilai Minimum (KKM) / Passing Grade:</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" v-model.number="newModule.passingGrade" class="w-20 border p-1 rounded text-center font-bold text-blue-800" placeholder="0">
                                        <span class="text-xs text-gray-400">Poin</span>
                                    </div>
                                </div>

                                <div class="flex-grow overflow-y-auto scroller space-y-2 mb-3 bg-white/50 p-2 rounded border border-blue-100">
                                    <div v-if="newModule.subIds.length===0" class="text-center text-gray-400 text-xs italic py-10">Belum ada Sub Tes dipilih.</div>
                                    
                                    <div v-for="(sid, i) in newModule.subIds" :key="i" class="bg-white p-2 rounded border border-gray-200 flex justify-between text-sm shadow-sm items-center gap-2">
                                        <div class="flex items-center gap-2 overflow-hidden flex-grow">
                                            <span class="bg-blue-600 text-white w-5 h-5 rounded-full inline-flex items-center justify-center text-xs shrink-0">{{i+1}}</span> 
                                            <span class="truncate">{{getSubName(sid)}}</span>
                                        </div>
                                        
                                        <div class="flex items-center gap-2 shrink-0">
                                            <div class="flex flex-col items-end">
                                                <label class="text-[9px] text-gray-400 font-bold uppercase">Bobot (%)</label>
                                                <input type="number" v-model.number="newModule.subWeights[sid]" class="w-14 border p-1 rounded text-center text-xs font-bold focus:ring-1 focus:ring-blue-500">
                                            </div>
                                            <button @click="removeFromModule(i)" class="text-red-400 hover:text-red-600 hover:bg-red-50 rounded p-1 ml-1"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <button @click="saveModule" class="w-full bg-blue-600 text-white py-2.5 rounded font-bold hover:bg-blue-700 shadow-md shrink-0">Simpan Modul</button>
                            </div>
                        </div>
                        <div class="mt-4 border-t pt-2 h-40 overflow-y-auto scroller grid grid-cols-1 md:grid-cols-3 gap-3 shrink-0">
                            <div v-for="m in modules" :key="m.id" class="border p-3 rounded bg-white hover:shadow-md transition flex justify-between items-center h-fit border-l-4 border-l-purple-500">
                                <div><div class="font-bold text-sm text-slate-700">{{m.nameInternal}}</div><div class="text-xs text-gray-500">{{m.subIds.length}} Sub Tes</div></div>
                                <div class="flex gap-1"><button @click="editModule(m)" class="text-yellow-600 bg-yellow-50 hover:bg-yellow-100 p-1.5 rounded"><i class="fas fa-edit"></i></button><button @click="deleteModule(m.id)" class="text-red-600 bg-red-50 hover:bg-red-100 p-1.5 rounded"><i class="fas fa-trash"></i></button></div>
                            </div>
                        </div>
                    </div>

                    <div v-if="adminTab === 'paket'" class="h-full flex flex-col p-6 overflow-hidden">
                        <div class="flex justify-between mb-4 pb-2 border-b shrink-0"><h3 class="font-bold text-lg text-green-800"><i class="fas fa-box-open mr-2"></i> Manajemen Paket Ujian</h3><button v-if="isEditingPackage" @click="cancelEditPackage" class="text-sm bg-gray-500 text-white px-3 py-1 rounded">Batal</button></div>
                        <div class="flex flex-col lg:flex-row gap-6 h-full overflow-hidden">
                            <div class="w-full lg:w-4/12 bg-green-50 p-5 rounded-xl border border-green-200 flex flex-col h-full overflow-hidden shadow-sm" :class="{'ring-2 ring-yellow-400': isEditingPackage}">
                                <h4 class="font-bold text-sm mb-4 text-green-900 shrink-0 border-b border-green-200 pb-2">{{ isEditingPackage ? 'Edit Paket' : 'Buat Paket Baru' }}</h4>
                                <div class="space-y-4 flex-grow overflow-y-auto scroller pr-1">
                                    <div><label class="text-xs font-bold block mb-1 text-green-800">Nama Paket</label><input v-model="newPackage.name" placeholder="Contoh: Paket UAS 2025" class="w-full border border-green-200 p-2 rounded text-sm bg-white focus:ring-green-500"></div>
                                    <div><label class="text-xs font-bold block mb-1 text-green-800">Pilih Modul (Checklist)</label><div class="bg-white border border-green-200 rounded max-h-40 overflow-y-auto p-2 space-y-1"><label v-for="m in modules" :key="m.id" class="flex items-center text-sm cursor-pointer hover:bg-green-50 p-1 rounded transition"><input type="checkbox" :value="m.id" v-model="newPackage.moduleIds" class="mr-2 text-green-600 focus:ring-green-500"><span class="truncate">{{ m.nameInternal }}</span></label></div></div>
                                    <div><label class="text-xs font-bold block mb-1 text-green-800">Target Peserta (Opsional)</label><div class="flex gap-4 text-sm mb-2"><label class="flex items-center"><input type="radio" v-model="newPackage.targetType" value="group" class="mr-1 text-green-600 focus:ring-green-500"> Grup</label><label class="flex items-center"><input type="radio" v-model="newPackage.targetType" value="user" class="mr-1 text-green-600 focus:ring-green-500"> User Spesifik</label></div>
                                    <div v-if="newPackage.targetType==='group'"><select v-model="newPackage.targetId" class="w-full border border-green-200 p-2 rounded text-sm bg-white cursor-pointer"><option value="" disabled>-- Pilih Grup --</option><option v-for="g in userGroups" :value="g.id">{{g.name}}</option></select></div>
                                    <div v-else class="bg-white border border-green-200 rounded max-h-40 overflow-y-auto p-2"><div v-for="usr in accounts.filter(a=>a.role==='peserta')" :key="usr.id" class="flex justify-between items-center text-sm mb-1 hover:bg-gray-50 p-1"><label class="flex items-center cursor-pointer truncate"><input type="checkbox" :value="usr.id" v-model="newPackage.selectedUsers" class="mr-2 text-green-600 focus:ring-green-500">{{usr.username}}</label><button v-if="newPackage.selectedUsers.includes(usr.id)" @click.stop="removeUserFromPackageForm(usr.id)" class="text-red-500 text-xs hover:bg-red-100 rounded px-1">x</button></div></div></div>
                                </div>
                                <button @click="savePackage" class="w-full bg-green-600 text-white py-2.5 rounded font-bold hover:bg-green-700 mt-4 shrink-0 shadow-sm transition transform active:scale-95">Simpan Paket</button>
                            </div>
                            <div class="w-full lg:w-8/12 space-y-3 h-full overflow-y-auto scroller pr-2">
                                <div v-if="examPackages.length===0" class="text-center text-gray-400 border-2 border-dashed py-16 rounded-xl">Belum ada paket ujian dibuat.</div>
                                <div v-for="pkg in examPackages" :key="pkg.id" class="bg-white border rounded-xl p-4 shadow-sm hover:shadow-md transition relative group border-l-4 border-l-green-500" :class="{'border-yellow-400 ring-1 ring-yellow-400': editingPackageId===pkg.id}">
                                    <div class="flex justify-between items-start border-b border-gray-100 pb-2 mb-2">
                                        <div><div class="font-bold text-slate-800 text-lg">{{pkg.name}}</div></div>
                                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button @click="editPackage(pkg)" class="text-xs bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded hover:bg-yellow-200 font-bold">Edit</button><button @click="deletePackage(pkg.id)" class="text-xs bg-red-100 text-red-700 px-3 py-1.5 rounded hover:bg-red-200 font-bold">Hapus</button></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-xs">
                                        <div><b class="uppercase text-gray-400 tracking-wider">Isi Modul:</b>
                                            <div v-if="pkg.moduleIds && pkg.moduleIds.length === 0" class="inline-block px-2 py-1 bg-gray-100 rounded text-gray-500 italic mt-1">Belum ada modul</div>
                                            <ul v-else class="list-disc list-inside text-gray-700 mt-1 font-medium"><li v-for="mid in pkg.moduleIds" :key="mid" class="truncate">{{ getModuleName(mid) }}</li></ul>
                                        </div>
                                        <div><b class="uppercase text-gray-400 tracking-wider">Target:</b>
                                            <div v-if="!pkg.targetId && pkg.selectedUsers.length === 0" class="inline-block px-2 py-1 bg-gray-100 rounded text-gray-500 italic mt-1">Belum diset</div>
                                            <div v-else-if="pkg.targetType==='group'" class="bg-green-100 px-2 py-1 rounded inline-block text-green-800 mt-1 font-bold shadow-sm">
                                                <i class="fas fa-users mr-1"></i> {{ getGroupName(pkg.targetId) }}
                                            </div>
                                            <div v-else class="text-purple-600 mt-1 font-bold bg-purple-100 px-2 py-1 rounded inline-block">
                                                <i class="fas fa-user mr-1"></i> {{ pkg.selectedUsers.length }} User Spesifik
                                            </div>
                                            <div v-if="pkg.targetType==='user' && pkg.selectedUsers.length > 0" class="mt-1 flex flex-wrap gap-1">
                                                <span v-for="uid in pkg.selectedUsers" :key="uid" class="text-[10px] bg-gray-100 border border-gray-200 px-2 py-0.5 rounded text-gray-600">
                                                    {{ accounts.find(a=>a.id===uid)?.username || 'Unknown' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="adminTab === 'hasil'" class="h-full flex flex-col p-6 overflow-hidden">
                        <div class="flex flex-col md:flex-row justify-between mb-4 gap-4 shrink-0 bg-gray-50 p-3 rounded-lg border">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center"><i class="fas fa-poll mr-2 text-blue-500"></i> Log Hasil Ujian</h3>
                            <div class="flex gap-2 items-center text-sm"><span class="font-bold text-gray-500">Filter:</span><input type="date" v-model="filterDate.start" class="border rounded px-2 py-1 shadow-sm"><span class="text-gray-400">-</span><input type="date" v-model="filterDate.end" class="border rounded px-2 py-1 shadow-sm"><button @click="filterDate.start='';filterDate.end=''" class="bg-white border px-3 py-1 rounded hover:bg-gray-100 text-gray-600"><i class="fas fa-undo"></i></button></div>
                        </div>
                        <div class="flex-grow overflow-auto scroller border rounded-lg bg-white shadow-sm">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0 shadow-sm">
                                    <tr>
                                        <th class="p-4 border-b">Peserta</th>
                                        <th class="p-4 border-b">Modul/Paket</th>
                                        <th class="p-4 border-b">Skor</th>
                                        <th class="p-4 border-b">Waktu</th>
                                        <th class="p-4 border-b text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr v-for="res in filteredResults" :key="res.id" class="hover:bg-blue-50 transition">
                                        <td class="p-4 font-bold text-slate-700">{{ getParticipantName(res) }}</td>
                                        
                                        <td class="p-4 text-gray-600">
                                            <span class="font-bold">{{ getCleanModuleNameForDisplay(res.moduleName) }}</span>
                                            
                                            <span v-if="checkViolation(res.moduleName)" class="ml-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide shadow-sm animate-pulse">
                                                <i class="fas fa-ban mr-1"></i> PELANGGARAN
                                            </span>

                                            <span v-if="checkWarning(res.moduleName) > 0" class="ml-2 bg-yellow-100 text-yellow-700 border border-yellow-300 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide">
                                                <i class="fas fa-exclamation-circle mr-1"></i> {{ checkWarning(res.moduleName) }}x Warning
                                            </span>
                                            
                                            <span v-if="res.packageId" class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded ml-1 text-gray-600 font-bold uppercase">Pkg</span>
                                        </td>

                                        <td class="p-4">
                                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">{{calculateTotalScore(res)}}</span>
                                        </td>
                                        
                                        <td class="p-4 text-xs font-mono text-gray-500">{{formatDateTime(res.endTime)}}</td>
                                        
                                        <td class="p-4 text-center">
                                            <button @click="viewResultDetail(res)" class="text-blue-600 hover:text-blue-800 font-bold text-xs bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded transition">Detail</button>
                                        </td>
                                    </tr>
                                </tbody>   
                            </table>                    
                        </div>
                    </div>

                    <div v-if="adminTab === 'akun'" class="h-full flex flex-col p-6 overflow-y-auto space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow border border-gray-200 shrink-0">
                            <h3 class="font-bold text-lg text-blue-800 mb-4 flex items-center"><i class="fas fa-users mr-2 bg-blue-100 p-2 rounded"></i> Manajemen Grup Peserta</h3>
                            <div class="flex gap-3 mb-4">
                                <input v-model="newUserGroup.name" placeholder="Nama Grup Baru (Misal: Kelas 10-A)" class="border p-2 rounded-lg flex-grow text-sm shadow-sm">
                                <button @click="createGroupUser" class="bg-blue-600 text-white px-6 rounded-lg font-bold hover:bg-blue-700 text-sm shadow">Buat Grup</button>
                            </div>
                            <div class="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 min-h-[60px]">
                                <div v-if="userGroups.length === 0" class="text-gray-400 text-sm italic w-full text-center py-2">Belum ada grup.</div>
                                <div v-for="grp in userGroups" :key="grp.id" class="bg-white border border-blue-200 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center shadow-sm">
                                    <span class="font-bold mr-2">{{ grp.name }}</span>
                                    <button @click="deleteGroupUser(grp.id)" class="text-red-400 hover:text-red-600 w-5 h-5 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow border border-gray-200 flex flex-col flex-grow">
                            <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-100 shrink-0">
                                <h3 class="font-bold text-lg text-gray-800 flex items-center"><i class="fas fa-user-cog mr-2 bg-gray-100 p-2 rounded"></i> Data Akun Pengguna</h3>
                                <div class="flex gap-2">
                                    <button @click="resetResultData" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700">Reset Log Hasil Ujian</button>
                                    <button v-if="isEditingAccount" @click="cancelEditAccount" class="text-xs bg-gray-500 text-white px-3 py-1.5 rounded hover:bg-gray-600">Batal Edit</button>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 mb-6 shadow-sm shrink-0" :class="{'ring-2 ring-yellow-400 bg-yellow-50': isEditingAccount}">
                                <h4 class="font-bold text-sm text-blue-900 mb-3">{{ isEditingAccount ? 'Edit Akun' : 'Tambah Akun Baru' }}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
                                    <input v-model="newAccount.username" placeholder="Username" class="border p-2 rounded text-sm">
                                    <input v-model="newAccount.email" placeholder="Email" class="border p-2 rounded text-sm">
                                    <input v-model="newAccount.password" placeholder="Password" class="border p-2 rounded text-sm">
                                    <select v-model="newAccount.role" class="border p-2 rounded text-sm font-bold"><option value="peserta">Peserta</option><option value="admin">Admin</option><option value="review">Reviewer</option></select>
                                </div>
                                <div v-if="newAccount.role==='peserta'" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3 fade-in">
                                    <select v-model="newAccount.groupId" class="border p-2 rounded text-sm"><option value="">- Pilih Grup -</option><option v-for="g in userGroups" :value="g.id">{{g.name}}</option></select>
                                    <select v-model="newAccount.status" class="border p-2 rounded text-sm"><option value="active">Active</option><option value="pending">Pending</option><option value="suspend">Suspend</option></select>
                                </div>
                                <button @click="saveAccount" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm hover:bg-blue-700 shadow-sm">{{ isEditingAccount ? 'Update Data' : 'Simpan Akun' }}</button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                                <div class="flex flex-col h-auto border border-blue-100 rounded-xl bg-white shadow-sm overflow-hidden">
                                    <div class="p-3 bg-blue-50 border-b border-blue-100 font-bold text-blue-900 flex justify-between items-center text-sm">
                                        <span><i class="fas fa-user-shield mr-2"></i> Daftar Admin</span>
                                        <span class="bg-white text-blue-600 px-2 py-0.5 rounded text-xs border border-blue-200">{{ accounts.filter(a => a.role === 'admin').length }}</span>
                                    </div>
                                    <div class="p-2 space-y-2 max-h-60 overflow-y-auto scroller">
                                        <div v-for="acc in accounts.filter(a => a.role === 'admin')" :key="acc.id" class="p-3 border rounded-lg bg-white hover:shadow-md transition relative group" :class="{'ring-2 ring-yellow-400': editingAccountId === acc.id}">
                                            <div class="font-bold text-gray-800 text-sm">{{ acc.username }}</div>
                                            <div class="text-xs text-gray-500">{{ acc.email }} | <span class="font-mono">{{ acc.password }}</span></div>
                                            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button @click="editAccount(acc)" class="text-yellow-600 bg-yellow-50 p-1 rounded hover:bg-yellow-100"><i class="fas fa-edit"></i></button>
                                                <button v-if="acc.username!=='admin'" @click="deleteAccount(acc.id)" class="text-red-600 bg-red-50 p-1 rounded hover:bg-red-100"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-purple-50 border-t border-b border-purple-100 font-bold text-purple-900 flex justify-between items-center text-sm">
                                        <span><i class="fas fa-search-plus mr-2"></i> Daftar Reviewer</span>
                                        <span class="bg-white text-purple-600 px-2 py-0.5 rounded text-xs border border-purple-200">{{ accounts.filter(a => a.role === 'review').length }}</span>
                                    </div>
                                    <div class="p-2 space-y-2 max-h-60 overflow-y-auto scroller bg-purple-50/10">
                                        <div v-if="accounts.filter(a => a.role === 'review').length === 0" class="text-center text-gray-400 text-xs py-2 italic">Belum ada akun reviewer.</div>
                                        <div v-for="acc in accounts.filter(a => a.role === 'review')" :key="acc.id" class="p-3 border rounded-lg bg-white hover:shadow-md transition relative group border-l-4 border-l-purple-400" :class="{'ring-2 ring-yellow-400': editingAccountId === acc.id}">
                                            <div class="font-bold text-gray-800 text-sm">{{ acc.username }}</div>
                                            <div class="text-xs text-gray-500">{{ acc.email }} | <span class="font-mono">{{ acc.password }}</span></div>
                                            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button @click="editAccount(acc)" class="text-yellow-600 bg-yellow-50 p-1 rounded hover:bg-yellow-100"><i class="fas fa-edit"></i></button>
                                                <button @click="deleteAccount(acc.id)" class="text-red-600 bg-red-50 p-1 rounded hover:bg-red-100"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col h-auto border border-green-100 rounded-xl bg-white shadow-sm">
                                    <div class="p-3 bg-green-50 border-b border-green-100 font-bold text-green-900 flex justify-between items-center text-sm">
                                        <span><i class="fas fa-users mr-2"></i> Daftar Peserta</span>
                                        <span class="bg-white text-green-600 px-2 py-0.5 rounded text-xs border border-green-200">{{ accounts.filter(a => a.role === 'peserta').length }}</span>
                                    </div>
                                    <div class="p-2 space-y-2 flex-grow overflow-y-auto scroller h-96">
                                        <div v-if="accounts.filter(a => a.role === 'peserta').length === 0" class="text-center text-gray-400 text-xs py-4">Belum ada akun peserta.</div>
                                        <div v-for="acc in accounts.filter(a => a.role === 'peserta')" :key="acc.id" class="p-3 border rounded-lg bg-white hover:shadow-md transition relative group" :class="{'ring-2 ring-yellow-400': editingAccountId === acc.id}">
                                            <div class="flex justify-between">
                                                <div>
                                                    <div class="font-bold text-gray-800 text-sm">{{ acc.username }}</div>
                                                    <div class="text-xs text-gray-500">{{ acc.email }} | <span class="font-mono">{{ acc.password }}</span></div>
                                                    <div class="flex gap-1 mt-1.5">
                                                        <span class="text-[10px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100">{{ getGroupName(acc.groupId) }}</span>
                                                        <span class="text-[10px] px-2 py-0.5 rounded border uppercase font-bold" :class="{'bg-green-50 text-green-700 border-green-200': acc.status==='active', 'bg-red-50 text-red-700 border-red-200': acc.status==='suspend', 'bg-yellow-50 text-yellow-700 border-yellow-200': acc.status==='pending'}">{{ acc.status }}</span>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity justify-center">
                                                    <button @click="editAccount(acc)" class="text-yellow-600 bg-yellow-50 p-1.5 rounded hover:bg-yellow-100"><i class="fas fa-edit"></i></button>
                                                    <button @click="deleteAccount(acc.id)" class="text-red-600 bg-red-50 p-1.5 rounded hover:bg-red-100"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div v-if="isLoggedIn && currentRole === 'review'" class="flex flex-col h-full bg-slate-100">
        <nav class="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-40 shrink-0 border-b border-indigo-700">
            <div class="container-fluid px-6 flex justify-between items-center">
                <h1 class="text-lg font-bold tracking-wider flex items-center text-indigo-300">
                    <i class="fas fa-search-location mr-3 text-xl"></i> REVIEWER DASHBOARD
                </h1>
                <div class="flex items-center space-x-6">
                    <div class="text-right hidden md:block">
                        <div class="text-sm font-bold text-gray-200">{{ currentUser.username }}</div>
                        <div class="text-xs text-gray-400 uppercase tracking-widest">Auditor</div>
                    </div>
                    <button @click="handleLogout" class="text-xs bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold transition shadow border border-red-500 flex items-center">
                        <i class="fas fa-power-off mr-2"></i> Keluar
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-grow overflow-hidden relative p-4 lg:p-6 flex flex-col">
            <div class="flex space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-200 overflow-x-auto shrink-0 scroller mb-4">
                <button @click="reviewTab = 'history'; resetReviewState()" :class="reviewTab==='history' ? 'bg-indigo-800 text-white shadow-md' : 'bg-gray-50 text-gray-600 hover:bg-gray-200'" class="px-6 py-2 rounded-md font-bold transition text-sm flex items-center"><i class="fas fa-history mr-2"></i> 1. HISTORY</button>
                <button @click="reviewTab = 'review'; resetReviewState()" :class="reviewTab==='review' ? 'bg-indigo-800 text-white shadow-md' : 'bg-gray-50 text-gray-600 hover:bg-gray-200'" class="px-6 py-2 rounded-md font-bold transition text-sm flex items-center"><i class="fas fa-clipboard-check mr-2"></i> 2. REVIEW</button>
            </div>

            <div class="flex-grow overflow-hidden bg-white rounded-lg shadow-md border border-gray-300 relative">
                <div v-if="reviewTab === 'history'" class="h-full flex flex-col p-6 overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between mb-4 gap-4 shrink-0 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <h3 class="font-bold text-lg text-indigo-900 flex items-center"><i class="fas fa-history mr-2"></i> Riwayat Ujian Lengkap</h3>
                        <div class="flex flex-wrap gap-2 items-center text-sm">
                            <select v-model="reviewFilterGroup" class="border rounded px-2 py-1.5 shadow-sm text-sm"><option value="">Semua Grup</option><option v-for="g in userGroups" :value="g.id">{{g.name}}</option></select>
                            <input v-model="reviewSearch" placeholder="Cari Nama User..." class="border rounded px-3 py-1.5 shadow-sm text-sm">
                            <select v-model="reviewSort" class="border rounded px-2 py-1.5 shadow-sm text-sm font-bold text-indigo-800">
                                <option value="date_desc">Tanggal (Terbaru)</option>
                                <option value="date_asc">Tanggal (Terlama)</option>
                                <option value="score_desc">Nilai (Tertinggi)</option>
                                <option value="score_asc">Nilai (Terendah)</option>
                                <option value="name_asc">Nama (A-Z)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-grow overflow-auto scroller border rounded-lg bg-white shadow-sm">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th class="p-4 border-b">Nama User</th>
                                    <th class="p-4 border-b">Grup</th>
                                    <th class="p-4 border-b">Waktu Ujian</th>
                                    <th class="p-4 border-b">Modul/Ujian</th>
                                    <th class="p-4 border-b">Nilai</th>
                                    <th class="p-4 border-b">Status</th>
                                    <th class="p-4 border-b">Durasi</th>
                                    <th class="p-4 border-b text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="res in filteredReviewResults" :key="res.id" class="hover:bg-indigo-50 transition">
                                    <td class="p-4 font-bold text-slate-700">{{ getParticipantName(res) }}</td>
                                    <td class="p-4 text-xs"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded border">{{ getParticipantGroup(res.participantId) }}</span></td>
                                    <td class="p-4 text-xs text-gray-500 font-mono">{{ formatDateTime(res.endTime) }}</td>
                                    <td class="p-4 text-gray-600">
                                        <span class="font-bold">{{ getCleanModuleNameForDisplay(res.moduleName || res.moduleName) }}</span>
                                        
                                        <span v-if="checkViolation(res.moduleName)" class="ml-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide shadow-sm animate-pulse">
                                            <i class="fas fa-ban mr-1"></i> PELANGGARAN
                                        </span>

                                        <span v-if="checkWarning(res.moduleName) > 0" class="ml-2 bg-yellow-100 text-yellow-700 border border-yellow-300 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide">
                                            <i class="fas fa-exclamation-circle mr-1"></i> {{ checkWarning(res.moduleName) }}x Warning
                                        </span>
                                        
                                        <span v-if="res.packageId" class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded ml-1 text-gray-600 font-bold uppercase">Pkg</span>
                                    </td>
                                    <td class="p-4"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">{{ calculateTotalScore(res) }}</span></td>
                                    <td class="p-4"><span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] uppercase font-bold border border-green-200">Selesai</span></td>
                                    <td class="p-4 text-xs font-mono text-gray-500">{{ calculateDuration(res) }}</td>
                                    <td class="p-4 text-center">
                                        <button @click="viewResultDetail(res)" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm">Detail</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="reviewTab === 'review'" class="h-full flex flex-col overflow-hidden relative">
                    <div v-if="reviewState === 'list'" class="h-full flex flex-col p-6">
                        <div class="flex flex-col md:flex-row justify-between mb-4 gap-4 shrink-0 bg-purple-50 p-4 rounded-lg border border-purple-100">
                            <h3 class="font-bold text-lg text-purple-900 flex items-center"><i class="fas fa-users mr-2"></i> Daftar Peserta Ujian</h3>
                            <div class="flex gap-2 items-center text-sm">
                                <select v-model="reviewFilterGroup" class="border rounded px-2 py-1.5 shadow-sm text-sm"><option value="">Semua Grup</option><option v-for="g in userGroups" :value="g.id">{{g.name}}</option></select>
                                <input v-model="reviewSearch" placeholder="Cari Nama User..." class="border rounded px-3 py-1.5 shadow-sm text-sm w-64">
                            </div>
                        </div>
                        <div class="flex-grow overflow-auto scroller border rounded-lg bg-white shadow-sm">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0 shadow-sm z-10"><tr><th class="p-4 border-b">Username</th><th class="p-4 border-b">Grup</th><th class="p-4 border-b text-center">Aksi</th></tr></thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr v-for="u in filteredUsersForReview" :key="u.id" class="hover:bg-purple-50 transition">
                                        <td class="p-4 font-bold text-slate-700">{{ u.username }}</td>
                                        <td class="p-4"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 text-xs">{{ getGroupName(u.groupId) }}</span></td>
                                        <td class="p-4 text-center"><button @click="openUserDetail(u)" class="bg-purple-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-purple-700 shadow transition">Cek Data</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="reviewState === 'detail'" class="h-full flex flex-col p-6 bg-gray-50">
                        <div class="mb-4 flex items-center gap-3 shrink-0">
                            <button @click="reviewState='list'" class="bg-white border px-3 py-1.5 rounded hover:bg-gray-100 text-sm font-bold text-gray-600"><i class="fas fa-arrow-left mr-1"></i> Kembali</button>
                            <h3 class="font-bold text-lg text-slate-800">Detail: <span class="text-purple-600">{{ selectedReviewUser.username }}</span></h3>
                        </div>
                        <div class="flex-grow overflow-auto scroller bg-white rounded-lg shadow-sm border">
                            <div v-if="userExamHistory.length === 0" class="p-10 text-center text-gray-400 italic">User ini belum mengerjakan ujian apapun.</div>
                            <table v-else class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-4 border-b">Modul/Ujian</th>
                                        <th class="p-4 border-b">Tanggal</th>
                                        <th class="p-4 border-b">Total Skor</th>
                                        <th class="p-4 border-b">Rincian Nilai Subtes</th> <th class="p-4 border-b text-center">Review</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr v-for="h in userExamHistory" :key="h.id" class="hover:bg-gray-50">
                                        <td class="p-4 text-gray-600">
                                            <span class="font-bold">{{ getCleanModuleNameForDisplay(h.moduleName) }}</span>
                                            
                                            <span v-if="checkViolation(h.moduleName)" class="ml-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide shadow-sm animate-pulse">
                                                <i class="fas fa-ban mr-1"></i> PELANGGARAN
                                            </span>

                                            <span v-if="checkWarning(h.moduleName) > 0" class="ml-2 bg-yellow-100 text-yellow-700 border border-yellow-300 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide">
                                                <i class="fas fa-exclamation-circle mr-1"></i> {{ checkWarning(h.moduleName) }}x Warning
                                            </span>
                                            
                                            <span v-if="h.packageId" class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded ml-1 text-gray-600 font-bold uppercase">Pkg</span>
                                        </td>
                                        <td class="p-4 text-xs text-gray-500 font-mono">{{ formatDateTime(h.endTime) }}</td>
                                        <td class="p-4 font-bold text-blue-600 text-lg">{{ calculateTotalScore(h) }}</td>
                                        <td class="p-4 text-xs">
                                            <div class="flex flex-wrap gap-1">
                                                <span v-for="(subRes, sIdx) in h.subResults" :key="sIdx" 
                                                    class="bg-gray-100 border border-gray-300 px-2 py-0.5 rounded text-[10px] font-bold text-gray-700" 
                                                    :title="subRes.subName">
                                                    {{ subRes.subNameInternal || ('Sub '+(sIdx+1)) }}: <span class="text-blue-600">{{ subRes.score.toFixed(0) }}</span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="p-4 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button @click="startFullReview(h)" class="bg-orange-500 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-orange-600 shadow transition" title="Lihat di Layar">
                                                    <i class="fas fa-eye mr-1"></i> REVIEW
                                                </button>
                                                
                                                <button @click="openExportModal(h)" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-blue-700 shadow transition" title="Cetak / Download">
                                                    <i class="fas fa-print mr-1"></i> PRINT
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="reviewState === 'exam_view'" class="h-full flex flex-col bg-white">
                        <div class="bg-slate-800 text-white p-3 shrink-0 flex justify-between items-center shadow-md">
                            <div class="flex items-center gap-4">
                                <button @click="reviewState='detail'" class="text-gray-300 hover:text-white"><i class="fas fa-arrow-left fa-lg"></i></button>
                                <div>
                                    <div class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Review Mode</div>
                                    <div class="font-bold text-sm">{{ selectedReviewResult.moduleName }} - {{ selectedReviewUser.username }}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <div class="text-[10px] text-gray-400">Sub Tes</div>
                                    <div class="font-bold text-sm text-yellow-400">{{ reviewCurrentSub.nameDisplay }}</div>
                                </div>
                                <div class="bg-slate-700 px-3 py-1 rounded text-center">
                                    <div class="text-[10px] text-gray-400">Nilai Sub</div>
                                    <div class="font-bold text-white">{{ getCurrentSubScore() }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex-grow flex overflow-hidden">
                            <div v-if="reviewCurrentSub.navType !== 'missing_numbers'" class="w-72 bg-gray-50 border-r flex flex-col shrink-0">
                                <div class="p-4 border-b font-bold text-xs uppercase text-gray-500 flex justify-between items-center">
                                    <span>Navigasi Soal</span>
                                    <span class="text-[10px] bg-white border px-2 py-0.5 rounded">{{ reviewQuestions.length }} Butir</span>
                                </div>
                                
                                <div class="flex-grow overflow-y-auto scroller p-3">
                                    <div class="grid grid-cols-5 gap-2 content-start">
                                        <button v-for="(q, idx) in reviewQuestions" :key="q.id" @click="reviewQuestionIndex = idx" 
                                            class="h-10 rounded border font-bold text-sm transition relative flex items-center justify-center" 
                                            :class="getReviewNavClass(idx)">
                                            {{ idx + 1 }}        
                                            
                                            <div v-if="q.userFlagged" class="absolute top-0.5 left-0.5 text-[8px] text-yellow-600 z-20 bg-yellow-100 rounded-full px-0.5 border border-yellow-300">
                                                <i class="fas fa-flag"></i>
                                            </div>

                                            <div v-if="reviewCurrentSub.type === 'normal'">
                                                <div v-if="q.userCorrect" class="absolute -top-1 -right-1 text-[8px] bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center border-2 border-white shadow-sm"><i class="fas fa-check"></i></div>
                                                <div v-else-if="q.userAnswerId" class="absolute -top-1 -right-1 text-[8px] bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center border-2 border-white shadow-sm"><i class="fas fa-times"></i></div>
                                            </div>
                                            
                                            <div v-else-if="reviewCurrentSub.type === 'weighted' && q.userAnswerId" 
                                                class="absolute -top-2 -right-2 text-[9px] bg-green-500 text-white rounded px-1 py-0.5 border border-white shadow-sm flex items-center justify-center scale-90">
                                                {{ getQuestionScore(q) }}
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                                                        
                            <div class="flex-grow flex flex-col bg-white relative h-full overflow-hidden"> <div class="flex-grow overflow-y-auto scroller p-6 md:p-10">
                                    <div v-if="reviewCurrentSub.navType === 'missing_numbers'" class="h-full flex flex-col">
                                        
                                        <div class="max-w-5xl mx-auto w-full p-4">
                                            <h3 class="font-bold text-xl text-slate-800 mb-6 flex items-center justify-center">
                                                <i class="fas fa-chart-column mr-2 text-purple-600"></i> Analisis Hasil Kecermatan
                                            </h3>
                                            
                                            <div v-if="currentReviewSubResult && currentReviewSubResult.detail" class="bg-white border rounded-xl shadow-sm p-6 relative">
                                                
                                                <div class="chart-wrapper w-full h-[400px]"> <svg viewBox="0 0 400 300" class="chart-svg" preserveAspectRatio="none">
                                                        <g v-for="n in 6" :key="n">
                                                            <line x1="30" :y1="270 - ((n-1)*50)" x2="400" :y2="270 - ((n-1)*50)" class="grid-line" />
                                                            <text x="25" :y="270 - ((n-1)*50) + 3" text-anchor="end" class="axis-text">{{ (n-1)*10 }}</text>
                                                        </g>

                                                        <g v-for="(col, i) in currentReviewSubResult.detail" :key="i" class="bar-group">
                                                            <rect :x="30 + (i*37)" y="0" width="37" height="300" class="hit-area" />
                                                            
                                                            <rect :x="30 + (i*37) + 8" :y="270 - (col.correct * 5)" width="8" :height="col.correct * 5" class="bar-correct" />
                                                            
                                                            <rect :x="30 + (i*37) + 18" :y="270 - (col.wrong * 5)" width="8" :height="col.wrong * 5" class="bar-wrong" />
                                                            
                                                            <text :x="30 + (i*37) + 18" y="290" text-anchor="middle" class="axis-text" style="font-weight:bold">K{{i+1}}</text>
                                                            
                                                            <foreignObject :x="30 + (i*37)" y="0" width="100" height="300" style="pointer-events: none; overflow: visible;">
                                                                <div xmlns="http://www.w3.org/1999/xhtml" class="tooltip-box absolute bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg z-50 transform -translate-x-1/2 -translate-y-full pointer-events-none whitespace-nowrap" :style="{top: (270 - (col.answered * 5) - 10) + 'px', left: '18px'}">
                                                                    <div class="font-bold border-b border-gray-600 mb-1 pb-1">Kolom {{i+1}}</div>
                                                                    <div class="text-green-400">Benar: {{col.correct}}</div>
                                                                    <div class="text-red-400">Salah: {{col.wrong}}</div>
                                                                    <div class="text-blue-400 font-bold mt-1">Total: {{col.answered}}</div>
                                                                    <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1 border-4 border-transparent border-t-slate-800"></div>
                                                                </div>
                                                            </foreignObject>
                                                        </g>

                                                        <polyline fill="none" stroke="#3b82f6" stroke-width="2" :points="currentReviewSubResult.detail.map((c, i) => `${30 + (i*37) + 18},${270 - (c.answered * 5)}`).join(' ')" />
                                                        
                                                        <g v-for="(col, i) in currentReviewSubResult.detail" :key="'dot'+i" class="dot-group pointer-events-none">
                                                            <circle :cx="30 + (i*37) + 18" :cy="270 - (col.answered * 5)" r="3" class="dot-answered" />
                                                        </g>
                                                    </svg>
                                                </div>

                                                <div class="flex justify-center gap-6 mt-6 text-xs font-bold text-gray-600">
                                                    <div class="flex items-center"><span class="w-4 h-4 bg-green-500 mr-2 rounded opacity-80"></span>Benar</div>
                                                    <div class="flex items-center"><span class="w-4 h-4 bg-red-500 mr-2 rounded opacity-80"></span>Salah</div>
                                                    <div class="flex items-center"><span class="w-4 h-4 bg-blue-500 mr-2 rounded-full border-2 border-white shadow-sm"></span>Total (Garis)</div>
                                                </div>

                                            </div>
                                            <div v-else class="text-center py-20 text-gray-400 border-2 border-dashed rounded-xl">
                                                Data detail grafik tidak tersedia untuk hasil ini.
                                            </div>
                                        </div>

                                    </div>

                                    <div v-else>
                                        <div v-if="reviewQuestions.length > 0">
                                            <div class="max-w-3xl mx-auto w-full">
                                                <div class="mb-6 flex justify-between items-start border-b pb-4">
                                                    <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Soal No. {{ reviewQuestionIndex + 1 }}</span>
                                                    <span v-if="reviewCurrentSub.type==='weighted'" class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-200 uppercase">Soal Berbobot</span>
                                                </div>

                                                <div class="exam-content text-lg mb-8 text-gray-800" v-html="currentReviewQ.text"></div>

                                                <div class="space-y-3 mb-8">
                                                    <div v-for="opt in currentReviewQ.options" :key="opt.id" class="border-2 rounded-xl p-4 flex items-center gap-4 transition relative overflow-hidden" :class="getReviewOptionClass(opt, currentReviewQ)">
                                                        <div class="w-10 h-10 rounded-lg border-2 flex items-center justify-center font-bold text-lg shrink-0 z-10 bg-white" 
                                                            :class="getReviewOptionClass(opt, currentReviewQ).includes('bg-white') ? 'border-gray-300 text-gray-500' : 'border-transparent text-inherit'">
                                                            {{ opt.label }}
                                                        </div>
                                                        <div class="flex-grow">
                                                            <div class="exam-content z-10" v-html="opt.text"></div>
                                                            <div v-if="reviewCurrentSub.type === 'weighted'" class="text-xs font-bold mt-1 text-slate-500">
                                                                Nilai: <span class="text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">{{ opt.weight || 0 }} Poin</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div v-if="reviewCurrentSub.type === 'normal'">
                                                            <div v-if="opt.isCorrect" class="absolute right-3 top-3 text-green-500 z-20 text-xl" title="Kunci Jawaban">
                                                                <i class="fas fa-check-circle"></i>
                                                            </div>
                                                            
                                                            <div v-if="currentReviewQ.userAnswerIds.includes(opt.id) && !opt.isCorrect" class="absolute right-3 top-3 text-red-500 z-20 text-xl" title="Jawaban Anda (Salah)">
                                                                <i class="fas fa-times-circle"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div v-if="currentReviewQ.explanation" class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                                                    <h4 class="font-bold text-blue-900 text-sm uppercase mb-2 flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i> Pembahasan</h4>
                                                    <div class="exam-content text-sm text-gray-700" v-html="currentReviewQ.explanation"></div>
                                                </div>
                                            </div>
                                            </div>
                                        <div v-else class="flex flex-col items-center justify-center h-full text-gray-400 py-20">
                                            <i class="fas fa-eye-slash text-4xl mb-2"></i>
                                            <p>Tidak ada detail soal untuk Sub Tes ini.</p>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="reviewCurrentSub.navType !== 'missing_numbers' && reviewQuestions.length > 0" class="p-4 border-t bg-white flex justify-between shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                                    <button @click="reviewQuestionIndex > 0 ? reviewQuestionIndex-- : null" :disabled="reviewQuestionIndex===0" class="px-5 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-bold disabled:opacity-50 hover:bg-gray-200 transition">Sebelumnya</button>
                                    <button @click="reviewQuestionIndex < reviewQuestions.length-1 ? reviewQuestionIndex++ : null" :disabled="reviewQuestionIndex===reviewQuestions.length-1" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold disabled:opacity-50 hover:bg-blue-700 transition">Selanjutnya</button>
                                </div>

                            </div>
                        </div>
                        
                        <div class="bg-gray-100 p-3 border-t shrink-0 flex justify-between items-center z-10">
                             <button @click="prevReviewSub" :disabled="reviewSubIndex===0" class="bg-white border px-4 py-2 rounded text-sm font-bold text-blue-600 hover:bg-blue-50 disabled:opacity-50 disabled:bg-gray-100">&laquo; Sub Tes Sebelumnya</button>
                             <div class="text-xs font-bold text-gray-500">Sub Tes {{ reviewSubIndex+1 }} dari {{ reviewTotalSubs }}</div>
                             <button @click="nextReviewSub" :disabled="reviewSubIndex===reviewTotalSubs-1" class="bg-white border px-4 py-2 rounded text-sm font-bold text-blue-600 hover:bg-blue-50 disabled:opacity-50 disabled:bg-gray-100">Sub Tes Berikutnya &raquo;</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div v-if="isLoggedIn && currentRole === 'peserta'" class="flex flex-col h-full bg-slate-50">
        <nav v-if="examState === 'selection' || examState === 'finished'" class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-40 shrink-0">
             <div class="container mx-auto max-w-6xl flex justify-between items-center">
                <h1 class="text-xl font-extrabold tracking-wide flex items-center"><i class="fas fa-graduation-cap mr-2"></i>CIBN</h1>
                <div class="flex items-center space-x-4">
                    <div class="text-right"><div class="text-sm font-bold">{{ currentUser.username }}</div>
                    <div class="text-[10px] bg-blue-700 px-2 py-0.5 rounded inline-block">
                        {{ getGroupName(currentUser.groupId || currentUser.group_id) }}
                    </div>
                </div>
                    <button @click="handleLogout" class="text-xs bg-white text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition shadow">Keluar</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow flex flex-col p-4 md:p-6 overflow-hidden">
             <div class="container mx-auto max-w-6xl flex flex-col h-full fade-in">
                <div v-if="examState === 'selection'" class="flex-grow flex flex-col">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Daftar Ujian Tersedia</h2>
                        <div class="bg-white p-1 rounded border"><button @click="pesertaTab='ujian'" :class="pesertaTab==='ujian'?'bg-blue-100 text-blue-800':''" class="px-4 py-1 rounded text-sm font-bold">Ujian</button><button @click="pesertaTab='riwayat'" :class="pesertaTab==='riwayat'?'bg-blue-100 text-blue-800':''" class="px-4 py-1 rounded text-sm font-bold">Riwayat</button></div>
                    </div>
                    
                    <div v-if="pesertaTab==='ujian'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto scroller pb-10">
                        <div v-for="item in availableExams" :key="item.uniqueId" class="bg-white rounded-2xl shadow hover:shadow-xl transition flex flex-col overflow-hidden border border-gray-100 group">
                            <div class="p-6 flex-grow">
                                <span class="bg-blue-50 text-blue-700 text-[10px] font-extrabold uppercase px-2 py-1 rounded mb-3 inline-block">Paket: {{ item.packageName }}</span>
                                <h3 class="font-extrabold text-xl text-gray-800 mb-2">{{ item.module.nameDisplay }}</h3>
                                <div class="text-sm text-gray-500 font-medium"><i class="fas fa-layer-group mr-2 text-blue-400"></i> {{ item.module.subIds.length }} Sub Tes</div>
                            </div>
                            <div class="p-4 bg-gray-50 border-t"><button @click="startExam(item.module.id, item.packageId)" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-md">Mulai Kerjakan</button></div>
                        </div>
                        <div v-if="availableExams.length===0" class="col-span-full text-center py-20 text-gray-400 border-2 border-dashed rounded-xl">Tidak ada ujian tersedia.</div>
                    </div>

                    <div v-if="pesertaTab==='riwayat'" class="bg-white rounded-xl shadow border flex flex-col h-[calc(100vh-200px)] overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-history mr-2 text-blue-500"></i> Daftar Riwayat Ujian Anda</h3>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">{{ myResults.length }} Data</span>
                        </div>

                        <div class="flex-grow overflow-y-auto scroller bg-white">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="p-4 border-b">Modul/Paket</th>
                                        <th class="p-4 border-b">Waktu Selesai</th>
                                        <th class="p-4 border-b">Total Skor</th>
                                        <th class="p-4 border-b text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr v-for="r in myResults" :key="r.id" class="hover:bg-blue-50 transition">
                                        <td class="p-4 text-gray-600">
                                            <span class="font-bold">{{ getCleanModuleNameForDisplay(r.moduleName) }}</span>
                                            
                                            <span v-if="checkViolation(r.moduleName)" class="ml-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide shadow-sm animate-pulse">
                                                <i class="fas fa-ban mr-1"></i> PELANGGARAN
                                            </span>

                                            <span v-if="checkWarning(r.moduleName) > 0" class="ml-2 bg-yellow-100 text-yellow-700 border border-yellow-300 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide">
                                                <i class="fas fa-exclamation-circle mr-1"></i> {{ checkWarning(r.moduleName) }}x Warning
                                            </span>
                                            
                                            <span v-if="r.packageId" class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded ml-1 text-gray-600 font-bold uppercase">Pkg</span>
                                        </td>
                                        <td class="p-4 text-gray-500 font-mono text-xs">{{formatDateTime(r.endTime)}}</td>
                                        <td class="p-4 font-bold text-blue-600 text-lg">{{calculateTotalScore(r)}}</td>
                                        <td class="p-4 text-center">
                                            <button @click="viewResultDetail(r)" class="bg-white border border-blue-200 text-blue-600 px-4 py-1.5 rounded-lg font-bold text-xs hover:bg-blue-600 hover:text-white transition shadow-sm">
                                                <i class="fas fa-eye mr-1"></i> Detail
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div v-if="myResults.length===0" class="flex flex-col items-center justify-center h-full text-gray-400 italic min-h-[200px]">
                                <i class="fas fa-folder-open text-4xl mb-2 opacity-30"></i>
                                <p>Belum ada riwayat ujian.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="examState === 'running'" class="flex-grow flex flex-col bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200 relative h-full">
                    <div class="bg-slate-800 text-white p-4 flex justify-between items-center z-10 shadow-md shrink-0">
                        <div>
                            <div class="text-[10px] text-green-400 uppercase font-bold tracking-widest mb-1 flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></span> Sedang Berlangsung</div>
                            <div class="font-bold text-xl">{{ activeExam.currentSub.nameDisplay }} <span v-if="activeExam.currentSub.navType==='missing_numbers'" class="ml-2 bg-purple-600 px-2 py-0.5 rounded text-xs text-white">Kolom {{ activeExam.currentCol }} / 10</span></div>
                        </div>
                        <div class="text-3xl font-mono font-bold bg-white/10 px-5 py-2 rounded-xl backdrop-blur-sm border border-white/20" :class="{'text-red-400 animate-pulse': timer < 10}">{{ formatTime(timer) }}</div>
                    </div>
                    
                    <div class="flex-grow flex overflow-hidden">
                        
                        <div class="flex-grow flex flex-col overflow-hidden relative bg-gray-50">
                            <div class="flex-grow overflow-y-auto scroller p-6 md:p-10 relative flex flex-col">                                
                                <div v-if="activeExam.waitingNextCol" class="absolute inset-0 z-50 bg-slate-800/90 backdrop-blur-sm flex flex-col items-center justify-center text-white text-center rounded-xl">
                                    <i class="fas fa-lock text-5xl mb-4 text-yellow-400"></i>
                                    <h2 class="text-3xl font-bold mb-2">Kolom {{ activeExam.currentCol }} Selesai</h2>
                                    <p class="text-gray-300 mb-6">Mohon tunggu waktu habis untuk pindah ke Kolom selanjutnya.</p>
                                    <div class="text-4xl font-mono font-bold text-yellow-400">{{ formatTime(timer) }}</div>
                                </div>
                                <div v-if="activeExam.questions.length === 0 && !activeExam.waitingNextCol" class="flex flex-col items-center justify-center h-full p-10 text-center">
                                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                                    <h3 class="text-xl font-bold text-gray-700">Data Soal Tidak Ditemukan</h3>
                                    <p class="text-gray-500 mt-2">Sistem berhasil masuk ke ujian, namun tidak ada butir soal yang dimuat.</p>
                                    <button @click="examState='selection'" class="mt-6 bg-slate-800 text-white px-6 py-2 rounded-lg font-bold">Kembali ke Menu</button>
                                </div>
                                    <div v-if="activeExam.currentQuestion && activeExam.questions.length > 0 && !activeExam.waitingNextCol" class="max-w-4xl mx-auto w-full my-auto">                                    <div v-if="activeExam.currentSub.navType === 'missing_numbers'" class="bg-white p-4 rounded-xl shadow-sm border mb-6 text-center">
                                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-widest">Kunci Referensi</h4>
                                        <div class="kecermatan-grid">
                                            <div v-for="(char, i) in activeExam.colRefInput" :key="i" class="kecermatan-box bg-slate-50">
                                                <div class="kecermatan-char">{{ char }}</div><div class="kecermatan-label">{{ String.fromCharCode(65+i) }}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-white p-8 md:p-10 rounded-3xl shadow-sm border border-gray-200 text-center relative">
                                        <div class="flex justify-center mb-6">
                                            <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1.5 rounded-full font-extrabold shadow-sm uppercase tracking-wide">{{ activeExam.currentSub.navType === 'missing_numbers' ? 'Soal ' + (activeExam.qIndex + 1) : 'Soal ' + (activeExam.qIndex + 1) + ' dari ' + activeExam.questions.length }}</span>
                                        </div>
                                        <div class="exam-content font-bold text-gray-800 leading-relaxed mb-10" :class="activeExam.currentSub.navType==='missing_numbers'?'text-3xl tracking-widest font-mono':'text-xl text-left'" v-html="activeExam.currentQuestion.text"></div>

                                        <div v-if="activeExam.currentSub.navType === 'missing_numbers'" class="grid grid-cols-5 gap-4">
                                            <button v-for="opt in activeExam.currentQuestion.shuffledOptions" :key="opt.id" @click="selectAnswer(opt.id)" class="h-16 rounded-xl font-bold text-xl border-2 border-gray-200 hover:bg-blue-600 hover:text-white hover:border-blue-600 transition shadow-sm bg-gray-50 text-gray-700">{{ opt.label }}</button>
                                        </div>
                                        <div v-else class="space-y-4 text-left">
                                            <div v-for="opt in activeExam.currentQuestion.shuffledOptions" 
                                                :key="opt.id" 
                                                @click="selectAnswer(opt.id)" 
                                                class="border-2 rounded-2xl p-4 cursor-pointer flex items-center gap-4 transition relative overflow-hidden"
                                                :class="isSelected(opt.id) ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300 bg-white'">
                                                
                                                <div class="w-10 h-10 rounded-lg border-2 flex items-center justify-center font-bold text-lg shrink-0 transition"
                                                     :class="isSelected(opt.id) ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-50 text-gray-500 border-gray-200'">
                                                    {{ opt.label }}
                                                </div>

                                                <div class="exam-content text-gray-700 font-medium text-lg" v-html="opt.text"></div>

                                                <div v-if="isSelected(opt.id)" class="absolute top-2 right-2 text-blue-500 text-xl fade-in">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="activeExam.currentSub.navType !== 'missing_numbers'" class="bg-white p-4 md:p-5 border-t border-gray-200 flex flex-wrap justify-between items-center z-10 shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] gap-3">
                                <button @click="prevQuestion" :disabled="activeExam.qIndex === 0 || activeExam.currentSub.navType === 'linear'" class="px-4 py-2 md:px-6 md:py-3 rounded-xl font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 disabled:opacity-40 disabled:cursor-not-allowed text-sm md:text-base order-1">
                                    <i class="fas fa-chevron-left md:mr-2"></i> <span class="hidden md:inline">Sebelumnya</span>
                                </button>

                                <button @click="toggleFlag" 
                                        class="px-4 py-2 md:px-6 md:py-3 rounded-xl font-bold border-2 transition text-sm md:text-base order-2"
                                        :class="activeExam.flags[activeExam.currentQuestion?.id] ? 'bg-yellow-400 border-yellow-400 text-white shadow-md' : 'bg-yellow-50 border-yellow-200 text-yellow-600 hover:bg-yellow-100'">
                                    <i class="fas fa-flag mr-2"></i> Ragu-ragu
                                </button>

                                <div class="order-3">
                                    <button v-if="activeExam.qIndex < activeExam.questions.length - 1" @click="nextQuestion" class="px-6 py-2 md:px-8 md:py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 text-sm md:text-base">
                                        <span class="hidden md:inline">Selanjutnya</span> <i class="fas fa-chevron-right md:ml-2"></i>
                                    </button>
                                    <button v-else @click="finishSubTest(true)" class="px-6 py-2 md:px-8 md:py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 text-sm md:text-base">
                                        Selesai <i class="fas fa-check ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div v-if="activeExam.currentSub.navType !== 'missing_numbers'" class="w-72 bg-white border-l border-gray-200 flex flex-col shrink-0 z-20 hidden md:flex">
                            <div class="p-4 border-b font-bold text-gray-700 flex justify-between items-center bg-gray-50/50">
                                <span><i class="fas fa-th mr-2 text-blue-500"></i> Navigasi Soal</span>
                                <span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">{{ activeExam.questions.length }} Butir</span>
                            </div>
                            <div class="flex-grow overflow-y-auto scroller p-4">
                                <div class="grid grid-cols-5 gap-2 content-start">
                                    <button v-for="(q, idx) in activeExam.questions" :key="q.id" 
                                            @click="jumpToQuestion(idx)"
                                            :disabled="activeExam.currentSub.navType === 'linear'"
                                            class="h-10 rounded-lg text-sm font-bold border transition relative flex items-center justify-center overflow-hidden"
                                            :class="getPesertaNavClass(idx)">
                                        {{ idx + 1 }}
                                        
                                        <div v-if="activeExam.answers[q.id]" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow-sm z-20"></div>
                                        
                                        <div v-if="activeExam.flags[q.id]" class="absolute top-0.5 left-0.5 text-[8px] text-yellow-600 z-10">
                                            <i class="fas fa-flag"></i>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 border-t bg-gray-50 text-[10px] text-gray-500 space-y-2 shrink-0">
                                <div class="flex items-center"><span class="w-3 h-3 border bg-blue-600 rounded mr-2"></span> Sedang Dikerjakan</div>
                                <div class="flex items-center"><span class="w-3 h-3 border bg-green-50 text-green-700 border-green-400 rounded mr-2 relative"><div class="absolute -top-1 -right-1 w-1.5 h-1.5 bg-green-500 rounded-full"></div></span> Sudah Dijawab</div>
                                <div class="flex items-center"><span class="w-3 h-3 border bg-yellow-100 border-yellow-400 rounded mr-2"></span> Ragu-ragu</div> <div class="flex items-center"><span class="w-3 h-3 border bg-white rounded mr-2"></span> Belum Dijawab</div>
                            </div>
                        </div>

                    </div>
                </div>

                <div v-if="examState === 'finished'" class="flex-grow flex flex-col items-center justify-center fade-in p-4 overflow-y-auto">
                     <div class="bg-white p-8 rounded-[2rem] shadow-2xl text-center max-w-2xl w-full border border-gray-100 my-10">
                        <i class="fas fa-trophy text-6xl text-green-500 mb-6 animate-bounce"></i>
                        <h2 class="text-4xl font-extrabold mb-3 text-gray-800">Ujian Selesai!</h2>
                        <div class="text-5xl font-extrabold text-blue-600 my-6">{{ calculateTotalScore(finishedResult) }}</div>
                        <button @click="viewResultDetail(finishedResult)" class="mb-6 text-blue-600 font-bold hover:underline">Lihat Detail Grafik & Analisis</button>
                        <button @click="examState='selection'" class="w-full bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold hover:bg-black transition shadow-lg">Kembali ke Menu Utama</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div v-if="showResultModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4 backdrop-blur-sm fade-in">
         <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-[85vh] flex flex-col overflow-hidden relative">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 shrink-0">
                <h2 class="font-bold text-xl text-slate-800"><i class="fas fa-file-alt mr-2 text-blue-500"></i> Detail Hasil Ujian</h2>
                <button @click="showResultModal=false" class="text-gray-400 hover:text-red-500 font-bold text-2xl transition">&times;</button>
            </div>
            
            <div v-if="selectedResult" class="p-6 overflow-y-auto scroller flex-grow">
                <div class="grid grid-cols-2 gap-4 mb-6 bg-blue-50 p-4 rounded-xl border border-blue-100 relative overflow-hidden">                    
                    <div v-if="selectedResult.moduleName.includes('[LULUS]')" class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-6 py-1 transform rotate-45 translate-x-4 translate-y-2 shadow-sm">
                        LULUS
                    </div>
                    <div v-if="selectedResult.moduleName.includes('[TIDAK LULUS]')" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-6 py-1 transform rotate-45 translate-x-4 translate-y-2 shadow-sm">
                        GAGAL
                    </div>
                    <div><div class="text-xs text-gray-500 uppercase font-bold">Nama Peserta</div><div class="text-lg font-bold text-blue-900">{{ getParticipantName(selectedResult) }}</div></div>
                    <div class="text-right"><div class="text-xs text-gray-500 uppercase font-bold">Total Skor</div><div class="text-2xl font-extrabold text-blue-600">{{ calculateTotalScore(selectedResult) }}</div></div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase font-bold">Modul / Paket</div>
                        <div class="text-sm font-bold text-gray-700">
                            {{ getCleanModuleNameForDisplay(selectedResult.moduleName) }}

                            <span v-if="checkViolation(selectedResult.moduleName)" class="ml-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide shadow-sm animate-pulse">
                                <i class="fas fa-ban mr-1"></i> DITENDANG
                            </span>

                            <span v-if="checkWarning(selectedResult.moduleName) > 0" class="ml-2 bg-yellow-100 text-yellow-700 border border-yellow-300 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide">
                                <i class="fas fa-exclamation-circle mr-1"></i> {{ checkWarning(selectedResult.moduleName) }}x Warning
                            </span>

                            <span v-if="selectedResult.packageId" class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded ml-1 text-gray-600 font-bold uppercase">Pkg</span>
                        </div>
                    </div>
                    <div class="text-right"><div class="text-xs text-gray-500 uppercase font-bold">Waktu Selesai</div><div class="text-sm font-mono text-gray-600">{{ formatDateTime(selectedResult.endTime) }}</div></div>
                </div>

                <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">Rincian Per Sub Tes</h3>
                <div class="space-y-6">
                    <div v-for="(sub, idx) in selectedResult.subResults" :key="idx" class="border rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <span class="font-bold text-slate-700 text-lg">{{ sub.subName }}</span>
                                <span v-if="['admin', 'review'].includes(currentRole)" class="ml-2 text-xs font-mono text-pink-600 bg-pink-50 px-2 py-0.5 rounded border border-pink-200" title="Nama Internal (Admin)">
                                    <i class="fas fa-tag mr-1"></i>{{ sub.subNameInternal || getSubInternalName(sub.subId) }}
                                </span>
                            </div>
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg font-bold">{{ sub.score.toFixed(1) }}</span>
                        </div>
                        
                        <div v-if="['admin', 'review'].includes(currentRole) && sub.type !== 'missing_numbers' && sub.groupBreakdown && sub.groupBreakdown.length > 0" class="mt-2 ml-4 mb-4 bg-yellow-50 p-3 rounded border border-yellow-200 text-xs">
                            <h5 class="font-bold text-yellow-800 mb-2 uppercase border-b border-yellow-200 pb-1">Analisis Per Kelompok Soal</h5>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div v-for="(g, gi) in sub.groupBreakdown" :key="gi" class="flex justify-between items-center bg-white p-2 rounded border border-yellow-100">
                                    <span class="font-bold text-gray-700 truncate mr-2">{{ g.name }}</span>
                                    <div class="flex gap-3">                                        
                                        <span class="font-mono text-gray-500">{{ g.correctCount }} / {{ g.totalInGroup }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="sub.detail && sub.detail.length > 0 && sub.type === 'missing_numbers'" class="mt-4 bg-gray-50 p-4 rounded-lg border">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-4 text-center">Grafik Analisis Kecermatan (Per Kolom)</h4>
                            <div class="chart-wrapper">
                                <svg viewBox="0 0 400 300" class="chart-svg" preserveAspectRatio="none">
                                    <g v-for="n in 6" :key="n"><line x1="30" :y1="270 - ((n-1)*50)" x2="400" :y2="270 - ((n-1)*50)" class="grid-line" /><text x="25" :y="270 - ((n-1)*50) + 3" text-anchor="end" class="axis-text">{{ (n-1)*10 }}</text></g>
                                    <g v-for="(col, i) in sub.detail" :key="i" class="bar-group">
                                        <rect :x="30 + (i*37)" y="0" width="37" height="300" class="hit-area" />
                                        <rect :x="30 + (i*37) + 8" :y="270 - (col.correct * 5)" width="8" :height="col.correct * 5" class="bar-correct" />
                                        <rect :x="30 + (i*37) + 18" :y="270 - (col.wrong * 5)" width="8" :height="col.wrong * 5" class="bar-wrong" />
                                        <text :x="30 + (i*37) + 18" y="290" text-anchor="middle" class="axis-text" style="font-weight:bold">K{{i+1}}</text>
                                        
                                        <foreignObject :x="30 + (i*37)" y="0" width="100" height="300" style="pointer-events: none; overflow: visible;">
                                            <div xmlns="http://www.w3.org/1999/xhtml" class="tooltip-box absolute bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg z-50 transform -translate-x-1/2 -translate-y-full pointer-events-none whitespace-nowrap" :style="{top: (270 - (col.answered * 5) - 10) + 'px', left: '18px'}">
                                                <div class="font-bold border-b border-gray-600 mb-1 pb-1">Kolom {{i+1}}</div>
                                                <div class="text-green-400">Benar: {{col.correct}}</div>
                                                <div class="text-red-400">Salah: {{col.wrong}}</div>
                                                <div class="text-blue-400 font-bold mt-1">Total: {{col.answered}}</div>
                                                <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1 border-4 border-transparent border-t-slate-800"></div>
                                            </div>
                                        </foreignObject>
                                    </g>
                                    <polyline fill="none" stroke="#3b82f6" stroke-width="2" :points="sub.detail.map((c, i) => `${30 + (i*37) + 18},${270 - (c.answered * 5)}`).join(' ')" />
                                    <g v-for="(col, i) in sub.detail" :key="'dot'+i" class="dot-group pointer-events-none"><circle :cx="30 + (i*37) + 18" :cy="270 - (col.answered * 5)" r="3" class="dot-answered" /></g>
                                </svg>
                            </div>
                             <div class="flex justify-center gap-4 mt-4 text-xs font-bold text-gray-600">
                                <div class="flex items-center"><span class="w-3 h-3 bg-green-500 mr-2 rounded-sm opacity-80"></span>Benar</div>
                                <div class="flex items-center"><span class="w-3 h-3 bg-red-500 mr-2 rounded-sm opacity-80"></span>Salah</div>
                                <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 mr-2 rounded-full border-2 border-white"></span>Total (Garis)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, reactive, onMounted, nextTick } = Vue;

const app = createApp({
    setup() {
        // --- REACTIVE STATE DECLARATIONS ---
        const isLoggedIn = ref(false);
        const currentUser = ref({ id: '', username: '', role: '', groupId: null });
        const currentRole = ref('admin'); 
        const accounts = ref([]);
        const loginForm = reactive({ user: '', pass: '' });
        
        const groups = ref([]);
        const subTests = ref([]);
        const modules = ref([]);
        const results = ref([]);
        const examPackages = ref([]); 
        const userGroups = ref([]);

        const adminTab = ref('sub');        const newGroup = reactive({ name: '', type: 'normal' });
        const editingGroupId = ref(null);
        const selectedGroup = ref(null);
        const newQuestion = reactive({ text: '', explanation: '', options: [{text:'', isCorrect:false, weight:0}, {text:'', isCorrect:false, weight:0}] });
        const isEditing = ref(false);
        const editingIndex = ref(-1);
        const filterDate = reactive({ start: '', end: '' });

        const isEditingSub = ref(false);
        const editingSubId = ref(null);
        const newSub = reactive({ 
            nameInternal: '', 
            nameDisplay: '', 
            duration: 60, 
            navType: 'flexible', 
            type: 'normal', 
            selectedQuestions: [], // Legacy support
            columnsData: [], 
            // --- TAMBAHAN BARU ---
            questions: [],        // Penampung soal tanpa kelompok
            internalGroups: []    // Penampung kelompok soal
        });        
        // --- LOGIC BARU: INTERNAL GROUP & EDITOR SOAL ---
        const tempGroupName = ref('');
        const activeInternalGroupIdx = ref(-1); // -1 artinya "Tanpa Kelompok"
        
        // Fungsi Tambah Kelompok
        const addSubGroup = () => {
            if(!tempGroupName.value) return;
            newSub.internalGroups.push({ name: tempGroupName.value, questions: [] });
            tempGroupName.value = '';
        };

        // Fungsi Hapus Kelompok
        // --- GANTI FUNGSI removeSubGroup DENGAN INI ---

        const removeSubGroup = (idx) => {
            confirmDelete("Hapus Kelompok Soal?", "Soal di dalamnya akan pindah ke Default.").then((result) => {
                if (result.isConfirmed) {
                    const questionsToSave = newSub.internalGroups[idx].questions;
                    questionsToSave.forEach(q => { q.sourceGroupName = ''; });
                    newSub.questions.push(...questionsToSave);
                    
                    newSub.internalGroups.splice(idx, 1);
                    activeInternalGroupIdx.value = -1; 
                    
                    notifySuccess("Kelompok dihapus.");
                }
            });
        };

        // Variabel Editor Soal
        // --- LOGIC EDITOR SOAL (FIXED) ---
        
        // 1. Variabel Editor
        const isEditingQ = ref(false);
        const editingQIdx = ref(-1);
        const tempQContent = ref('');
        // Kita HAPUS tempCorrectIdx karena sekarang kuncinya ada di dalam properti isCorrect setiap opsi
        const tempOptions = ref([
            {text:'', isCorrect:false, weight:0}, 
            {text:'', isCorrect:false, weight:0}
        ]);

        // 2. Helper Update Konten (Input)
        const updateQ = (e) => tempQContent.value = e.target.innerHTML;
        const updateOpt = (idx, e) => tempOptions.value[idx].text = e.target.innerHTML;

        // 3. FUNGSI RESET EDITOR (YANG SERING BIKIN ERROR)
        

        // 4. FUNGSI SIMPAN SOAL (ADD/UPDATE)
        
        

        // 6. FUNGSI HAPUS SOAL
        const deleteQInSub = (idx) => {
            confirmDelete("Hapus butir soal ini?").then((result) => {
                if (result.isConfirmed) {
                    const targetList = activeInternalGroupIdx.value === -1 ? newSub.questions : newSub.internalGroups[activeInternalGroupIdx.value].questions;
                    targetList.splice(idx, 1);
                    notifySuccess("Soal berhasil dihapus.");
                }
            });
        };

        // Computed Property: Menentukan soal mana yang ditampilkan di list kanan
        const currentViewQuestions = computed(() => {
            if(activeInternalGroupIdx.value === -1) return newSub.questions;
            if(newSub.internalGroups[activeInternalGroupIdx.value]) {
                return newSub.internalGroups[activeInternalGroupIdx.value].questions;
            }
            return [];
        });
        
        // Helper Hitung Total Soal
        // --- UPDATE: Fungsi Hitung Soal (Support Data Raw Database) ---
        const countTotalSoal = (sub) => {
            // 1. Cek Data Utama dari Database (selectedQuestions)
            // Ini yang dipakai saat halaman baru di-refresh
            if (sub.selectedQuestions && Array.isArray(sub.selectedQuestions) && sub.selectedQuestions.length > 0) {
                return sub.selectedQuestions.length;
            }

            // 2. Fallback: Cek Data Editor (questions & internalGroups)
            // Ini dipakai jika selectedQuestions kosong (misal subtes baru dibuat tapi belum disimpan)
            let total = (sub.questions || []).length;
            if (sub.internalGroups && Array.isArray(sub.internalGroups)) {
                sub.internalGroups.forEach(g => total += (g.questions || []).length);
            }
            
            return total;
        };
        // --- FITUR BARU: Cek Kelengkapan Kunci Jawaban ---
        const checkQuestionKey = (q) => {
            // 1. Cek apakah opsi ada
            if (!q.options || q.options.length === 0) return false;

            // 2. Jika tipe Weighted (Bobot), cek apakah ada minimal 1 opsi dengan bobot > 0
            if (newSub.type === 'weighted') {
                return q.options.some(o => (parseInt(o.weight) || 0) > 0);
            }

            // 3. Jika tipe Normal, cek apakah ada minimal 1 opsi isCorrect = true
            return q.options.some(o => o.isCorrect === true || o.isCorrect === 1 || o.isCorrect === "1");
        };
        // Fungsi Trigger Upload Gambar (Diperbarui)
        // GANTI FUNGSI LAMA DENGAN INI
        const triggerUpload = (targetId) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                // Gunakan FormData untuk kirim ke API
                const formData = new FormData();
                formData.append('file', file);

                // Tampilkan Loading sementara (opsional)
                
                fetch('/api/admin/upload_image', { // <--- GANTI DISINI
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('ujian_token') }, // Tambah Header Token
                    body: formData
                })
                .then(data => {
                    if(data.status === 'success') {
                        // Masukkan URL gambar dari server
                        const imgHtml = `<img src="${data.url}" style="max-width: 100%; display: block; margin: 10px auto; border-radius: 5px;">`;
                        const el = document.getElementById(targetId);
                        el.focus();
                        document.execCommand('insertHTML', false, imgHtml);
                        el.dispatchEvent(new Event('input'));
                    } else {
                        alert("Upload Gagal: " + data.message);
                    }
                })
                .catch(err => alert("Terjadi kesalahan koneksi upload."));
            };
            input.click();
        };
        const expandedGroupId = ref(null);
        const activeMissingCol = ref(1);
        const tempMissingInputs = reactive(['','','','','']);
        const genCount = ref(20);

        const isEditingModule = ref(false);
        const editingModuleId = ref(null);
        // Tambahkan properti passingGrade dan subWeights
        const newModule = reactive({ 
            nameInternal: '', 
            nameDisplay: '', 
            passingGrade: 0,   // Nilai KKM
            subIds: [],        // Untuk urutan (Legacy compatibility)
            subWeights: {}     // Object: { 'sub_id_1': 45, 'sub_id_2': 55 }
        });        
        const isEditingPackage = ref(false);
        const editingPackageId = ref(null);
        const newPackage = reactive({ name: '', moduleIds: [], targetType: 'group', targetId: '', selectedUsers: [] });
        
        const isEditingAccount = ref(false);
        const editingAccountId = ref(null);
        const newAccount = reactive({ username: '', email: '', password: '', role: 'peserta', groupId: '', status: 'active' });
        const newUserGroup = reactive({ name: '' });

        const examState = ref('selection');
        const pesertaTab = ref('ujian');
        const availableExams = ref([]);
        const activeExam = reactive({ 
            moduleName: '', subIds: [], currentSubIndex: 0, currentSub: null, 
            questions: [], qIndex: 0, answers: {}, 
            flags: {}, 
            currentCol: 1, colRefInput: [], waitingNextCol: false, 
            resultsBuffer: [], startTime: null, packageId: null,
            currentQuestion: null,
            colResults: [],
            violationCount: 0 // <--- TAMBAHKAN INI (Counter Pelanggaran)
        });
        const timer = ref(0);
        let timerInterval = null;
        const finishedResult = ref(null);
        const showResultModal = ref(false);
        const selectedResult = ref(null);

        // --- REVIEWER STATE (FROM REVIEW FILE) ---
        const reviewTab = ref('history');
        const reviewState = ref('list');
        const reviewFilterGroup = ref('');
        const reviewSearch = ref('');
        const reviewSort = ref('date_desc');
        const selectedReviewUser = ref(null);
        const selectedReviewResult = ref(null);
        const reviewSubIndex = ref(0);
        const reviewQuestions = ref([]);
        const reviewQuestionIndex = ref(0);
        const reviewTotalSubs = ref(0);
        const reviewCurrentSub = ref({});

        // --- HELPER FUNCTIONS ---
        // GANTI FUNGSI generateId() DENGAN INI:
        const generateId = () => {
            // Menggunakan crypto API browser untuk ID yang benar-benar unik (UUID v4)
            if (crypto && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback jika browser sangat lama
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        };    
        const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        const formatDateTime = (ts) => ts ? new Date(ts).toLocaleString() : '-';
        // GANTI FUNGSI saveData DENGAN INI:
        // --- GANTI FUNGSI saveData LAMA DENGAN INI ---
        const saveData = (key, value) => {
                try { localStorage.setItem(key, JSON.stringify(value)); } catch(e) {}
                secureFetch('/api/admin/save_key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('ujian_token') },
                    body: JSON.stringify({ key: key, value: value })
            }).then(d => { 
                if(d.status!=='success') console.error(d.message); 
            });
        };
        
        const getSubInternalName = (id) => subTests.value.find(s => s.id === id)?.nameInternal || ''; 
        const getParticipantName = (res) => {
            if(res.participantId) {
                const user = accounts.value.find(a => a.id === res.participantId);
                if(user) return user.username; 
            }
            return res.participantName; 
        };
        const getGroupName = (id) => {
            if (!id) return '-'; // Cek jika ID kosong
            const group = userGroups.value.find(g => g.id === id);
            return group ? group.name : '-';
        };
        const getModuleName = (id) => { const m = modules.value.find(x => x.id === id); return m ? m.nameInternal : 'Unknown Module'; };
        const getSubName = (id) => subTests.value.find(s => s.id === id)?.nameInternal || 'Unknown';
        
        // --- REVIEW HELPERS ---
        const getParticipantGroup = (uid) => { const user = accounts.value.find(a => a.id === uid); return user ? getGroupName(user.groupId) : '-'; }
        const calculateDuration = (res) => res.subResults ? Math.ceil(res.subResults.length * 15) + ' Menit' : '-'; // Est
        const getCorrectCount = (res) => {
            // Main logic doesn't explicitly store correct/wrong counts in top level result, 
            // but we can estimate or show '-' if not available.
            return "-"; 
        }; 
        const getWrongCount = (res) => "-";

        const uploadImageToEditor = (event, type, index = null) => { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = (e) => { 
                const imgTag = `<img src="${e.target.result}" style="height:150px;" class="inline-img">`; 
                let editorId = type === 'questionText' ? 'editor-question' : (type === 'explanation' ? 'editor-explanation' : 'editor-opt-' + index); 
                const editor = document.getElementById(editorId); 
                if(editor) { 
                    editor.focus(); 
                    document.execCommand('insertHTML', false, imgTag) || (editor.innerHTML += imgTag); 
                    editor.dispatchEvent(new Event('input')); 
                } 
            }; 
            reader.readAsDataURL(file); 
            event.target.value = ''; 
        };

        

        const parseWordContent = (text) => { 
            const rawText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); 
            const parts = rawText.split(/SOAL\s*,\s*/i).filter(p => p.trim().length > 0); 
            let count = 0; 
            parts.forEach(part => { 
                let explanation = ''; 
                const pembSplit = part.split(/PEMBAHASAN\s*,\s*/i); 
                let contentWithoutPemb = part; 
                if (pembSplit.length > 1) { 
                    const pembMatch = part.match(/PEMBAHASAN\s*,\s*(.*?)(\n|$)/i); 
                    if (pembMatch) { explanation = pembMatch[1].trim(); contentWithoutPemb = part.replace(pembMatch[0], '\n'); } 
                    else { explanation = pembSplit[1].trim(); contentWithoutPemb = pembSplit[0]; } 
                } 
                const options = []; 
                const lines = contentWithoutPemb.split('\n').map(l => l.trim()).filter(l => l); 
                let questionTextArr = []; 
                lines.forEach(line => { 
                    const optMatch = line.match(/^([A-Z])\s*,\s*(.*?)(?:,\s*(\d+))?$/i); 
                    if (optMatch) { 
                        const label = optMatch[1].toUpperCase(); 
                        const text = optMatch[2].trim(); 
                        const keyVal = optMatch[3] ? parseInt(optMatch[3]) : 0; 
                        let isCorrect = false; let weight = 0; 
                        if (selectedGroup.value.type === 'normal') isCorrect = (keyVal === 1); else weight = keyVal; 
                        options.push({ id: generateId(), text: text, isCorrect: isCorrect, weight: weight, label: label }); 
                    } else { 
                        if (!line.match(/^PEMBAHASAN/i)) questionTextArr.push(line); 
                    } 
                }); 
                const questionText = questionTextArr.join('<br>'); 
                if (options.length > 0 && questionText) { 
                    if (!selectedGroup.value.questions) selectedGroup.value.questions = []; 
                    selectedGroup.value.questions.push({ id: generateId(), text: questionText, explanation: explanation, options: options }); 
                    count++; 
                } 
            }); 
            if (count > 0) { saveData('groups', groups.value); alert(`Berhasil mengimpor ${count} soal!`); } else { alert("Gagal mengimpor. Pastikan format sesuai."); } 
        };

        
        // --- UPDATE 1: FITUR AUTO LOGIN & LOAD DATA ---
        
        // Update fungsi handleLogin
        // --- UPDATE: FUNGSI LOGIN (TAMPILAN TENGAH) ---
        const handleLogin = () => {
            // Loading di Tengah
            Swal.fire({
                title: 'Memproses...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => { Swal.showLoading() }
            });

            fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: loginForm.user, pass: loginForm.pass })
            })
            .then(data => {
                if (data.status === 'success') {
                    Swal.close(); 
                    const user = data.data;
                    
                    if(user.token) localStorage.setItem('ujian_token', user.token);
                    else return notifyError("Token error.");
                    localStorage.setItem('ujian_user', JSON.stringify(user));
                    
                    isLoggedIn.value = true;
                    currentUser.value = user;
                    currentRole.value = user.role;
                    loadData(); 

                    // Toast Selamat Datang (Kanan Bawah juga biar konsisten)
                    notifySuccess(`Selamat Datang, ${user.username}!`);

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Gagal',
                        text: 'Username atau Password Salah',
                        confirmButtonText: 'Coba Lagi',
                        confirmButtonColor: '#d33'
                    });
                }
            })
            .catch(err => {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Koneksi ke server gagal.' });
            });
        };
        // --- 1. FUNGSI BANTUAN FETCH AMAN (NODE.JS VERSION) ---
        const secureFetch = async (url, options = {}) => {
            const token = localStorage.getItem('ujian_token');
            
            // Default Headers
            const headers = { 
                ...options.headers 
            };

            // Jika BUKAN upload file (FormData), set Content-Type JSON
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }

            if (token) headers['Authorization'] = 'Bearer ' + token;

            try {
                const response = await fetch(url, { ...options, headers });
                
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('ujian_token'); 
                    localStorage.removeItem('ujian_user');
                    isLoggedIn.value = false; 
                    if(!window.location.pathname.includes('login')) window.location.reload();
                    throw new Error("Sesi habis / Unauthorized");
                }
                
                return await response.json();
            } catch (e) {
                console.error("Fetch Error:", e);
                return { status: 'error', message: e.message };
            }
        };

        // --- 2. FUNGSI LOAD DATA (VERSI BARU) ---
        const loadData = () => {
            const loadingEl = document.getElementById('loading');
            if(loadingEl) loadingEl.style.display = 'flex';
            
            // PERUBAHAN DISINI: Routing dipisah
            const endpoint = currentRole.value === 'peserta' ? '/api/user/dashboard' : '/api/admin/load_all';

            secureFetch(endpoint).then(response => {
                if(response.status === 'success') {
                    const data = response.data;
                    if (currentRole.value === 'peserta') {
                        availableExams.value = data.exams || [];
                        if(data.user) {
                            currentUser.value = data.user;
                            if (!currentUser.value.groupId && currentUser.value.group_id) {
                                currentUser.value.groupId = currentUser.value.group_id;
                            }
                        }
                        userGroups.value = data.userGroups || []; 
                        subTests.value = data.subTests || []; 
                        results.value = data.results || [];
                    } 
                    else {
                        // Admin Data
                        groups.value = data.groups || [];
                        subTests.value = data.subTests || [];
                        modules.value = data.modules || [];
                        results.value = data.results || [];
                        examPackages.value = data.examPackages || [];
                        userGroups.value = data.userGroups || [];
                        accounts.value = data.accounts || [];
                    }
                }
            }).finally(() => { setTimeout(() => { if(loadingEl) loadingEl.style.display = 'none'; }, 500); });
        };

        // --- UPDATE: onMounted (Auto Load Data & Restore Edit State) ---
        onMounted(() => {
            // 1. Matikan loading screen awal (jika ada sisa)
            setTimeout(() => { 
                const loadingEl = document.getElementById('loading');
                if(loadingEl) loadingEl.style.display = 'none'; 
            }, 500);

            // 2. Cek Sesi Login di LocalStorage
            const savedToken = localStorage.getItem('ujian_token');
            const savedUser = localStorage.getItem('ujian_user');

            if (savedToken && savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    currentUser.value = user;
                    currentRole.value = user.role;
                    isLoggedIn.value = true;
                    
                    // PANGGIL FUNGSI INI SAJA (Sudah otomatis memilih jalur yang benar)
                    loadData(); 

                } catch (e) {
                    console.error("Sesi rusak", e);
                    handleLogout(); 
                }
            }
        });
        // --- ADMIN FUNCTIONS ---
        const handleGroupSave = () => { if (!newGroup.name) return alert("Nama Kelompok harus diisi"); if (editingGroupId.value) { const groupIndex = groups.value.findIndex(g => g.id === editingGroupId.value); if (groupIndex !== -1) { const oldName = groups.value[groupIndex].name; groups.value[groupIndex].name = newGroup.name; subTests.value.forEach(sub => { if (sub.selectedQuestions) sub.selectedQuestions.forEach(sq => { if(sq.sourceGroupName === oldName) sq.sourceGroupName = newGroup.name; }); }); if(subTests.value.some(s=>s)) saveData('subTests', subTests.value); } } else { groups.value.push({id: generateId(), name: newGroup.name, type: newGroup.type, questions: []}); } saveData('groups', groups.value); cancelEditGroup(); };
        const editGroupBtn = (g) => { newGroup.name = g.name; newGroup.type = g.type; editingGroupId.value = g.id; };
        const cancelEditGroup = () => { newGroup.name = ''; newGroup.type = 'normal'; editingGroupId.value = null; };
        const selectGroup = (g) => { selectedGroup.value = g; cancelEdit(); };
        const deleteGroup = (id) => { if(confirm("Hapus kelompok ini?")) { groups.value = groups.value.filter(g=>g.id!==id); saveData('groups', groups.value); if(selectedGroup.value?.id === id) selectedGroup.value = null; cancelEditGroup(); } };
        const resetQuestionEditor = () => { const elQ = document.getElementById('editor-question'); if (elQ) elQ.innerHTML = ''; const elExp = document.getElementById('editor-explanation'); if (elExp) elExp.innerHTML = ''; newQuestion.options.forEach((_, idx) => { const el = document.getElementById('editor-opt-'+idx); if(el) el.innerHTML = ''; }); };
        
        const saveQuestion = () => { 
            const questionData = { 
            text: newQuestion.text, 
            explanation: newQuestion.explanation, 
            // PERBAIKAN: Pastikan setiap opsi diberi ID sebelum disimpan
            options: newQuestion.options.map(o => ({...o, id: o.id || generateId()})) 
            };  
            if (!selectedGroup.value.questions) selectedGroup.value.questions = [];
            if (isEditing.value && editingIndex.value !== -1) {
                const existingQuestion = selectedGroup.value.questions[editingIndex.value];
                Object.assign(existingQuestion, questionData); 
                subTests.value.forEach(sub => {
                    if (sub.questions && Array.isArray(sub.questions)) { const foundQ = sub.questions.find(q => q.id === existingQuestion.id); if (foundQ) Object.assign(foundQ, questionData); }
                    if (sub.selectedQuestions && Array.isArray(sub.selectedQuestions)) { const foundSQ = sub.selectedQuestions.find(q => q.id === existingQuestion.id); if (foundSQ) Object.assign(foundSQ, questionData); }
                });
                saveData('subTests', subTests.value);
            } else { selectedGroup.value.questions.push({ id: generateId(), ...questionData }); }
            saveData('groups', groups.value); cancelEdit(); 
        };

        const updateContent = (e,t,i) => { if(t==='text') newQuestion.text=e.target.innerHTML; else if(t==='option') newQuestion.options[i].text=e.target.innerHTML; else newQuestion.explanation=e.target.innerHTML; };
        const addOption = () => newQuestion.options.push({text:'',isCorrect:false,weight:0});
        const removeOption = (i) => newQuestion.options.splice(i,1);
        
        const editQuestion = (i) => { 
            const q = selectedGroup.value.questions[i]; newQuestion.text = q.text; newQuestion.explanation = q.explanation; newQuestion.options = JSON.parse(JSON.stringify(q.options)); 
            isEditing.value = true; editingIndex.value = i; 
            nextTick(() => { 
                const elQ = document.getElementById('editor-question'); if(elQ) elQ.innerHTML = newQuestion.text; 
                const elExp = document.getElementById('editor-explanation'); if(elExp) elExp.innerHTML = newQuestion.explanation; 
                newQuestion.options.forEach((opt, idx) => { const el = document.getElementById('editor-opt-'+idx); if(el) el.innerHTML = opt.text; }); 
            }); 
        };

        const cancelEdit = () => { isEditing.value = false; editingIndex.value = -1; newQuestion.text = ''; newQuestion.explanation=''; newQuestion.options=[{text:'',isCorrect:false,weight:0},{text:'',isCorrect:false,weight:0}]; resetQuestionEditor(); };
        const deleteQuestion = (i) => { selectedGroup.value.questions.splice(i, 1); saveData('groups', groups.value); cancelEdit(); };
        const filteredGroups = computed(() => groups.value.filter(g => g.type === newSub.type).map(g => ({ ...g, questions: Array.isArray(g.questions) ? g.questions : [] })));
        // --- TAMBAHAN WAJIB AGAR TABEL MUNCUL ---
        // --- UPDATE 1: currentMissingQuestions (Gunakan == bukan ===) ---
        const currentMissingQuestions = computed(() => {
            // Cek apakah ada data soal
            if (!newSub.selectedQuestions || !Array.isArray(newSub.selectedQuestions)) return [];
            
            // Filter: Gunakan == agar bisa membaca string "1" maupun angka 1
            return newSub.selectedQuestions.filter(q => q.columnId == activeMissingCol.value);
        });

        // Fungsi Hapus Khusus Kecermatan
        const deleteMissing = (indexDiTabel) => {
            // Ambil ID soal asli berdasarkan data yang tampil
            const soalYgDihapus = currentMissingQuestions.value[indexDiTabel];
            if(soalYgDihapus) {
                // Hapus dari array utama (newSub.selectedQuestions)
                newSub.selectedQuestions = newSub.selectedQuestions.filter(q => q.id !== soalYgDihapus.id);
            }
        };
        const toggleGroupExpand = (gid) => expandedGroupId.value = expandedGroupId.value === gid ? null : gid;
        
        const isQuestionSelected = (qid) => { if (!newSub.selectedQuestions || !Array.isArray(newSub.selectedQuestions)) return false; return newSub.selectedQuestions.some(q => q.id === qid); };
        const toggleQuestionSelection = (q, gName) => { if (!newSub.selectedQuestions || !Array.isArray(newSub.selectedQuestions)) newSub.selectedQuestions = []; const idx = newSub.selectedQuestions.findIndex(sq => sq.id === q.id); if(idx === -1) newSub.selectedQuestions.push({...q, groupType: newSub.type, sourceGroupName: gName}); else newSub.selectedQuestions.splice(idx, 1); };
        
        const ensureColumnsExist = () => { if (!newSub.columnsData || !Array.isArray(newSub.columnsData)) newSub.columnsData = []; for(let i=0; i<10; i++) { if(!newSub.columnsData[i]) newSub.columnsData[i] = { id: i+1, inputs: ['','','','',''] }; } };
        // --- UPDATE 2: getQuestionsForCol (Gunakan ==) ---
        const getQuestionsForCol = (colId) => { 
            if (!newSub.selectedQuestions || !Array.isArray(newSub.selectedQuestions)) return []; 
            // Ubah === menjadi ==
            return newSub.selectedQuestions.filter(q => q.columnId == colId && q.type === 'missing_generated'); 
        };
        const getCurrentColInputs = () => tempMissingInputs;
        const getMissingQuestionCount = (colId) => getQuestionsForCol(colId).length;
        // --- UPDATE 3: clearMissingCol (Gunakan !=) ---
        const clearMissingCol = (colId) => { 
            if (newSub.selectedQuestions) {
                // Ubah !== menjadi !=
                newSub.selectedQuestions = newSub.selectedQuestions.filter(q => q.columnId != colId); 
            }
        };
        const generateMissingQuestions = () => { ensureColumnsExist(); newSub.columnsData[activeMissingCol.value-1].inputs = [...tempMissingInputs]; const inputs = tempMissingInputs; if(inputs.some(val => !val || val.trim() === '')) return alert("Isi 5 karakter A-E!"); if (!newSub.selectedQuestions) newSub.selectedQuestions = []; for(let i=0; i<genCount.value; i++) { const missingIdx = Math.floor(Math.random() * 5); const questionTextArr = inputs.filter((_, idx) => idx !== missingIdx); const shuffledText = [...questionTextArr].sort(() => Math.random() - 0.5).join('   '); const options = inputs.map((val, idx) => ({ id: generateId(), label: String.fromCharCode(65+idx), isCorrect: idx === missingIdx, text: val })); newSub.selectedQuestions.push({ id: generateId(), type: 'missing_generated', columnId: activeMissingCol.value, text: shuffledText, missingChar: inputs[missingIdx], correctLabel: String.fromCharCode(65 + missingIdx), options: options }); } };
      // --- PERBAIKAN FINAL: saveSubTest (Aman untuk Kecermatan) ---
        // --- GANTI FUNGSI saveSubTest LAMA DENGAN INI ---
        const saveSubTest = () => { 
            if(!newSub.nameInternal) return Swal.fire('Gagal', "Nama sub tes wajib diisi", 'warning'); 
            if (newSub.navType === 'missing_numbers') {
                ensureColumnsExist(); 
                if (!newSub.selectedQuestions || newSub.selectedQuestions.length === 0) return Swal.fire('Info', "Data soal Kecermatan kosong! Silahkan klik GENERATE dulu.", 'info');
            } else {
                let allQuestionsToSave = [];
                if (newSub.questions) allQuestionsToSave = [...allQuestionsToSave, ...newSub.questions.map(q => ({...q, sourceGroupName: ''}))];
                if (newSub.internalGroups) newSub.internalGroups.forEach(grp => { if(grp.questions) allQuestionsToSave = [...allQuestionsToSave, ...grp.questions.map(q => ({...q, sourceGroupName: grp.name}))]; });
                newSub.selectedQuestions = allQuestionsToSave;
            }
            const subData = { id: isEditingSub.value ? editingSubId.value : generateId(), ...newSub }; 
            const loadingEl = document.getElementById('loading'); if(loadingEl) loadingEl.style.display = 'flex';

            secureFetch('/api/admin/save_subtest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('ujian_token') },
                body: JSON.stringify({ data: subData })
            }).then(data => {
                if(data.status === 'success') {
                    if(isEditingSub.value) { const idx = subTests.value.findIndex(s=>s.id===editingSubId.value); if(idx !== -1) subTests.value[idx] = subData; } else { subTests.value.push(subData); }
                    notifySuccess("Sub Tes Berhasil Disimpan!");
                    cancelEditSub(); 
                } else notifyError(data.message);
            }).finally(() => { if(loadingEl) loadingEl.style.display = 'none'; });
        };

        const deleteSub = (id) => { 
            confirmDelete("Hapus Sub Tes ini?", "Data akan hilang dari semua Modul.").then((result) => {
                if (result.isConfirmed) {
                    // PERBAIKAN: Panggil API delete_subtest
                    secureFetch('/api/admin/delete_subtest', {
                        method: 'POST',
                        body: JSON.stringify({ id: id })
                    }).then(res => {
                        if(res.status === 'success') {
                            // Update UI
                            subTests.value = subTests.value.filter(s => s.id !== id);
                            modules.value.forEach(m => { 
                                if (m.subIds) m.subIds = m.subIds.filter(sid => sid !== id);
                                if (m.subWeights) m.subWeights = m.subWeights.filter(w => w.id !== id);
                            });
                            // Simpan perubahan modul (karena referensi ID hilang)
                            secureFetch('/api/admin/save_key', {
                                method: 'POST',
                                body: JSON.stringify({ key: 'modules', value: modules.value })
                            });
                            notifySuccess("Berhasil dihapus.");
                        } else {
                            notifyError(res.message);
                        }
                    });
                }
            });
        };
        // --- UPDATE: editSub (Simpan ID ke LocalStorage) ---
        // --- PERBAIKAN FINAL: editSub (Restore Editor Kecermatan Sempurna) ---
        const editSub = (sub) => { 
            console.log("Editing Subtes:", sub.nameInternal, sub.navType);

            // 1. Copy data dasar
            Object.assign(newSub, JSON.parse(JSON.stringify(sub))); 
            
            // 2. LOGIC KHUSUS KECERMATAN
            if (newSub.navType === 'missing_numbers') {
                // A. Pastikan selectedQuestions dimuat agar Tabel Preview muncul
                newSub.selectedQuestions = sub.selectedQuestions ? JSON.parse(JSON.stringify(sub.selectedQuestions)) : [];
                
                // B. Pastikan Data Kolom (A-E) dimuat
                ensureColumnsExist(); 
                if(sub.columnsData && sub.columnsData.length > 0) {
                    newSub.columnsData = JSON.parse(JSON.stringify(sub.columnsData));
                }

                // C. ISI ULANG KOTAK INPUT (PENTING!)
                // Kita ambil data dari Kolom 1 (default view) dan masukkan ke tempMissingInputs
                // Karena tempMissingInputs adalah reactive array, kita tidak bisa replace (=), harus update isinya.
                if(newSub.columnsData[0] && newSub.columnsData[0].inputs) {
                    // Reset array dulu
                    tempMissingInputs.splice(0, tempMissingInputs.length);
                    // Masukkan data baru
                    newSub.columnsData[0].inputs.forEach(val => tempMissingInputs.push(val));
                }

                // D. Set view ke Kolom 1
                activeMissingCol.value = 1; 

            } else {
                // --- LOGIC NORMAL (Sama seperti sebelumnya) ---
                newSub.questions = [];        
                newSub.internalGroups = [];   
                newSub.selectedQuestions = []; 

                if (sub.selectedQuestions && Array.isArray(sub.selectedQuestions)) {
                    sub.selectedQuestions.forEach(q => {
                        if(q.options) q.options.forEach((o,i) => { if(!o.id) o.id = generateId()+'_'+i; });
                        if (q.sourceGroupName && q.sourceGroupName.trim() !== '') {
                            let grp = newSub.internalGroups.find(g => g.name === q.sourceGroupName);
                            if (!grp) { grp = { name: q.sourceGroupName, questions: [] }; newSub.internalGroups.push(grp); }
                            grp.questions.push(q);
                        } else {
                            newSub.questions.push(q);
                        }
                    });
                }
                activeInternalGroupIdx.value = -1;
            }

            // 3. Set State Edit
            isEditingSub.value = true; 
            editingSubId.value = sub.id; 
            localStorage.setItem('last_edited_sub_id', sub.id);
        };

        // --- UPDATE: cancelEditSub (Hapus ID dari LocalStorage) ---
        const cancelEditSub = () => {
            isEditingSub.value = false;
            editingSubId.value = null;

            newSub.nameInternal = '';
            newSub.nameDisplay = '';
            newSub.duration = 60;
            newSub.navType = 'flexible';
            newSub.type = 'normal';

            newSub.questions = [];        
            newSub.internalGroups = [];   
            newSub.selectedQuestions = []; 
            newSub.columnsData = [];

            activeMissingCol.value = 1;
            activeInternalGroupIdx.value = -1;

            // --- TAMBAHAN BARU: HAPUS STATE ---
            localStorage.removeItem('last_edited_sub_id'); // Hapus ID karena sudah selesai edit
        };
        const saveModule = () => { 
            if(!newModule.nameInternal || newModule.subIds.length === 0) return Swal.fire('Perhatian', 'Data tidak lengkap', 'warning');
            
            // Validasi Total Bobot (Optional: Warning saja jika tidak 100%)
            const totalWeight = newModule.subIds.reduce((sum, sid) => sum + (newModule.subWeights[sid] || 0), 0);
            
            // Susun Data untuk API
            const subDetailsArray = newModule.subIds.map(sid => ({
                id: sid,
                weight: newModule.subWeights[sid] || 0
            }));

            const modData = { 
                id: isEditingModule.value ? editingModuleId.value : generateId(), 
                nameInternal: newModule.nameInternal, 
                nameDisplay: newModule.nameDisplay || newModule.nameInternal, 
                passingGrade: newModule.passingGrade, // Simpan KKM
                subIds: [...newModule.subIds], // Tetap kirim array ID untuk frontend lokal
                subDetails: subDetailsArray    // Kirim detail bobot ke API
            }; 
            
            if(isEditingModule.value) {
                // Update local state (pastikan format subWeights konsisten dengan load_all)
                modData.subWeights = subDetailsArray; 
                modules.value[modules.value.findIndex(m => m.id === editingModuleId.value)] = modData; 
            } else { 
                modData.subWeights = subDetailsArray;
                modules.value.push(modData); 
            } 
            
            saveData('modules', modules.value); 
            
            if (totalWeight !== 100 && totalWeight !== 0) {
                Swal.fire('Info', `Modul tersimpan, namun total bobot adalah ${totalWeight}% (Bukan 100%). Pastikan ini disengaja.`, 'info');
            } else {
                notifySuccess("Modul Tersimpan");
            }
            cancelEditModule(); 
        };
        const deleteModule = (id) => {
            confirmDelete("Hapus Modul ini?").then((result) => {
                if (result.isConfirmed) {
                    modules.value = modules.value.filter(m => m.id !== id);
                    
                    // Bersihkan referensi di paket
                    examPackages.value.forEach(pkg => { 
                        if(pkg.moduleIds && Array.isArray(pkg.moduleIds)) { 
                            pkg.moduleIds = pkg.moduleIds.filter(mid => mid !== id); 
                        } 
                    });
                    
                    saveData('modules', modules.value); 
                    saveData('examPackages', examPackages.value);
                    
                    if(isEditingModule.value && editingModuleId.value === id) cancelEditModule();
                    notifySuccess("Modul dihapus.");
                }
            });
        };
        
        const editModule = (mod) => { 
            newModule.nameInternal = mod.nameInternal; 
            newModule.nameDisplay = mod.nameDisplay || mod.nameInternal; 
            newModule.passingGrade = mod.passingGrade || 0; // Load KKM
            newModule.subIds = [...mod.subIds]; 
            
            // Load Bobot
            newModule.subWeights = {};
            if (mod.subWeights && Array.isArray(mod.subWeights)) {
                mod.subWeights.forEach(item => {
                    newModule.subWeights[item.id] = item.weight;
                });
            } else {
                // Fallback jika data lama (set rata)
                mod.subIds.forEach(sid => newModule.subWeights[sid] = 0);
            }

            isEditingModule.value = true; 
            editingModuleId.value = mod.id; 
        };
        
        const cancelEditModule = () => { 
            isEditingModule.value = false; 
            editingModuleId.value = null; 
            newModule.nameInternal = ''; 
            newModule.nameDisplay = ''; 
            newModule.subIds = []; 
        };
        
        // Ganti const addToModule = ... dengan ini:

        const addToModule = (s) => {
            if(!s.id) return alert("Subtes Error");
            newModule.subIds.push(s.id);
            newModule.subWeights[s.id] = 0; // Default bobot 0 saat ditambah
        };
        const removeFromModule = (i) => {
            const idToRemove = newModule.subIds[i];
            delete newModule.subWeights[idToRemove];
            newModule.subIds.splice(i,1);
        };
        const savePackage = () => { 
            if (!newPackage.name) return Swal.fire('Info', "Isi Nama Paket", 'info'); 
            const pkgData = { 
                id: isEditingPackage.value ? editingPackageId.value : generateId(), 
                name: newPackage.name, 
                moduleIds: [...newPackage.moduleIds], 
                targetType: newPackage.targetType, 
                targetId: newPackage.targetType === 'group' ? newPackage.targetId : null, 
                selectedUsers: newPackage.targetType === 'user' ? [...newPackage.selectedUsers] : [] 
            }; 
            if (isEditingPackage.value) { const idx = examPackages.value.findIndex(p => p.id === editingPackageId.value); if(idx !== -1) examPackages.value[idx] = pkgData; } else { examPackages.value.push(pkgData); } 
            
            saveData('examPackages', examPackages.value); 
            notifySuccess("Paket Ujian Disimpan"); // TOAST
            cancelEditPackage(); 
        };
        const deletePackage = (id) => { 
            confirmDelete("Hapus Paket Ujian ini?").then((result) => {
                if (result.isConfirmed) {
                    examPackages.value = examPackages.value.filter(p => p.id !== id); 
                    saveData('examPackages', examPackages.value); 
                    
                    if(isEditingPackage.value && editingPackageId.value === id) cancelEditPackage(); 
                    notifySuccess("Paket dihapus.");
                }
            });
        };
        const editPackage = (pkg) => { newPackage.name = pkg.name || ''; newPackage.moduleIds = pkg.moduleIds || (pkg.moduleId ? [pkg.moduleId] : []); newPackage.targetType = pkg.targetType; newPackage.targetId = pkg.targetId || ''; newPackage.selectedUsers = pkg.selectedUsers || []; isEditingPackage.value = true; editingPackageId.value = pkg.id; };
        const cancelEditPackage = () => { isEditingPackage.value = false; editingPackageId.value = null; newPackage.name = ''; newPackage.moduleIds = []; newPackage.targetType = 'group'; newPackage.targetId = ''; newPackage.selectedUsers = []; };
        const removeUserFromPackageForm = (userId) => { newPackage.selectedUsers = newPackage.selectedUsers.filter(id => id !== userId); };
        
        const createGroupUser = () => { if(newUserGroup.name){ userGroups.value.push({id:generateId(), name:newUserGroup.name}); saveData('userGroups',userGroups.value); newUserGroup.name=''; }};
        const deleteGroupUser = (id) => { 
            confirmDelete("Hapus Grup Peserta ini?").then((result) => {
                if (result.isConfirmed) {
                    userGroups.value = userGroups.value.filter(g => g.id !== id);
                    
                    // Reset target paket
                    examPackages.value.forEach(pkg => { 
                        if(pkg.targetType === 'group' && pkg.targetId === id) { pkg.targetId = ''; } 
                    });
                    
                    saveData('userGroups',userGroups.value); 
                    saveData('examPackages', examPackages.value);
                    
                    notifySuccess("Grup dihapus.");
                }
            });
        };
        const saveAccount = () => { 
            const accData = { id: isEditingAccount.value ? editingAccountId.value : generateId(), ...newAccount }; 
            if (isEditingAccount.value) accounts.value[accounts.value.findIndex(a=>a.id===editingAccountId.value)] = accData; 
            else accounts.value.push(accData); 
            
            saveData('accounts', accounts.value); 
            notifySuccess("Data Akun Tersimpan"); // TOAST
            cancelEditAccount(); 
        };
        const deleteAccount = (id) => { 
            confirmDelete("Hapus Akun Pengguna ini?").then((result) => {
                if (result.isConfirmed) {
                    accounts.value = accounts.value.filter(a => a.id !== id); 
                    
                    // Bersihkan paket user spesifik
                    examPackages.value.forEach(pkg => { 
                        if(pkg.targetType === 'user' && pkg.selectedUsers) { 
                            pkg.selectedUsers = pkg.selectedUsers.filter(uid => uid !== id); 
                        } 
                    });
                    
                    saveData('accounts', accounts.value); 
                    saveData('examPackages', examPackages.value);
                    
                    notifySuccess("Akun dihapus.");
                }
            });
        };
        const editAccount = (acc) => { Object.assign(newAccount, acc); isEditingAccount.value = true; editingAccountId.value = acc.id; };
        const cancelEditAccount = () => { isEditingAccount.value = false; newAccount.username=''; newAccount.email=''; newAccount.password=''; newAccount.role='peserta'; };
        
        const resetResultData = () => {
            confirmDelete("Reset SEMUA Riwayat Ujian?", "Tindakan ini tidak bisa dibatalkan.").then((result) => {
                if (result.isConfirmed) {
                    results.value = []; 
                    saveData('results', []); 
                    notifySuccess("Riwayat ujian berhasil direset.");
                }
            });
        };

        const calculateAvailableExams = () => { if (currentUser.value.role !== 'peserta') return; availableExams.value = examPackages.value.map(pkg => { if(pkg.targetType==='group' && pkg.targetId!==currentUser.value.groupId) return []; if(pkg.targetType==='user' && !pkg.selectedUsers.includes(currentUser.value.id)) return []; return pkg.moduleIds.map(mid => { const mod = modules.value.find(m => m.id === mid); return mod ? { uniqueId: pkg.id+'_'+mod.id, packageId: pkg.id, packageName: pkg.name, module: mod } : null; }).filter(Boolean); }).flat(); };
        
        const myResults = computed(() => { return results.value.filter(r => r.participantId === currentUser.value.id || (!r.participantId && r.participantName === currentUser.value.username)).sort((a, b) => b.endTime - a.endTime); });
        const filteredResults = computed(() => { let temp = [...results.value]; if (filterDate.start) { const s = new Date(filterDate.start).setHours(0,0,0,0); temp = temp.filter(r => new Date(r.endTime || r.timestamp).setHours(0,0,0,0) >= s); } if (filterDate.end) { const e = new Date(filterDate.end).setHours(23,59,59,999); temp = temp.filter(r => new Date(r.endTime || r.timestamp).setHours(0,0,0,0) <= e); } return temp.sort((a, b) => (b.endTime || b.timestamp) - (a.endTime || a.timestamp)); });
        // --- PERBAIKAN FUNGSI startExam ---
        const startExam = (modId, pkgId) => { 
            // 1. Cari Modul
            let mod = null;
            const examItem = availableExams.value.find(e => e.module.id === modId && e.packageId === pkgId);
            if (examItem) {
                mod = examItem.module;
            } else {
                mod = modules.value.find(m => m.id === modId);
            }

            if (!mod) {
                alert("Error: Data Modul tidak ditemukan. Silahkan refresh halaman.");
                return;
            }

            // 2. Set State Ujian
            activeExam.moduleName = mod.nameDisplay; 
            activeExam.subIds = [...mod.subIds]; 
            // Ambil Mapping Bobot dari Modul
            activeExam.subWeights = {};
            if (mod.subWeights && Array.isArray(mod.subWeights)) {
                mod.subWeights.forEach(item => activeExam.subWeights[item.id] = item.weight);
            }
            activeExam.passingGrade = mod.passingGrade || 0; // Ambil KKM
            // -------------------------

            activeExam.currentSubIndex = 0; 
            activeExam.resultsBuffer = []; 
            activeExam.packageId = pkgId; 
            activeExam.startTime = Date.now(); 
            activeExam.violationCount = 0; 
            
            loadSubTest(activeExam.subIds[0]); 
            examState.value = 'running'; 
        };

        // --- UPDATE 1: loadSubTest (Pastikan Group Name Tidak Kosong) ---
        const loadSubTest = (subId) => { 
            console.log("--> MEMUAT UJIAN UNTUK SUB ID:", subId);
            
            const sub = subTests.value.find(s => s.id === subId); 
            if (!sub) {
                alert("Error Fatal: Data Sub Tes tidak ditemukan!");
                examState.value = 'selection'; 
                return;
            }

            activeExam.currentSub = sub; 
            activeExam.answers = {}; 
            activeExam.flags = {}; 
            activeExam.waitingNextCol = false; 
            activeExam.colResults = []; 
            activeExam.questions = []; 

            if (sub.navType === 'missing_numbers') { 
                if (!sub.columnsData || sub.columnsData.length === 0) {
                    alert("Error: Data Kolom Kecermatan kosong!");
                    return;
                }
                activeExam.currentCol = 1; 
                loadMissingCol(1); 
            } else { 
                // --- LOAD SOAL UNTUK NORMAL/WEIGHTED ---
                
                // Ambil langsung dari selectedQuestions (Data Database yang sudah fix)
                let finalQuestionList = [];
                if (sub.selectedQuestions && Array.isArray(sub.selectedQuestions)) {
                    finalQuestionList = [...sub.selectedQuestions];
                }

                if (finalQuestionList.length === 0) {
                    // Fallback ke logic lama
                    if (sub.questions) finalQuestionList = [...sub.questions];
                    if (sub.internalGroups) {
                        sub.internalGroups.forEach(grp => {
                            if(grp.questions) finalQuestionList = [...finalQuestionList, ...grp.questions.map(q=>({...q, sourceGroupName: grp.name}))];
                        });
                    }
                }

                if (finalQuestionList.length === 0) {
                    alert("MAAF, DATA SOAL KOSONG.");
                    examState.value = 'selection';
                    return;
                }

                // Shuffle
                let qList = JSON.parse(JSON.stringify(finalQuestionList)); 
                qList.sort(() => Math.random() - 0.5);

                activeExam.questions = qList.map((q, qIndex) => {
                    const fixedOptions = (q.options || []).map((opt, optIdx) => ({
                        ...opt,
                        id: opt.id || `auto_opt_${q.id}_${optIdx}` 
                    }));
                    let optionsToShuffle = [...fixedOptions];
                    optionsToShuffle.sort(() => Math.random() - 0.5);

                    return {
                        ...q,
                        // --- PERBAIKAN DISINI: Default ke 'Umum' jika kosong ---
                        sourceGroupName: (q.sourceGroupName && q.sourceGroupName.trim() !== '') ? q.sourceGroupName : 'Umum', 
                        options: fixedOptions,             
                        shuffledOptions: optionsToShuffle.map((o, i) => ({...o, label: String.fromCharCode(65 + i)}))
                    };
                });

                activeExam.qIndex = 0; 
                if (activeExam.questions.length > 0) activeExam.currentQuestion = activeExam.questions[0];
                startTimer(sub.duration); 
            } 
        };
          // --- PERBAIKAN: loadMissingCol (Support Text/Number & Debugging) ---
        // --- PERBAIKAN FINAL: loadMissingCol (Agar Ujian Jalan) ---
        const loadMissingCol = (colId) => { 
            console.log("Memuat Kecermatan Kolom:", colId);
            activeExam.currentCol = colId; 
            
            // 1. Ambil input referensi (A-E) untuk kolom ini
            // Gunakan find dengan == agar aman (string vs number)
            const colData = activeExam.currentSub.columnsData.find(c => c.id == colId);
            activeExam.colRefInput = colData ? colData.inputs : ['?','?','?','?','?'];

            // 2. Filter Soal
            const rawQuestions = activeExam.currentSub.selectedQuestions || [];
            
            // FILTER PENTING: Gunakan '==' bukan '==='
            const colQuestions = rawQuestions.filter(q => q.columnId == colId);
            
            console.log(`Ditemukan ${colQuestions.length} soal untuk kolom ${colId}`);

            if (colQuestions.length === 0) {
                activeExam.questions = [];
                // Jangan panik dulu, biarkan UI menangani empty state
            } else {
                // 3. Mapping Soal
                activeExam.questions = colQuestions.map(q => ({ 
                    ...q, 
                    // Pastikan options ada isinya
                    shuffledOptions: q.options || [] 
                })); 
            }
            
            activeExam.qIndex = 0; 
            activeExam.waitingNextCol = false; 
            
            // Pastikan timer jalan
            startTimer(activeExam.currentSub.duration); 
        };    
        const startTimer = (seconds) => { timer.value = seconds; if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { timer.value--; if(timer.value <= 0) handleTimeOut(); }, 1000); };
        const handleTimeOut = () => { if (activeExam.currentSub.navType === 'missing_numbers') { recordColumnResult(); if (activeExam.currentCol < 10) loadMissingCol(activeExam.currentCol + 1); else finishSubTest(false); } else { finishSubTest(false); } };
        const recordColumnResult = () => { let correct = 0; let answered = 0; const colQ = activeExam.questions; colQ.forEach(q => { const ansId = activeExam.answers[q.id]; if(ansId) { answered++; const opt = q.options.find(o => o.id === ansId); if(opt && opt.isCorrect) correct++; } }); activeExam.colResults.push({ answered: answered, correct: correct, wrong: answered - correct }); };
        // GANTI FUNCTION selectAnswer DENGAN INI
        // PERBAIKAN: Menggunakan activeExam.questions[activeExam.qIndex] agar lebih stabil
        // --- GANTI FUNGSI selectAnswer DENGAN INI ---
        // --- GANTI FUNGSI selectAnswer DENGAN INI (SMART LOGIC) ---

        const selectAnswer = (optId) => { 
            // 1. Cek blocking overlay (tunggu kolom kecermatan)
            if(activeExam.waitingNextCol) return; 
            
            // 2. Ambil data soal saat ini
            const currentQ = activeExam.questions[activeExam.qIndex];
            if (!currentQ) return;
            
            const qId = currentQ.id;

            // --- LOGIKA PENENTUAN TIPE ---
            // Hitung berapa opsi yang ditandai 'isCorrect' oleh Admin
            const correctCount = currentQ.options.filter(o => o.isCorrect).length;
            
            // Apakah ini soal Multiple Answer? (Hanya jika Kunci > 1 DAN Tipe Normal)
            // Jika tipe Weighted (Bobot), biasanya tetap Single Answer (pilih yang poin tertinggi)
            const isMultiAnswer = (correctCount > 1 && activeExam.currentSub.type === 'normal');

            // Siapkan wadah jawaban (selalu array agar konsisten)
            let userAns = activeExam.answers[qId];
            if (!Array.isArray(userAns)) {
                userAns = userAns ? [userAns] : []; 
            }

            if (isMultiAnswer) {
                // --- LOGIKA BANYAK JAWABAN (CHECKBOX) ---
                if (userAns.includes(optId)) {
                    // Kalau sudah ada, HAPUS (Uncheck)
                    userAns = userAns.filter(id => id !== optId);
                } else {
                    // Kalau belum ada, TAMBAH (Check)
                    userAns.push(optId);
                }
            } else {
                // --- LOGIKA SATU JAWABAN (RADIO BUTTON) ---
                // Langsung ganti isinya dengan yang baru diklik
                userAns = [optId];
            }

            // 3. Simpan ke State
            activeExam.answers[qId] = userAns;
            console.log(`Soal ID ${qId} (${isMultiAnswer ? 'Multi' : 'Single'}):`, userAns);

            // 4. Logika Pindah Otomatis (Hanya untuk Kecermatan)
            // Mode Normal/Bobot tidak perlu pindah otomatis agar user bisa cek lagi
            if (activeExam.currentSub.navType === 'missing_numbers') { 
                if (activeExam.qIndex < activeExam.questions.length - 1) { 
                    activeExam.qIndex++; 
                } else { 
                    recordColumnResult(); 
                    if (activeExam.currentCol < 10) { 
                        loadMissingCol(activeExam.currentCol + 1); 
                    } else { 
                        finishSubTest(false); 
                    } 
                } 
            } 
        };

        // PERBAIKAN: Cek status seleksi langsung ke array utama
        // --- GANTI FUNGSI isSelected DENGAN INI ---
        const isSelected = (optId) => {
            const currentQ = activeExam.questions[activeExam.qIndex];
            if (!currentQ) return false;
            
            const userAns = activeExam.answers[currentQ.id];
            
            // Cek apakah optId ada di dalam array jawaban
            if (Array.isArray(userAns)) {
                return userAns.includes(optId);
            }
            
            // Fallback untuk data lama (string)
            return userAns === optId;
        };
        const nextQuestion = () => activeExam.qIndex++;
        const prevQuestion = () => { if(activeExam.currentSub.navType === 'linear') return; activeExam.qIndex--; };
        // --- UPDATE 2: finishSubTest (Anti NaN Calculation) ---
        // --- KEMBALI NORMAL: finishSubTest ---
        // --- PERBAIKAN: finishSubTest dengan Penyimpanan API Baru ---
        const finishSubTest = (manual) => { 
            
            // 1. DEFINISI LOGIKA PENYELESAIAN (Dibungkus agar bisa dipanggil nanti)
            const executeFinishProcess = () => {
                clearInterval(timerInterval); 
                
                let finalScore = 0; 
                let detailData = null; 
                let groupStats = {}; 
                let groupBreakdown = []; 
                
                const allQuestions = activeExam.currentSub.navType === 'missing_numbers' ? (activeExam.currentSub.selectedQuestions || []) : activeExam.questions; 
                
                // --- KECERMATAN ---
                if (activeExam.currentSub.navType === 'missing_numbers') { 
                    const rawScore = activeExam.colResults.reduce((a,b) => a + (b.correct || 0), 0); 
                    detailData = [...activeExam.colResults]; 
                    while(detailData.length < 10) detailData.push({answered:0, correct:0, wrong:0});
                    
                    finalScore = allQuestions.length > 0 ? (rawScore / allQuestions.length) * 100 : 0; 
                
                // --- NORMAL & BOBOT ---
                } else { 
                    let totalPoints = 0; 
                    let normalCorrectCount = 0; 
                    
                    allQuestions.forEach(q => { 
                        let rawAns = activeExam.answers[q.id];
                        const userAnsList = Array.isArray(rawAns) ? rawAns : (rawAns ? [rawAns] : []);
                        const gName = q.sourceGroupName; 
                        
                        if (gName) {
                            if (!groupStats[gName]) groupStats[gName] = { correct: 0, total: 0 }; 
                            groupStats[gName].total++; 
                        }

                        if (activeExam.currentSub.type === 'normal') {
                            const correctOptionIds = q.options.filter(o => o.isCorrect).map(o => o.id);
                            const isAllCorrect = userAnsList.length === correctOptionIds.length && userAnsList.every(val => correctOptionIds.includes(val));

                            if (isAllCorrect) {
                                normalCorrectCount++;
                                if(gName) groupStats[gName].correct++;
                            }
                        } else if (activeExam.currentSub.type === 'weighted') { 
                            let qPoints = 0;
                            userAnsList.forEach(ansId => {
                                const opt = q.options.find(o => o.id === ansId);
                                if (opt) qPoints += (opt.weight || 0);
                            });
                            totalPoints += qPoints;
                            if (qPoints > 0 && gName) groupStats[gName].correct++; 
                        } 
                    }); 

                    if (activeExam.currentSub.type === 'normal') { 
                        finalScore = allQuestions.length > 0 ? (normalCorrectCount / allQuestions.length) * 100 : 0; 
                    } else { 
                        finalScore = totalPoints; 
                    }
                    
                    groupBreakdown = Object.keys(groupStats).map(key => { 
                        const st = groupStats[key]; 
                        return { name: key, correctCount: st.correct, totalInGroup: st.total, score: (st.correct / st.total) * 100 }; 
                    }); 
                } 
                
                finalScore = parseFloat(finalScore) || 0;

                activeExam.resultsBuffer.push({ 
                    subId: activeExam.currentSub.id, 
                    subName: activeExam.currentSub.nameDisplay, 
                    subNameInternal: activeExam.currentSub.nameInternal, 
                    score: finalScore, 
                    type: activeExam.currentSub.navType, 
                    subType: activeExam.currentSub.type, 
                    detail: detailData, 
                    groupBreakdown: groupBreakdown,
                    userAnswers: JSON.parse(JSON.stringify(activeExam.answers)),
                    userFlags: JSON.parse(JSON.stringify(activeExam.flags || {}))
                }); 
                
                if (activeExam.currentSubIndex < activeExam.subIds.length - 1) { 
                    activeExam.currentSubIndex++; 
                    loadSubTest(activeExam.subIds[activeExam.currentSubIndex]); 
                }else { 
                    let totalWeightedScore = 0;
                    let totalWeightUsed = 0;
                    
                    // Hitung berdasarkan bobot yang tersimpan di activeExam
                    activeExam.resultsBuffer.forEach(res => {
                        const weight = activeExam.subWeights[res.subId] || 0;
                        
                        if (weight > 0) {
                            // Rumus: (SkorSub * Bobot) / 100
                            totalWeightedScore += (res.score * weight) / 100;
                            totalWeightUsed += weight;
                        } else {
                            // Jika bobot 0 atau tidak diset, simpan score mentah untuk fallback rata-rata
                            // (Akan ditangani di bawah jika totalWeightUsed == 0)
                        }
                    });

                    // Fallback: Jika User tidak menset bobot (Total 0), gunakan Rata-Rata Biasa
                    if (totalWeightUsed === 0) {
                        const sum = activeExam.resultsBuffer.reduce((a,b) => a + b.score, 0);
                        totalWeightedScore = sum / activeExam.resultsBuffer.length;
                    } 
                    // Fallback: Jika bobot ada tapi tidak 100%, skor sudah proporsional (misal bobot total 50%, nilai max jadi 50)
                    // Tidak perlu dinormalisasi agar sesuai request "skor muncul adalah nilai dari itu"

                    // === HITUNG STATUS KELULUSAN ===
                    const finalScore = parseFloat(totalWeightedScore.toFixed(2));
                    const passGrade = activeExam.passingGrade || 0;
                    
                    // Jika ada KKM (>0), tentukan status
                    let finalModuleName = activeExam.moduleName;
                    if (passGrade > 0) {
                        const status = finalScore >= passGrade ? ' [LULUS]' : ' [TIDAK LULUS]';
                        finalModuleName += status;
                    }
                    
                    // Tambah Label Warning/Violation (Kode Lama)
                    if (activeExam.violationCount > 0 && activeExam.violationCount < 3) {
                        finalModuleName += ` [WARN:${activeExam.violationCount}]`;
                    } else if (checkViolation(activeExam.moduleName)) { // Jika kena force finish
                        finalModuleName += " [VIOLATION]";
                    }

                    const res = { 
                        id: generateId(), 
                        participantId: currentUser.value.id, 
                        participantName: currentUser.value.username, 
                        moduleName: finalModuleName, 
                        packageId: activeExam.packageId, 
                        endTime: Date.now(), 
                        // SIMPAN TOTAL SCORE YANG SUDAH DIHITUNG BOBOTNYA
                        totalScore: finalScore,
                        subResults: activeExam.resultsBuffer 
                    };
                    
                    // Update State Lokal
                    results.value.push(res); 
                    finishedResult.value = res; 
                    examState.value = 'finished'; 

                    secureFetch('/api/user/submit_exam', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('ujian_token')
                        },
                        body: JSON.stringify({ result: res })
                    })
                    .then(d => {
                        if(d.status === 'success') console.log("Hasil tersimpan di server.");
                        else notifyError("Gagal simpan ke server: " + d.message); // Ubah jadi notifyError
                    })
                    .catch(e => notifyError("Gagal koneksi simpan hasil.")); // Ubah jadi notifyError
                } 
            };

            // 2. CEK KONFIRMASI (STYLE LOG OUT / TENGAH)
            if (manual && timer.value > 0 && activeExam.currentSub.navType !== 'missing_numbers') {
                Swal.fire({
                    title: 'Selesaikan Sub Tes?',
                    text: "Waktu masih tersisa. Yakin ingin mengakhiri sesi ini?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6', // Biru (Tombol Selesai)
                    cancelButtonColor: '#d33',     // Merah (Tombol Batal)
                    confirmButtonText: 'Ya, Selesai',
                    cancelButtonText: 'Batal',
                    reverseButtons: true,
                    // Tidak pakai timer otomatis agar user tidak tidak sengaja selesai
                    background: '#fff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        executeFinishProcess();
                    }
                });
                return; // Stop eksekusi sampai user klik Ya
            }

            // 3. JIKA TIDAK BUTUH KONFIRMASI (Waktu habis / Kecermatan)
            executeFinishProcess();
        };
        const calculateTotalScore = (res) => {
            // Jika data baru sudah punya total_score (dari backend/save), pakai itu
            if (res.totalScore !== undefined && res.totalScore !== null) {
                return parseFloat(res.totalScore).toFixed(1);
            }
            // Fallback data lama (Rata-rata)
            return res && res.subResults ? (res.subResults.reduce((a,b)=>a+b.score,0)/res.subResults.length).toFixed(1) : 0;
        };
        const viewResultDetail = (r) => { selectedResult.value = r; showResultModal.value = true; };

        // --- REVIEWER LOGIC ---
        const resetReviewState = () => { 
            reviewState.value = 'list'; 
            selectedReviewUser.value = null; 
            reviewSearch.value = ''; 
        };        
        const filteredReviewResults = computed(() => {
            let temp = [...results.value];
            if (reviewFilterGroup.value) { const uids = accounts.value.filter(a => a.groupId === reviewFilterGroup.value).map(a => a.id); temp = temp.filter(r => uids.includes(r.participantId)); }
            if (reviewSearch.value) { const lower = reviewSearch.value.toLowerCase(); temp = temp.filter(r => getParticipantName(r).toLowerCase().includes(lower)); }
            temp.sort((a,b) => { if (reviewSort.value === 'date_desc') return b.endTime - a.endTime; if (reviewSort.value === 'date_asc') return a.endTime - b.endTime; if (reviewSort.value === 'score_desc') return parseFloat(calculateTotalScore(b)) - parseFloat(calculateTotalScore(a)); return 0; });
            return temp;
        });
        const filteredUsersForReview = computed(() => { let users = accounts.value.filter(a => a.role === 'peserta'); if (reviewFilterGroup.value) users = users.filter(a => a.groupId === reviewFilterGroup.value); if (reviewSearch.value) users = users.filter(a => a.username.toLowerCase().includes(reviewSearch.value.toLowerCase())); return users; });
        const openUserDetail = (u) => { selectedReviewUser.value = u; reviewState.value = 'detail'; };
        const userExamHistory = computed(() => selectedReviewUser.value ? results.value.filter(r => r.participantId === selectedReviewUser.value.id).sort((a,b) => b.endTime - a.endTime) : []);
        
        const startFullReview = (res) => { selectedReviewResult.value = res; reviewTotalSubs.value = res.subResults.length; reviewSubIndex.value = 0; loadReviewSub(0); reviewState.value = 'exam_view'; };
        // --- UPDATE: loadReviewSub (Support Array Answers) ---
        const loadReviewSub = (idx) => {
            if (!selectedReviewResult.value || !selectedReviewResult.value.subResults) return;

            const subRes = selectedReviewResult.value.subResults[idx];
            const savedFlags = subRes.userFlags || {}; 

            const realSub = subTests.value.find(s => s.id === subRes.subId);
            
            reviewCurrentSub.value = realSub || { 
                nameDisplay: subRes.subName + " (DATA TERHAPUS)", 
                navType: subRes.type, 
                nameInternal: 'DELETED',
                type: subRes.subType 
            };
            
            let questions = [];
            
            if (realSub && realSub.navType !== 'missing_numbers') {
                // Gunakan selectedQuestions sebagai prioritas
                const sourceQuestions = (realSub.selectedQuestions && realSub.selectedQuestions.length > 0) 
                                        ? realSub.selectedQuestions 
                                        : (realSub.questions || []);

                questions = sourceQuestions.map(q => { 
                    // 1. AMBIL JAWABAN (Support Array & Legacy String)
                    const rawAns = subRes.userAnswers ? subRes.userAnswers[q.id] : null;
                    const userAnsList = Array.isArray(rawAns) ? rawAns : (rawAns ? [rawAns] : []);
                    
                    // 2. CEK KEBENARAN (Strict Match)
                    const correctOptIds = q.options.filter(o => o.isCorrect).map(o => o.id);
                    const isCorrect = userAnsList.length > 0 && 
                                      userAnsList.length === correctOptIds.length && 
                                      userAnsList.every(id => correctOptIds.includes(id));

                    return { 
                        ...q, 
                        userAnswerIds: userAnsList, // Simpan sebagai Array
                        userCorrect: isCorrect, 
                        userFlagged: savedFlags[q.id] || false, 
                        options: q.options.map((o, i) => ({...o, label: String.fromCharCode(65+i)})) 
                    }; 
                });
            }
            reviewQuestions.value = questions; 
            reviewQuestionIndex.value = 0;
        };
        const nextReviewSub = () => { if(reviewSubIndex.value < reviewTotalSubs.value-1) { reviewSubIndex.value++; loadReviewSub(reviewSubIndex.value); }};
        const prevReviewSub = () => { if(reviewSubIndex.value > 0) { reviewSubIndex.value--; loadReviewSub(reviewSubIndex.value); }};
        const currentReviewQ = computed(() => reviewQuestions.value[reviewQuestionIndex.value] || {});
        const currentReviewSubResult = computed(() => selectedReviewResult.value.subResults[reviewSubIndex.value]);
        const getCurrentSubScore = () => selectedReviewResult.value.subResults[reviewSubIndex.value].score.toFixed(1);
        const getReviewNavClass = (idx) => { 
            const q = reviewQuestions.value[idx]; 
            
            // Sedang aktif
            if (reviewQuestionIndex.value === idx) {
                return 'border-blue-500 ring-2 ring-blue-200 text-blue-800 bg-white'; 
            }

            // Sudah dijawab (Cek panjang array)
            const hasAnswer = q.userAnswerIds && q.userAnswerIds.length > 0;

            if (reviewCurrentSub.value.type === 'weighted' && hasAnswer) {
                return 'bg-green-50 text-green-700 border-green-200';
            }

            if (q.userCorrect) return 'bg-green-50 text-green-700 border-green-200'; // Benar
            if (hasAnswer) return 'bg-red-50 text-red-700 border-red-200'; // Salah
            
            return 'bg-gray-50 text-gray-400 border-gray-200'; // Kosong
        }; 
        const getReviewOptionClass = (opt, q) => { 
            // Cek apakah opsi ini ada di dalam array jawaban user
            if (q.userAnswerIds && q.userAnswerIds.includes(opt.id)) {
                return 'border-blue-500 bg-blue-50 text-blue-900 font-bold shadow-sm'; 
            }
            return 'bg-white border-gray-200 text-gray-500'; 
        };

        // --- WATCHERS ---
        Vue.watch(() => activeExam.qIndex, (newIndex) => { if (activeExam.questions && activeExam.questions.length > 0) activeExam.currentQuestion = activeExam.questions[newIndex]; });
        // --- UPDATE WATCHER: Fix Tampilan Tumpang Tindih ---
        Vue.watch(() => activeExam.questions, (newQuestions) => { 
            if (newQuestions && newQuestions.length > 0) {
                // Jika ada soal, set soal pertama
                activeExam.currentQuestion = newQuestions[activeExam.qIndex || 0]; 
            } else {
                // PERBAIKAN: Jika soal kosong, PAKSA currentQuestion jadi null
                // Ini akan menghilangkan kotak soal "hantu" di bawah pesan error
                activeExam.currentQuestion = null;
            }
        });
        // --- UPDATE WATCHER EDITOR KECERMATAN ---
        Vue.watch(activeMissingCol, (newVal) => { 
            if (newSub.navType !== 'missing_numbers') return; 
            ensureColumnsExist(); 
            
            // Cari data kolom yang diklik
            const targetCol = newSub.columnsData.find(c => c.id == newVal);
            
            if(targetCol && targetCol.inputs) {
                // Update tampilan kotak input A-E
                tempMissingInputs.splice(0, tempMissingInputs.length); // Kosongkan
                targetCol.inputs.forEach(val => tempMissingInputs.push(val)); // Isi baru
            }
        });
        Vue.watch(tempMissingInputs, (newVal) => { if (newSub.navType !== 'missing_numbers') return; ensureColumnsExist(); if(newSub.columnsData[activeMissingCol.value-1]) newSub.columnsData[activeMissingCol.value-1].inputs = [...newVal]; }, { deep: true });

        // --- LIFECYCLE ---
        // --- GANTI SELURUH onMounted DENGAN INI ---
        onMounted(() => {
            // Matikan loading screen awal
            setTimeout(() => { 
                const loadingEl = document.getElementById('loading');
                if(loadingEl) loadingEl.style.display = 'none'; 
            }, 500);

            // 1. Cek Sesi Login di LocalStorage
            const savedToken = localStorage.getItem('ujian_token');
            const savedUser = localStorage.getItem('ujian_user');

            if (savedToken && savedUser) {
                // Jika ada sesi tersimpan
                try {
                    const user = JSON.parse(savedUser);
                    currentUser.value = user;
                    currentRole.value = user.role;
                    isLoggedIn.value = true;
                    
                    // --- PERBAIKAN: Panggil loadData() saja. ---
                    // Jangan pakai fetch('api.php?action=load_all') manual disini!
                    // loadData() sudah pintar memilih jalur admin/peserta.
                    loadData(); 

                } catch (e) {
                    console.error("Sesi rusak", e);
                    handleLogout(); 
                }
            } else {
                console.log("Menunggu user login...");
            }

            // Restore Edit State (Khusus Admin)
            const lastSubId = localStorage.getItem('last_edited_sub_id');
            if (lastSubId && currentRole.value === 'admin' && adminTab.value === 'sub') {
                 // Biarkan kosong, nanti data akan di-restore setelah loadData selesai
            }
        });
        // --- TAMBAHAN HELPER UNTUK REVIEW BOBOT ---
        const getQuestionScore = (q) => {
            if (!q.userAnswerIds || q.userAnswerIds.length === 0) return 0;
            // Jumlahkan bobot dari semua opsi yang dipilih
            let total = 0;
            q.userAnswerIds.forEach(ansId => {
                const opt = q.options.find(o => o.id === ansId);
                if(opt) total += (opt.weight || 0);
            });
            return total;
        };
        // --- LOGIC NAVIGASI PESERTA (WAJIB ADA AGAR TIDAK ERROR) ---
        // --- LOGIC NAVIGASI PESERTA ---
        const jumpToQuestion = (idx) => {
            if (activeExam.currentSub.navType === 'linear') return;
            activeExam.qIndex = idx;
        };

        const toggleFlag = () => {
            if (!activeExam.currentQuestion) return;
            const qId = activeExam.currentQuestion.id;
            if (!activeExam.flags) activeExam.flags = {};
            activeExam.flags[qId] = !activeExam.flags[qId];
        };

        const getPesertaNavClass = (idx) => {
            if (!activeExam.questions || !activeExam.questions[idx]) return '';
            const qId = activeExam.questions[idx].id;

            if (activeExam.qIndex === idx) {
                return 'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-200 z-10';
            }
            if (activeExam.flags && activeExam.flags[qId]) {
                return 'bg-yellow-100 text-yellow-700 border-yellow-400 font-bold';
            }
            if (activeExam.answers && activeExam.answers[qId]) {
                return 'bg-green-50 text-green-700 border-green-400';
            }
            return 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300';
        };

        // --- LOGIC EDITOR WORD-LIKE ---
        
        // 1. Fungsi Eksekusi Perintah (Bold, Italic, Font, dll)
        const execCmd = (command, value = null) => {
            document.execCommand(command, false, value);
        };

        // 2. Logic Mengatur Gambar (Klik Gambar untuk Edit)
        const activeImg = ref(null); // Menyimpan gambar yang sedang diklik

        // Fungsi saat area editor diklik (mendeteksi apakah yg diklik itu gambar?)
        const handleEditorClick = (e) => {
            if (e.target.tagName === 'IMG') {
                // Jika user klik gambar
                if(activeImg.value) activeImg.value.classList.remove('active-img');
                activeImg.value = e.target;
                activeImg.value.classList.add('active-img');
            } else {
                // Jika user klik teks biasa
                if(activeImg.value) {
                    activeImg.value.classList.remove('active-img');
                    activeImg.value = null;
                }
            }
        };

        // Fungsi Ubah Ukuran Gambar
        const setImageSize = (percent) => {
            if (activeImg.value) {
                activeImg.value.style.width = percent + '%';
                activeImg.value.style.height = 'auto';
            } else {
                alert("Klik gambarnya dulu baru atur ukuran!");
            }
        };

        // Fungsi Ubah Posisi Gambar (Float)
        const setImageAlign = (align) => {
            if (activeImg.value) {
                activeImg.value.style.float = align;
                // Tambahkan margin agar rapi
                activeImg.value.style.margin = align === 'left' ? '0 15px 10px 0' : (align === 'right' ? '0 0 10px 15px' : '10px auto');
                if(align === 'none') activeImg.value.style.display = 'block';
            } else {
                // Jika tidak ada gambar, gunakan justify text biasa
                document.execCommand('justify' + (align === 'none' ? 'Center' : (align === 'left' ? 'Left' : 'Right')));
            }
        };
        // --- UPDATE SCRIPT INI DI DALAM setup() ---

        // 1. TAMBAHKAN STATE BARU UNTUK PEMBAHASAN
        const tempExplanation = ref('');
        const updateExp = (e) => tempExplanation.value = e.target.innerHTML;

        // Helper: Set Kunci Jawaban (Radio Button Logic untuk Normal)
        const setCorrectOption = (idx) => {
            tempOptions.value.forEach((o, i) => o.isCorrect = (i === idx));
        };

        // 2. UPDATE FUNGSI RESET EDITOR
        const resetQEditor = () => {
            isEditingQ.value = false;
            editingQIdx.value = -1;
            
            // --- TAMBAHAN WAJIB (Agar fitur pindah kelompok berjalan lancar) ---
            editingQSourceGroupIdx.value = -2; 
            // ------------------------------------------------------------------

            tempQContent.value = '';
            tempExplanation.value = ''; // Reset pembahasan
            
            // Bersihkan HTML Editor
            const elQ = document.getElementById('editor-q'); if(elQ) elQ.innerHTML = '';
            const elExp = document.getElementById('editor-exp'); if(elExp) elExp.innerHTML = '';
            
            // Reset Opsi ke default (2 opsi kosong)
            tempOptions.value = [{text:'', isCorrect:false, weight:0}, {text:'', isCorrect:false, weight:0}];
            
            // Bersihkan HTML Opsi
            setTimeout(() => {
                document.querySelectorAll('[id^="editor-opt-"]').forEach(el => el.innerHTML = '');
            }, 50);
        };

        // 3. UPDATE FUNGSI ADD QUESTION (SIMPAN PEMBAHASAN)
        const addQuestionToSub = () => {
            const targetList = activeInternalGroupIdx.value === -1 ? newSub.questions : newSub.internalGroups[activeInternalGroupIdx.value].questions;
            const qData = {
                id: isEditingQ.value ? null : generateId(),
                text: tempQContent.value,
                explanation: tempExplanation.value,
                sourceGroupName: activeInternalGroupIdx.value === -1 ? '' : newSub.internalGroups[activeInternalGroupIdx.value].name,
                options: tempOptions.value.map(o => ({
                    ...o, id: o.id || generateId(),
                    isCorrect: (newSub.type === 'normal' ? o.isCorrect : false),
                    weight: (newSub.type === 'weighted' ? o.weight : 0)
                }))
            };

            if(isEditingQ.value && editingQIdx.value !== -1) {
                if (editingQSourceGroupIdx.value !== activeInternalGroupIdx.value) {
                    const sourceList = editingQSourceGroupIdx.value === -1 ? newSub.questions : newSub.internalGroups[editingQSourceGroupIdx.value].questions;
                    qData.id = sourceList[editingQIdx.value].id;
                    sourceList.splice(editingQIdx.value, 1);
                    targetList.push(qData);
                    notifySuccess("Soal dipindah & diupdate!");
                } else {
                    qData.id = targetList[editingQIdx.value].id;
                    targetList[editingQIdx.value] = qData;
                    notifySuccess("Soal diperbarui!");
                }
            } else {
                qData.id = generateId();
                targetList.push(qData);
                notifySuccess("Soal ditambahkan!");
            }
            resetQEditor();
        };

        // 4. UPDATE FUNGSI EDIT QUESTION (LOAD PEMBAHASAN)
        const editQInSub = (idx) => {
            // Tentukan list sumber berdasarkan tab yang sedang aktif SAAT INI
            const targetList = activeInternalGroupIdx.value === -1 ? newSub.questions : newSub.internalGroups[activeInternalGroupIdx.value].questions;
            const q = targetList[idx];
            
            // SIMPAN ASAL KELOMPOK (PENTING AGAR BISA PINDAH)
            editingQSourceGroupIdx.value = activeInternalGroupIdx.value; 

            isEditingQ.value = true;
            editingQIdx.value = idx;
            tempQContent.value = q.text;
            tempExplanation.value = q.explanation || '';

            // Render Editor HTML
            const elQ = document.getElementById('editor-q'); if(elQ) elQ.innerHTML = q.text;
            const elExp = document.getElementById('editor-exp'); if(elExp) elExp.innerHTML = q.explanation || '';
            
            tempOptions.value = JSON.parse(JSON.stringify(q.options));
            
            setTimeout(() => {
                tempOptions.value.forEach((opt, i) => {
                    const el = document.getElementById('editor-opt-'+i);
                    if(el) el.innerHTML = opt.text;
                });
            }, 100);
        };
        const notifySuccess = (message) => {
            Swal.fire({
                icon: 'success',
                title: message,
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                background: '#fff',
                iconColor: '#10b981'
            });
        };

        const notifyError = (message) => {
            Swal.fire({
                icon: 'error',
                title: 'Gagal',
                text: message,
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                background: '#fff',
                iconColor: '#ef4444'
            });
        };
        const confirmDelete = (message, textDetail = "") => {
            return Swal.fire({
                title: message,
                text: textDetail,
                icon: 'question',
                position: 'bottom-end',     // POSISI DI KANAN BAWAH
                toast: true,                // BENTUK SEPERTI NOTIFIKASI
                showCancelButton: true,
                confirmButtonColor: '#d33', // Merah untuk hapus
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal',
                timer: 10000,               // Hilang otomatis dalam 10 detik jika tidak diklik
                timerProgressBar: true,
                background: '#fff',
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
        };
        // ==========================================
        // 5. LOGIC IMPORT EXCEL (BARU)
        // ==========================================
        const handleExcelUpload = (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                let addedCount = 0;
                
                jsonData.forEach(row => {
                    // Mapping Kolom Excel (Case Insensitive)
                    const getVal = (key) => row[Object.keys(row).find(k => k.toLowerCase().includes(key.toLowerCase()))] || '';
                    
                    const soalText = getVal('soal') || getVal('pertanyaan');
                    if(!soalText) return;

                    const groupName = getVal('kelompok') || getVal('group'); // Baca kolom Kelompok
                    const explanation = getVal('pembahasan') || getVal('explanation');
                    const kunciRaw = String(getVal('kunci') || getVal('jawaban') || '').trim();

                    // Siapkan Opsi
                    const opts = [];
                    ['a','b','c','d','e'].forEach((char, idx) => {
                        const optText = getVal('opsi ' + char) || getVal('pilihan ' + char);
                        if(optText) {
                            let isCorrect = false;
                            let weight = 0;

                            // ... di dalam loop opsi Excel ...

                            if(newSub.type === 'normal') {
                                // UPDATE: Support Multiple Keys (Misal: "A, C" atau "A;C")
                                // Pisahkan string berdasarkan koma atau titik koma, lalu bersihkan spasi
                                const correctKeys = String(kunciRaw).toUpperCase().split(/[,;]/).map(k => k.trim());
                                
                                // Cek apakah karakter opsi ini (misal 'A') ada di dalam daftar kunci
                                isCorrect = correctKeys.includes(char.toUpperCase());
                            } else {
                                // Logic Weighted (Bobot) tetap sama
                                const weights = String(kunciRaw).split(/[,;]/).map(Number);
                                weight = weights[idx] || 0;
                            }

                            opts.push({
                                id: generateId(),
                                label: char.toUpperCase(),
                                text: String(optText), // Konversi ke string agar aman
                                isCorrect: isCorrect,
                                weight: weight
                            });
                        }
                    });

                    // Logic Insert ke Kelompok
                    let targetList = newSub.questions; // Default tanpa kelompok
                    let sourceGroupName = '';

                    if(groupName) {
                        sourceGroupName = groupName;
                        // Cari apakah kelompok sudah ada di internalGroups
                        let grpIdx = newSub.internalGroups.findIndex(g => g.name.toLowerCase() === groupName.toLowerCase());
                        
                        if(grpIdx === -1) {
                            // Jika belum ada, BUAT BARU OTOMATIS
                            newSub.internalGroups.push({ name: groupName, questions: [] });
                            grpIdx = newSub.internalGroups.length - 1;
                        }
                        targetList = newSub.internalGroups[grpIdx].questions;
                    }

                    // Push Soal
                    targetList.push({
                        id: generateId(),
                        text: soalText, // Excel biasanya plain text, bisa diubah ke HTML jika perlu
                        explanation: explanation,
                        sourceGroupName: sourceGroupName,
                        options: opts
                    });
                    addedCount++;
                });

                e.target.value = ''; // Reset input file
                alert(`Berhasil mengimpor ${addedCount} soal dari Excel!`);
            };
            reader.readAsArrayBuffer(file);
        };

        // ==========================================
        // 6. LOGIC IMPORT WORD (UPDATE FITUR LENGKAP)
        // ==========================================
        const handleWordUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                // KONFIGURASI KHUSUS UNTUK GAMBAR
                const options = {
                    convertImage: mammoth.images.imgElement(function(image) {
                        return image.read("base64").then(function(imageBuffer) {
                            // 1. Ubah Base64 jadi Blob/File
                            const byteCharacters = atob(imageBuffer);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], {type: image.contentType});
                            
                            // 2. Siapkan Form Data
                            const formData = new FormData();
                            formData.append('file', blob, 'word_img_' + Date.now() + '.' + image.contentType.split('/')[1]);

                            // 3. Upload Background ke Server (api.php)
                            // PENTING: Kita pakai fetch synchronous atau promise agar mammoth menunggu upload
                            return fetch('/api/admin/upload_image', {
                                method: 'POST',
                                body: formData
                            })
                            .then(data => {
                                if(data.status === 'success') {
                                    // 4. Kembalikan URL Gambar (Bukan Base64)
                                    return { src: data.url };
                                }
                                return { src: "" }; // Gagal upload
                            });
                        });
                    })
                };

                // Jalankan Mammoth dengan Opsi di atas
                mammoth.convertToHtml({ arrayBuffer: e.target.result }, options)
                    .then((result) => {
                        parseWordHtml(result.value); // Lanjut ke parsing teks
                    })
                    .catch((err) => {
                        console.error(err);
                        alert("Gagal membaca file Word.");
                    });
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        };

        // Parser Word yang lebih cerdas
        const parseWordHtml = (htmlContent) => {
            // Bersihkan HTML dan split berdasarkan keyword "SOAL"
            // Format yang diharapkan di Word:
            // [SOAL] Pertanyaan...
            // [A] Opsi A...
            // [KUNCI] A  (atau angka 5,0,0... untuk bobot)
            // [PEMBAHASAN] Teks...
            // [KELOMPOK] Aljabar
            
            // Kita gunakan regex untuk mencari blok
            // Tip: Mammoth menghasilkan HTML <p>...</p>. Kita replace dulu tag P jadi baris baru
            let cleanText = htmlContent
                .replace(/<\/p>/g, '\n')
                .replace(/<p>/g, '')
                .replace(/<br \/>/g, '\n');

            // Split berdasarkan penanda soal
            const blocks = cleanText.split(/\[SOAL\]/i).filter(b => b.trim().length > 0);
            let count = 0;

            blocks.forEach(block => {
                // Ekstrak Komponen
                const extract = (tag) => {
                    const regex = new RegExp(`\\[${tag}\\](.*?)(?=\\[|$)`, 'is');
                    const match = block.match(regex);
                    return match ? match[1].trim() : '';
                };

                const questionText = block.split(/\[(A|B|C|D|E|KUNCI|PEMBAHASAN|KELOMPOK)\]/i)[0].trim();
                const groupName = extract('KELOMPOK');
                const explanation = extract('PEMBAHASAN');
                const keyRaw = extract('KUNCI');
                
                // Ekstrak Opsi
                const opts = [];
                ['A','B','C','D','E'].forEach((lbl, idx) => {
                    const optText = extract(lbl);
                    if(optText) {
                        let isCorrect = false;
                        let weight = 0;
                        
                        // ... di dalam loop opsi Word ...

                        if(newSub.type === 'normal') {
                            // UPDATE: Support Multiple Keys (Misal: "A, C")
                            const correctKeys = keyRaw.toUpperCase().split(/[,;]/).map(k => k.trim());
                            
                            // Cek apakah Label ini (lbl) ada di daftar kunci
                            isCorrect = correctKeys.includes(lbl);
                        } else {
                            // Logic Weighted (Bobot) tetap sama
                            const weights = keyRaw.split(/[,;]/).map(Number);
                            weight = weights[idx] || 0;
                        }
                        opts.push({ id: generateId(), label: lbl, text: optText, isCorrect, weight });
                    }
                });

                if(questionText && opts.length > 0) {
                    // Logic Grouping Otomatis
                    let targetList = newSub.questions;
                    let sourceGroupName = '';

                    if(groupName) {
                        sourceGroupName = groupName;
                        let grpIdx = newSub.internalGroups.findIndex(g => g.name.toLowerCase() === groupName.toLowerCase());
                        if(grpIdx === -1) {
                            newSub.internalGroups.push({ name: groupName, questions: [] });
                            grpIdx = newSub.internalGroups.length - 1;
                        }
                        targetList = newSub.internalGroups[grpIdx].questions;
                    }

                    targetList.push({
                        id: generateId(),
                        text: questionText, // Simpan sebagai HTML
                        explanation: explanation,
                        sourceGroupName: sourceGroupName,
                        options: opts
                    });
                    count++;
                }
            });

            alert(`Berhasil mengimpor ${count} soal dari Word!`);
        };
        // --- LOGIC EXPORT / PRINT ---

        const openExportModal = (result) => {
            selectedExportResult.value = result;
            // Cari user object dari selectedReviewUser (karena kita di dalam detail user tsb)
            selectedExportUser.value = selectedReviewUser.value;
            
            // Default settings
            exportFormat.value = 'word';
            exportScope.value = 'full';
            exportSelectedSubId.value = result.subResults.length > 0 ? result.subResults[0].subId : '';
            
            showExportModal.value = true;
        };

        const processExport = () => {
            if(!selectedExportResult.value) return;

            // Filter Subtes berdasarkan Scope
            let subtestsToPrint = [];
            if(exportScope.value === 'full') {
                subtestsToPrint = selectedExportResult.value.subResults;
            } else {
                const target = selectedExportResult.value.subResults.find(s => s.subId === exportSelectedSubId.value);
                if(target) subtestsToPrint = [target];
            }

            if(subtestsToPrint.length === 0) return alert("Data subtes tidak ditemukan.");

            // Jalankan Generator
            if(exportFormat.value === 'word') {
                generateWordDoc(selectedExportResult.value, subtestsToPrint);
            } else {
                generateExcelSheet(selectedExportResult.value, subtestsToPrint);
            }
        };
        // --- UPDATE FUNGSI generateWordDoc (FIX: Warna Wajib Muncul / Inline Style) ---
        // --- HELPER FIX GAMBAR UNTUK WORD ---
        // Mengubah src="uploads/img.png" menjadi src="http://localhost/.../uploads/img.png"
        const fixImgPaths = (htmlStr) => {
            if (!htmlStr) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlStr;
            const images = tempDiv.querySelectorAll('img');
            images.forEach(img => {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                    // Ubah ke absolute URL berdasarkan lokasi halaman saat ini
                    try {
                        img.src = new URL(src, window.location.href).href;
                    } catch (e) {
                        console.error("Gagal fix path gambar:", src);
                    }
                }
            });
            return tempDiv.innerHTML;
        };
        // --- UPDATE FUNGSI GENERATE WORD ---
        const generateWordDoc = (resultHeader, subsData) => {
            let contentHtml = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
            <meta charset='utf-8'>
            <style>
                body { font-family: 'Calibri', sans-serif; font-size: 11pt; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                .sub-header { background: #eee; padding: 5px; font-weight: bold; margin-top: 20px; border: 1px solid #999; }
                
                .q-box { margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
                .q-text { font-weight: bold; margin-bottom: 8px; font-size: 12pt; }
                
                .opt-label { font-weight: bold; margin-right: 8px; }
                .exp { background-color: #f0f8ff; padding: 8px; margin-top: 8px; font-size: 10pt; border: 1px solid #b0d4ff; color: #333; }
                
                .chart-table { width: 100%; border-collapse: collapse; margin-top: 20px; height: 200px; }
                .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #000; }
                .data-table th, .data-table td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 10pt; }
                .data-table th { background-color: #f3f4f6; }
                img { max-width: 500px; height: auto; } /* Batasi ukuran gambar */
            </style>
            </head>
            <body>
                <div class="header">
                    <h1>Laporan Hasil Ujian</h1>
                    <p>Nama: ${selectedExportUser.value.username} | Modul: ${resultHeader.moduleName}</p>
                    <p>Waktu: ${formatDateTime(resultHeader.endTime)} | Total Skor: ${calculateTotalScore(resultHeader)}</p>
                </div>
            `;

            subsData.forEach((subRes, idx) => {
                const realSub = subTests.value.find(s => s.id === subRes.subId);
                contentHtml += `<div class="sub-header">Subtes ${idx+1}: ${subRes.subName} (Skor: ${subRes.score})</div>`;

                // === LOGIKA KECERMATAN ===
                if (realSub && realSub.navType === 'missing_numbers') {
                    const details = subRes.detail || []; 
                    const chartImgData = createChartImage(details); 

                    contentHtml += `<h4>Analisis Grafik Kecermatan</h4>`;
                    contentHtml += `<div style="text-align:center; margin: 10px 0;">
                        <img src="${chartImgData}" width="500" height="333" />
                    </div>`;

                    contentHtml += `<h4>Rincian Data Per Kolom</h4>`;
                    contentHtml += `<table class="data-table">
                        <thead><tr style="background:#f3f4f6;">
                            <th>Kolom</th><th>Benar</th><th>Salah</th><th>Total</th><th>Akurasi</th><th>Status</th>
                        </tr></thead><tbody>`;
                    
                    details.forEach((col, cIdx) => {
                        const acc = col.answered > 0 ? ((col.correct/col.answered)*100).toFixed(0) : 0;
                        let statusStyle = "color:black;";
                        if(acc >= 90) statusStyle = "color:#00b050; font-weight:bold;";
                        else if(acc < 50) statusStyle = "color:red; font-weight:bold;";

                        contentHtml += `<tr>
                            <td>Kolom ${cIdx+1}</td>
                            <td style="color:#00b050;">${col.correct}</td>
                            <td style="color:red;">${col.wrong}</td>
                            <td>${col.answered}</td>
                            <td>${acc}%</td>
                            <td style="${statusStyle}">${acc >= 70 ? 'Baik' : 'Kurang'}</td>
                        </tr>`;
                    });
                    contentHtml += `</tbody></table><br>`;

                // === LOGIKA SOAL BIASA (Normal/Weighted) ===
                } else if (realSub) {
                    const sourceQuestions = (realSub.selectedQuestions && realSub.selectedQuestions.length > 0) 
                                            ? realSub.selectedQuestions 
                                            : (realSub.questions || []);
                    
                    sourceQuestions.forEach((q, qIdx) => {
                        const rawAns = subRes.userAnswers ? subRes.userAnswers[q.id] : null;
                        const userAnsIds = Array.isArray(rawAns) ? rawAns : (rawAns ? [rawAns] : []);
                        
                        const correctOptIds = q.options.filter(o => o.isCorrect).map(o => o.id);
                        const isCorrect = userAnsIds.length > 0 && 
                                        userAnsIds.length === correctOptIds.length && 
                                        userAnsIds.every(id => correctOptIds.includes(id));
                        
                        // Status Soal
                        const statusLabel = isCorrect 
                            ? '<span style="color:#00b050; font-weight:bold; text-transform:uppercase;">BENAR</span>' 
                            : '<span style="color:red; font-weight:bold; text-transform:uppercase;">SALAH</span>';

                        contentHtml += `<div class="q-box">
                            <div class="q-text">No. ${qIdx+1} &nbsp;&nbsp; - &nbsp;&nbsp; ${statusLabel}</div>
                            <div style="margin-bottom:10px;">${fixImgPaths(q.text)}</div>`;
                        
                        // --- RENDER OPSI ---
                        q.options.forEach((opt, oIdx) => {
                            const label = String.fromCharCode(65+oIdx);
                            const isUserSelected = userAnsIds.includes(opt.id);
                            const isKey = opt.isCorrect;
                            
                            let finalStyle = "margin-left: 20px; margin-bottom: 5px; padding: 5px 10px; border: 1px solid transparent; border-radius: 4px;";
                            
                            if (isUserSelected && isKey) {
                                finalStyle += "background: #e6ffed; background-color: #e6ffed; border: 1px solid #00b050; color: #00602b;";
                            } 
                            else if (isUserSelected && !isKey) {
                                finalStyle += "background: #ffe6e6; background-color: #ffe6e6; border: 1px solid #ff0000; color: #cc0000;";
                            } 
                            else if (!isUserSelected && isKey) {
                                finalStyle += "background: #fffde6; background-color: #fffde6; border: 1px solid #e6b800; color: #997a00;";
                            } else {
                                finalStyle += "background: transparent;";
                            }

                            // Bersihkan label teks tapi JANGAN hapus tag img
                            let cleanText = opt.text
                                .replace(/\(Kunci Jawaban\)/gi, '')
                                .replace(/\(Jawaban Anda\)/gi, '')
                                .trim();

                            // FIX: Gunakan fixImgPaths untuk opsi
                            contentHtml += `<div style="${finalStyle}">
                                <span class="opt-label">${label}.</span> 
                                <span>${fixImgPaths(cleanText)}</span>
                            </div>`;
                        });

                        if (q.explanation) {
                            // FIX: Gunakan fixImgPaths untuk pembahasan
                            contentHtml += `<div class="exp"><strong>Pembahasan:</strong><br>${fixImgPaths(q.explanation)}</div>`;
                        }
                        contentHtml += `</div>`;
                    });
                }
            });

            contentHtml += `</body></html>`;

            const blob = new Blob(['\ufeff', contentHtml], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Hasil_${selectedExportUser.value.username}_${resultHeader.moduleName}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        // --- HELPER BARU: Menggambar Grafik ke Gambar (Canvas to Base64) ---
        const createChartImage = (details) => {
            // 1. Setup Canvas
            const canvas = document.createElement('canvas');
            const width = 600;
            const height = 400;
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // 2. Background Putih (Penting agar tidak transparan/hitam di Word)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // 3. Konfigurasi Area
            const padding = { top: 40, bottom: 40, left: 50, right: 20 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // 4. Tentukan Skala (Cari nilai tertinggi untuk batas atas grafik)
            let maxVal = 0;
            details.forEach(d => {
                if (d.answered > maxVal) maxVal = d.answered;
            });
            // Beri sedikit ruang di atas (tambah 20%) atau minimal 50 jika kosong
            maxVal = maxVal > 0 ? Math.ceil(maxVal * 1.2) : 50; 

            // 5. Gambar Grid Horizontal & Label Y
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#64748b';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';

            const steps = 5; // Jumlah garis grid
            for (let i = 0; i <= steps; i++) {
                const yVal = Math.round((maxVal / steps) * i);
                const yPos = padding.top + chartHeight - (yVal / maxVal * chartHeight);
                
                // Garis
                ctx.beginPath();
                ctx.moveTo(padding.left, yPos);
                ctx.lineTo(width - padding.right, yPos);
                ctx.stroke();

                // Angka
                ctx.fillText(yVal, padding.left - 10, yPos + 3);
            }

            // 6. Gambar Batang & Garis
            const colWidth = chartWidth / details.length;
            const barWidth = 15;
            
            // Array untuk menyimpan koordinat titik garis biru (Total)
            const linePoints = [];

            details.forEach((col, i) => {
                const xCenter = padding.left + (i * colWidth) + (colWidth / 2);
                
                // --- Hitung Tinggi ---
                const hCorrect = (col.correct / maxVal) * chartHeight;
                const hWrong = (col.wrong / maxVal) * chartHeight;
                const hTotal = (col.answered / maxVal) * chartHeight;

                // --- A. Batang Hijau (Benar) ---
                ctx.fillStyle = '#22c55e'; // Green 500
                const yCorrect = padding.top + chartHeight - hCorrect;
                // Geser sedikit ke kiri (-8px) agar berdampingan
                ctx.fillRect(xCenter - 8, yCorrect, 8, hCorrect);

                // --- B. Batang Merah (Salah) ---
                ctx.fillStyle = '#ef4444'; // Red 500
                const yWrong = padding.top + chartHeight - hWrong;
                // Geser sedikit ke kanan
                ctx.fillRect(xCenter, yWrong, 8, hWrong);

                // --- C. Simpan Titik untuk Garis Biru (Total) ---
                const yTotal = padding.top + chartHeight - hTotal;
                linePoints.push({ x: xCenter, y: yTotal });

                // --- D. Label Kolom (K1, K2...) ---
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`K${i+1}`, xCenter, height - 15);
            });

            // 7. Gambar Garis Biru (Total Answered)
            if (linePoints.length > 0) {
                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6'; // Blue 500
                ctx.lineWidth = 2;
                ctx.moveTo(linePoints[0].x, linePoints[0].y);
                for (let i = 1; i < linePoints.length; i++) {
                    ctx.lineTo(linePoints[i].x, linePoints[i].y);
                }
                ctx.stroke();

                // Gambar Titik (Dot) pada garis
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                linePoints.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
            }

            // 8. Legenda (Keterangan Warna)
            const legendY = 20;
            ctx.font = '10px Arial';
            ctx.textAlign = 'left';
            
            // Hijau
            ctx.fillStyle = '#22c55e'; ctx.fillRect(padding.left, legendY, 10, 10);
            ctx.fillStyle = '#000'; ctx.fillText('Benar', padding.left + 15, legendY + 8);
            
            // Merah
            ctx.fillStyle = '#ef4444'; ctx.fillRect(padding.left + 60, legendY, 10, 10);
            ctx.fillStyle = '#000'; ctx.fillText('Salah', padding.left + 75, legendY + 8);

            // Biru
            ctx.beginPath(); ctx.strokeStyle='#3b82f6'; ctx.lineWidth=2; 
            ctx.moveTo(padding.left + 120, legendY+5); ctx.lineTo(padding.left + 130, legendY+5); ctx.stroke();
            ctx.fillStyle = '#000'; ctx.fillText('Total', padding.left + 135, legendY + 8);

            return canvas.toDataURL('image/png');
        };
        // 2. Generator Excel (SheetJS)
        // GANTI FUNGSI generateExcelSheet YANG LAMA DENGAN INI:

        const generateExcelSheet = (resultHeader, subsData) => {
            const wb = XLSX.utils.book_new();

            // 1. SHEET RINGKASAN (Cover)
            const summaryData = [
                ["LAPORAN HASIL UJIAN"],
                ["Nama Peserta", selectedExportUser.value.username],
                ["Modul", resultHeader.moduleName],
                ["Waktu Selesai", formatDateTime(resultHeader.endTime)],
                ["Total Skor Akhir", calculateTotalScore(resultHeader)],
                [],
                ["RINGKASAN NILAI PER SUBTES"],
                ["No", "Nama Subtes", "Tipe", "Skor"]
            ];

            subsData.forEach((sub, idx) => {
                summaryData.push([idx+1, sub.subName, sub.type === 'missing_numbers' ? 'Kecermatan' : 'Standar', sub.score]);
            });

            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Ringkasan");

            // 2. LOOP SETIAP SUBTES UNTUK DETAIL
            subsData.forEach((subRes, idx) => {
                const realSub = subTests.value.find(s => s.id === subRes.subId);
                const sheetName = `Sub ${idx+1}`; // Nama sheet max 31 char
                const rows = [];

                rows.push(["DETAIL SUBTES", subRes.subName]);
                rows.push(["Skor", subRes.score]);
                rows.push([]);

                // === LOGIKA KECERMATAN (EXCEL) ===
                if (realSub && realSub.navType === 'missing_numbers') {
                    const details = subRes.detail || [];
                    
                    // Header Tabel Kecermatan
                    rows.push(["Statistik Per Kolom (Grafik Data)"]);
                    rows.push(["Kolom Ke", "Jumlah Benar", "Jumlah Salah", "Total Diisi", "Akurasi (%)", "Status"]);

                    details.forEach((col, cIdx) => {
                        const acc = col.answered > 0 ? (col.correct/col.answered)*100 : 0;
                        let status = "Kurang";
                        if(acc >= 90) status = "Sangat Baik";
                        else if(acc >= 70) status = "Baik";
                        else if(acc >= 50) status = "Cukup";

                        rows.push([
                            `Kolom ${cIdx+1}`,
                            col.correct,
                            col.wrong,
                            col.answered,
                            acc.toFixed(1) + "%",
                            status
                        ]);
                    });

                    // Tambahan Total
                    const totalCorrect = details.reduce((a,b)=>a+b.correct,0);
                    const totalWrong = details.reduce((a,b)=>a+b.wrong,0);
                    rows.push([]);
                    rows.push(["TOTAL KESELURUHAN", totalCorrect, totalWrong, totalCorrect+totalWrong]);

                // === LOGIKA NORMAL (EXCEL) ===
                } else if (realSub) {
                    const sourceQuestions = (realSub.selectedQuestions && realSub.selectedQuestions.length > 0) ? realSub.selectedQuestions : (realSub.questions || []);
                    
                    rows.push(["No", "Soal", "Jawaban User", "Kunci Jawaban", "Status", "Pembahasan"]);

                    sourceQuestions.forEach((q, qIdx) => {
                        const cleanText = (html) => html ? html.replace(/<[^>]+>/g, ' ').trim() : '';
                        
                        const rawAns = subRes.userAnswers ? subRes.userAnswers[q.id] : null;
                        const userAnsIds = Array.isArray(rawAns) ? rawAns : (rawAns ? [rawAns] : []);
                        
                        const userAnsLabels = q.options.filter(o => userAnsIds.includes(o.id)).map(o => String.fromCharCode(65 + q.options.indexOf(o))).join(", ");
                        const keyLabels = q.options.filter(o => o.isCorrect).map(o => String.fromCharCode(65 + q.options.indexOf(o))).join(", ");
                        
                        const correctOptIds = q.options.filter(o => o.isCorrect).map(o => o.id);
                        const isCorrect = userAnsIds.length > 0 && 
                                        userAnsIds.length === correctOptIds.length && 
                                        userAnsIds.every(id => correctOptIds.includes(id));

                        rows.push([
                            qIdx + 1,
                            cleanText(q.text).substring(0, 150),
                            userAnsLabels || '-',
                            keyLabels,
                            isCorrect ? "BENAR" : "SALAH",
                            cleanText(q.explanation).substring(0, 200)
                        ]);
                    });
                }

                const ws = XLSX.utils.aoa_to_sheet(rows);
                // Atur lebar kolom agar rapi (Kolom A-F)
                ws['!cols'] = [{wch:15}, {wch:40}, {wch:15}, {wch:15}, {wch:15}, {wch:30}];
                
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            XLSX.writeFile(wb, `Hasil_${selectedExportUser.value.username}.xlsx`);
        };

        // Tambahkan ini di deretan ref/variable
        const editingQSourceGroupIdx = ref(-2); // -2 artinya tidak ada, -1 Default, >=0 index group
                // --- EXPORT STATE ---
        const showExportModal = ref(false);
        const selectedExportResult = ref(null);
        const selectedExportUser = ref(null); // Helper untuk nama user
        const exportFormat = ref('word');
        const exportScope = ref('full');
        const exportSelectedSubId = ref('');
        // ==========================================
        // 7. FITUR KEAMANAN (SECURITY & ANTI-CHEAT)
        // ==========================================
        
        // A. Listener Kemanan Umum (No Right Click, No Inspect, No Copy)
        const attachGeneralSecurity = () => {
            // 1. Disable Klik Kanan
            document.addEventListener('contextmenu', event => {
                if (currentRole.value === 'peserta') {
                    event.preventDefault();
                    return false;
                }
            });

            // 2. Disable Keyboard Shortcuts (Inspect, Copy, PrintScreen)
            document.addEventListener('keydown', event => {
                if (currentRole.value !== 'peserta') return;

                // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U (View Source)
                if (event.key === 'F12' || 
                    (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'J')) || 
                    (event.ctrlKey && event.key === 'u')) {
                    event.preventDefault();
                    return false;
                }

                // Block Copy/Paste/Cut via Keyboard
                if (event.ctrlKey && (event.key === 'c' || event.key === 'v' || event.key === 'x')) {
                    event.preventDefault();
                    return false;
                }

                // Deteksi PrintScreen (Best Effort)
                if (event.key === 'PrintScreen') {
                    navigator.clipboard.writeText(''); // Kosongkan clipboard
                    alert("Tangkapan layar tidak diperbolehkan!");
                    event.preventDefault(); 
                }
            });

            // 3. Disable Event Copy/Cut/Paste
            ['copy', 'cut', 'paste'].forEach(evt => {
                document.addEventListener(evt, e => {
                    if (currentRole.value === 'peserta') e.preventDefault();
                });
            });
        };

        // B. Logika Force Finish (Jika User Klik Keluar Window)
        const forceFinishExam = () => {
            clearInterval(timerInterval);

            let currentScore = 0;
            let detailData = null;
            let groupBreakdown = [];
            
            const allQuestions = activeExam.currentSub.navType === 'missing_numbers' ? (activeExam.currentSub.selectedQuestions || []) : activeExam.questions;
            
            if (activeExam.currentSub.navType === 'missing_numbers') {
                 recordColumnResult(); 
                 const rawScore = activeExam.colResults.reduce((a,b) => a + (b.correct || 0), 0);
                 currentScore = allQuestions.length > 0 ? (rawScore / allQuestions.length) * 100 : 0;
                 detailData = [...activeExam.colResults];
            } else {
                 let totalPoints = 0; let normalCorrectCount = 0;
                 allQuestions.forEach(q => {
                    let rawAns = activeExam.answers[q.id];
                    const userAnsList = Array.isArray(rawAns) ? rawAns : (rawAns ? [rawAns] : []);
                    if (activeExam.currentSub.type === 'normal') {
                        const correctOptionIds = q.options.filter(o => o.isCorrect).map(o => o.id);
                        const isAllCorrect = userAnsList.length === correctOptionIds.length && userAnsList.every(val => correctOptionIds.includes(val));
                        if (isAllCorrect) normalCorrectCount++;
                    } else if (activeExam.currentSub.type === 'weighted') {
                         userAnsList.forEach(ansId => { const opt = q.options.find(o => o.id === ansId); if(opt) totalPoints += (opt.weight || 0); });
                    }
                 });
                 if (activeExam.currentSub.type === 'normal') {
                     currentScore = allQuestions.length > 0 ? (normalCorrectCount / allQuestions.length) * 100 : 0;
                 } else {
                     currentScore = totalPoints;
                 }
            }

            activeExam.resultsBuffer.push({
                subId: activeExam.currentSub.id, subName: activeExam.currentSub.nameDisplay, subNameInternal: activeExam.currentSub.nameInternal,
                score: parseFloat(currentScore) || 0, type: activeExam.currentSub.navType, subType: activeExam.currentSub.type,
                detail: detailData, groupBreakdown: groupBreakdown, userAnswers: JSON.parse(JSON.stringify(activeExam.answers)), userFlags: JSON.parse(JSON.stringify(activeExam.flags || {}))
            });

            const remainingSubIds = activeExam.subIds.slice(activeExam.currentSubIndex + 1);
            remainingSubIds.forEach(remId => {
                const remSub = subTests.value.find(s => s.id === remId);
                if(remSub) {
                    activeExam.resultsBuffer.push({
                        subId: remSub.id, subName: remSub.nameDisplay, subNameInternal: remSub.nameInternal,
                        score: 0, type: remSub.navType, subType: remSub.type, detail: [], groupBreakdown: [], userAnswers: {}, userFlags: {}
                    });
                }
            });

            // --- BAGIAN PENTING: TANDAI SEBAGAI PELANGGARAN ---
            // Kita tambahkan string " [VIOLATION]" ke nama modul agar tersimpan di DB
            // --- BAGIAN PENTING: TANDAI SEBAGAI PELANGGARAN BERAT ---
            const violationTag = " [VIOLATION]"; // Tetap pakai tag Violation
            
            const res = {
                id: generateId(),
                participantId: currentUser.value.id,
                participantName: currentUser.value.username,
                moduleName: activeExam.moduleName + violationTag, 
                packageId: activeExam.packageId,
                endTime: Date.now(),
                subResults: activeExam.resultsBuffer
            };

            results.value.push(res);
            finishedResult.value = res;
            
            secureFetch('/api/user/submit_exam', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('ujian_token') },
                body: JSON.stringify({ result: res })
            }).then(d => console.log("Force Save:", d.status)).catch(e => console.error(e));

            examState.value = 'finished';

            // Notifikasi Pojok Kanan Bawah
            Swal.fire({
                icon: 'warning',
                title: 'PELANGGARAN!',
                text: 'Sistem mendeteksi aktivitas mencurigakan. Ujian dihentikan otomatis.',
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true,
                background: '#fff',
                iconColor: '#ef4444'
            });
        };
        // C. Watcher untuk Mengaktifkan/Mematikan Keamanan
        
        // 1. Watch Login untuk keamanan umum
        Vue.watch(isLoggedIn, (val) => {
            if(val) {
                attachGeneralSecurity();
                // Tambahkan class CSS ke body
                if(currentRole.value === 'peserta') document.body.classList.add('user-secure');
            } else {
                document.body.classList.remove('user-secure');
            }
        });

        // 2. Watch ExamState untuk keamanan ketat (Window Blur)
        // 2. Watch ExamState untuk keamanan (SISTEM 3 NYAWA)
        const handleWindowBlur = () => {
            // Hanya aktif jika role Peserta DAN ujian sedang 'running' DAN tidak sedang membuka modal hasil
            if (currentRole.value === 'peserta' && examState.value === 'running' && !showResultModal.value) {
                
                // Tambah Counter
                activeExam.violationCount++;
                const sisaNyawa = 3 - activeExam.violationCount;

                if (activeExam.violationCount >= 3) {
                    // JIKA SUDAH 3 KALI -> TENDANG (Force Finish)
                    forceFinishExam();
                } else {
                    // JIKA BARU 1 atau 2 KALI -> PERINGATAN SAJA (Toast Kuning)
                    Swal.fire({
                        icon: 'warning',
                        title: `PERINGATAN PELANGGARAN (${activeExam.violationCount}/3)`,
                        text: `Anda terdeteksi keluar dari layar ujian. Sisa kesempatan: ${sisaNyawa} kali lagi sebelum ujian dihentikan otomatis!`,
                        toast: true,
                        position: 'center', // Tengah biar sadar
                        showConfirmButton: true,
                        confirmButtonText: 'Saya Mengerti',
                        timer: 5000,
                        timerProgressBar: true,
                        background: '#fff',
                        iconColor: '#f59e0b' // Kuning
                    });
                }
            }
        };

        Vue.watch(examState, (val) => {
            if (val === 'running' && currentRole.value === 'peserta') {
                window.addEventListener('blur', handleWindowBlur);
            } else {
                window.removeEventListener('blur', handleWindowBlur);
            }
        });

        // Jalankan saat mounted jika sudah login (untuk refresh page)
        onMounted(() => {
            if(isLoggedIn.value) attachGeneralSecurity();
        });
        // --- HELPER PELANGGARAN ---
        const checkViolation = (name) => name && name.includes('[VIOLATION]');        
        const getCleanModuleNameForDisplay = (name) => {
            if(!name) return '';
            return name
                .replace(' [VIOLATION]', '')
                .replace(/ \[WARN:\d+\]/, '')
                .replace(' [LULUS]', '')
                .replace(' [TIDAK LULUS]', '');
        };
        const checkWarning = (name) => {
            if (!name) return 0;
            const match = name.match(/\[WARN:(\d+)\]/);
            return match ? parseInt(match[1]) : 0;
        };
        const calculateTotalWeight = () => {
            return newModule.subIds.reduce((sum, sid) => sum + (newModule.subWeights[sid] || 0), 0);
        };
        // Jangan lupa return calculateTotalWeight di akhir setup()
        return {
            isLoggedIn, currentUser, currentRole, accounts, loginForm, handleLogin, handleLogout,
            adminTab, groups, subTests, modules, results, examPackages, userGroups,
            newGroup, editingGroupId, handleGroupSave, editGroupBtn, cancelEditGroup, selectGroup, deleteGroup, selectedGroup, newQuestion, updateContent, saveQuestion, uploadImageToEditor, handleWordUpload, addOption, removeOption, editQuestion, cancelEdit, deleteQuestion,
            isEditing, isEditingSub, saveSubTest, editSub, cancelEditSub, deleteSub, filteredGroups, toggleGroupExpand, isQuestionSelected, toggleQuestionSelection, expandedGroupId,
            newSub, activeMissingCol, tempMissingInputs, getCurrentColInputs, genCount, generateMissingQuestions, getMissingQuestionCount, getQuestionsForCol, clearMissingCol,
            examState, pesertaTab, availableExams, activeExam, timer, formatTime, startExam, selectAnswer, isSelected, nextQuestion, prevQuestion, finishSubTest, finishedResult, calculateTotalScore, myResults, formatDateTime, viewResultDetail, showResultModal, selectedResult,
            isEditingModule, newModule, addToModule, removeFromModule, saveModule, getSubName, newPackage, savePackage, deletePackage, getGroupName, createGroupUser, deleteGroupUser, newUserGroup, saveAccount, deleteAccount, newAccount,
            getModuleName, editModule, cancelEditModule, deleteModule, editPackage, cancelEditPackage, removeUserFromPackageForm, isEditingPackage, isEditingAccount, cancelEditAccount, editAccount, filteredResults, filterDate,
            resetResultData, getSubInternalName, getParticipantName,
            tempGroupName, activeInternalGroupIdx, addSubGroup, removeSubGroup,
            isEditingQ, editingQIdx, tempOptions, tempQContent,
            updateQ, updateOpt, resetQEditor, addQuestionToSub, editQInSub, deleteQInSub,
            currentViewQuestions, countTotalSoal, triggerUpload, execCmd, handleEditorClick, activeImg, setImageSize, setImageAlign,currentMissingQuestions,
            deleteMissing,generateMissingQuestions,checkWarning,
            tempExplanation, updateExp, setCorrectOption, 
            handleExcelUpload, handleWordUpload, showExportModal, selectedExportResult, selectedExportUser, exportFormat, exportScope, exportSelectedSubId,
            createChartImage, // <--- Masukkan ini
            openExportModal, 
            processExport,checkViolation, 
            getCleanModuleNameForDisplay,
            // FUNGSI BARU
            openExportModal, processExport,
            // Reviewer Logic
            reviewTab, reviewState, resetReviewState, reviewFilterGroup, reviewSearch, reviewSort,
            filteredReviewResults, filteredUsersForReview, selectedReviewUser, openUserDetail, userExamHistory,
            getParticipantGroup, calculateDuration, getCorrectCount, getWrongCount,
            startFullReview, selectedReviewResult, reviewSubIndex, reviewTotalSubs, reviewQuestions, reviewQuestionIndex, 
            reviewCurrentSub, currentReviewQ, currentReviewSubResult,
            nextReviewSub, prevReviewSub, getCurrentSubScore, getReviewNavClass, getReviewOptionClass, getQuestionScore,checkQuestionKey,

            // Peserta Logic (WAJIB ADA)
            jumpToQuestion, 
            getPesertaNavClass,
            toggleFlag, calculateTotalWeight
        };
    }
});
app.mount('#app');
</script>
</body>
</html>